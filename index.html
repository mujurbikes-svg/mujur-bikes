<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MUJUR BIKES v8.0 - Enhanced System</title>
<!-- Manifest untuk PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2563eb"/>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="MUJUR BIKES">
<link rel="apple-touch-icon" href="icons/icon-192x192.png">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

<!-- QR Code Library -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

<style>
  :root{
    --bg:#f6f8fb; --card:#ffffff; --ink:#0f172a;
    --muted:#475569; --line:#e5e7eb; --pri:#2563eb; --pri-ink:#fff;
    --amber:#f59e0b; --red:#ef4444; --green:#16a34a;
    --soft-yellow:#fff8db; --soft-red:#ffe6e6;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:28px;background:var(--bg);color:var(--ink);font-family:Arial,Helvetica,sans-serif}
  .container{max-width:1200px;margin:0 auto;padding:0 16px;}
  h1{font-size:32px;font-weight:900;text-align:center;margin:24px 0 6px;}
  .ver{font-size:14px;color:#64748b;text-align:center;margin-bottom:26px}
  h2{font-size:20px;margin:0;font-weight:700;}
  h3{font-size:18px;margin:0 0 12px 0;font-weight:600;}
  .tabs{display:flex;gap:4px;justify-content:center;margin:6px 0 20px;flex-wrap:wrap;background:#f1f5f9;padding:8px;border-radius:12px;}
  .tab{padding:10px 16px;border:0;border-radius:8px;background:#e5e7eb;font-weight:600;cursor:pointer;min-width:110px;text-align:center;font-size:13px;transition:all 0.2s ease;flex:1;}
  .tab.active{background:var(--pri);color:var(--pri-ink);box-shadow:0 2px 4px rgba(0,0,0,0.1);}
  .section{background:var(--card);border-radius:18px;box-shadow:0 2px 12px rgba(0,0,0,.06);padding:16px}
  .section+.section{margin-top:16px}
  .headerRow{display:flex;align-items:center;justify-content:space-between;margin:4px 6px 14px}
  .actions{display:flex;gap:10px;flex-wrap:wrap}
  .toolbar{display:flex;gap:12px;flex-wrap:wrap;margin:0 6px 14px}
  .grow{flex:1 1 320px}
  .input,select,textarea{border:1px solid var(--line);border-radius:12px;padding:10px 12px;background:#fff}
  .btn{border:0;border-radius:12px;padding:10px 14px;background:var(--pri);color:var(--pri-ink);cursor:pointer}
  .btn.ghost{background:#e7eaf1;color:#111}
  .btn.red{background:var(--red)}
  .btn.green{background:var(--green)}
  .btn.amber{background:var(--amber)}
  .btn.small{padding:6px 10px;border-radius:10px}
  .badge{display:inline-block;background:#eef2ff;color:#3730a3;padding:3px 8px;border-radius:999px;font-size:12px}
  .reminder{background:#fff7d6;border:1px solid #fde68a;padding:10px;border-radius:12px;margin:8px 6px}
  .list{display:grid;gap:14px}
  .item{display:grid;grid-template-columns:80px 1fr auto;gap:12px;align-items:center;background:#fff;border:1px solid var(--line);border-radius:16px;padding:12px;cursor:pointer}
  .item:hover{background:#f9fafb}
  .item.low{background:var(--soft-yellow)}
  .item.zero{background:var(--soft-red)}
  .thumb{width:80px;height:80px;background:#f1f5f9;border-radius:12px;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .thumb img{width:100%;height:100%;object-fit:cover}
  .name{font-size:16px;font-weight:900;margin:0 0 6px}
  .sub{color:#334155;margin:0 0 6px}
  .meta{color:#64748b;font-size:12px}
  .checkwrap{display:flex;align-items:center;gap:8px}
  .hidden{display:none!important}
  .menu{position:relative}
  .menu-panel{position:absolute;right:0;top:110%;background:#fff;border:1px solid var(--line);border-radius:14px;padding:8px;box-shadow:0 8px 18px rgba(0,0,0,.12);display:none;z-index:20;min-width:240px}
  .menu.open .menu-panel{display:block}
  .menu-panel .btn{width:100%;text-align:left;background:#f3f4f6;color:#111}
  .menu-panel .btn:hover{background:#e5e7eb}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:16px;z-index:100}
  .modal.show{display:flex}
  .box{background:#fff;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.18);padding:16px;max-width:860px;width:96vw;max-height:92vh;overflow:auto;position:relative}
  /* box Detail 80% */
  #detailModal .box{max-width:760px;width:80vw}
  .closeX{position:absolute;right:12px;top:10px;font-size:20px;border:0;background:transparent;cursor:pointer;z-index:5}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .mt8{margin-top:10px}.mt12{margin-top:14px}.mt16{margin-top:18px}
  .small{font-size:12px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .detail-img{width:320px;height:320px;background:#f1f5f9;border-radius:14px;margin:0 auto 12px;overflow:hidden;display:flex;align-items:center;justify-content:center;position:relative;z-index:1}
  .detail-img img{max-width:100%;max-height:100%;object-fit:contain;cursor:zoom-in}
  .detail-title{font-size:24px;font-weight:900;margin:6px 0 2px}
  .detail-sub{font-size:16px;font-weight:700;color:#334155;margin:0 0 6px}
  .detail-stock{font-size:16px;font-weight:700;margin:0 0 10px}
  .table{width:100%;border-collapse:separate;border-spacing:0 8px;margin-top:8px}
  .table th,.table td{background:#fff;border:1px solid var(--line);padding:10px;border-radius:10px}
  .table th{background:#f8fafc}
  .chip{display:inline-flex;gap:6px;align-items:center;background:#eef2ff;color:#3730a3;padding:6px 10px;border-radius:999px;margin:4px 6px 0 0;font-size:13px}
  .chip .x{background:var(--red);border:0;color:#fff;border-radius:999px;padding:0 6px;cursor:pointer}
  .readLine{margin:6px 0}
  .ac-wrap{position:relative}
  .ac-list{position:absolute;left:0;right:0;top:100%;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 6px 16px rgba(0,0,0,.1);max-height:220px;overflow:auto;display:none;z-index:30}
  .ac-item{padding:8px 12px;cursor:pointer}.ac-item:hover{background:#f3f4f6}
  #zoomBox{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;z-index:80}
  #zoomBox img{max-width:86vw;max-height:86vh;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.4);cursor:zoom-out}
  /* Modal kecil NA */
  #naModal .box{max-width:420px;width:90vw}
  /* Notification */
  #toast{position:fixed;right:18px;top:18px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;z-index:120;display:none;box-shadow:0 8px 18px rgba(0,0,0,.2)}
  /* Password modal */
  #passModal .box{max-width:380px;width:90vw}
  .err{color:#ef4444;font-size:12px;margin-top:6px}
  
  /* Pagination */
  .pagination{display:flex;justify-content:center;align-items:center;gap:12px;margin:20px 0;flex-wrap:wrap}
  .pagination button{border:1px solid var(--line);background:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}
  .pagination button:disabled{background:#f3f4f6;color:#9ca3af;cursor:not-allowed}
  .pagination button.active{background:var(--pri);color:var(--pri-ink);border-color:var(--pri)}
  .pagination-info{color:var(--muted);font-size:14px}
  .page-size{display:flex;align-items:center;gap:8px;margin-left:auto}
  .page-size select{border:1px solid var(--line);border-radius:6px;padding:4px 8px;background:#fff}

  /* Date Range Filter */
  .date-range{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:14px}
  .date-range select,.date-range input{border:1px solid var(--line);border-radius:8px;padding:6px 10px;background:#fff}

  /* Dashboard */
  .dashboard {display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;}
  .dashboard-card {background: var(--card); border-radius: 14px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,.05); text-align: center;}
  .dashboard-value {font-size: 32px; font-weight: 900; margin: 8px 0;}
  .dashboard-label {font-size: 14px; color: var(--muted);}

  /* PWA Install Button */
  #installBtn {position: fixed; bottom: 20px; right: 20px; background: var(--pri); color: white; border: none; border-radius: 50px; padding: 12px 20px; box-shadow: 0 4px 12px rgba(0,0,0,.2); z-index: 100; display: none; cursor: pointer;}

  /* ===== Fitur Baru ===== */
  
  /* Version di kiri atas */
  .version-top {position: absolute; top: 10px; left: 10px; font-size: 12px; color: #64748b;}
  
  /* Password visibility toggle */
  .password-container {position: relative;}
  .password-toggle {position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 12px; color: var(--pri);}
  
  /* Scrollable containers */
  .scrollable-container {max-height: 400px; overflow-y: auto; border: 1px solid var(--line); border-radius: 12px; padding: 12px;}
  
  /* Success Modal */
  #successModal .box {max-width: 420px; width: 90vw; text-align: center;}
  
  /* Report Section */
  .report-options {display: none; margin-top: 16px;}
  .report-options.show {display: block;}
  .report-type {display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; margin: 16px 0;}
  .report-type button {padding: 12px; border: 1px solid var(--line); border-radius: 12px; background: #f8fafc; cursor: pointer; text-align: center;}
  .report-type button:hover {background: #e5e7eb;}
  
  /* Refresh button */
  .refresh-btn {background: var(--green); margin-left: auto;}
  
  /* Notification Styles */
  .notification-item {
    border-left: 3px solid;
    padding-left: 10px;
    margin-bottom: 12px;
    padding: 8px;
    border-radius: 8px;
  }

  .notification-item[data-type="critical"] {
    border-left-color: var(--red);
    background: #fee2e2;
  }

  .notification-item[data-type="warning"] {
    border-left-color: var(--amber);
    background: #fef3c7;
  }

  .notification-item[data-type="info"] {
    border-left-color: var(--pri);
    background: #e0f2fe;
  }

  /* User Menu Styles */
  #userInfo {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 10;
  }

  /* Login Modal */
  #loginModal .box {
    max-width: 400px;
    width: 90vw;
  }

  /* Chart Styles */
  .chart-container {
    background: var(--card);
    border-radius: 14px;
    padding: 16px;
    margin: 16px 0;
    box-shadow: 0 2px 8px rgba(0,0,0,.05);
  }
  
  .chart-row {
    display: flex;
    align-items: center;
    margin: 8px 0;
    gap: 12px;
  }
  
  .chart-label {
    min-width: 120px;
    font-size: 14px;
  }
  
  .chart-bar {
    height: 24px;
    background: var(--pri);
    border-radius: 12px;
    transition: width 0.5s ease;
    min-width: 40px;
    text-align: right;
    padding-right: 8px;
    color: white;
    font-size: 12px;
    line-height: 24px;
  }
  
  .chart-value {
    min-width: 60px;
    text-align: right;
    font-weight: bold;
  }

  /* Custom Report Builder */
  .custom-report-builder {
    background: var(--card);
    border-radius: 14px;
    padding: 16px;
    margin: 16px 0;
  }
  
  .column-selector {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 8px;
    margin: 12px 0;
  }
  
  .filter-conditions {
    margin: 16px 0;
  }
  
  .filter-row {
    display: flex;
    gap: 8px;
    margin: 8px 0;
    align-items: center;
    flex-wrap: wrap;
  }
  
  /* Auto Backup Status */
  .backup-status {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
    font-size: 12px;
    color: var(--muted);
  }
  
  .backup-status.online::before {
    content: "●";
    color: var(--green);
  }
  
  .backup-status.offline::before {
    content: "●";
    color: var(--red);
  }

  /* Real-time Indicators */
  .real-time-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--green);
    margin-right: 6px;
    animation: pulse 2s infinite;
  }
  
  @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
  }
  
  /* Report Table Container */
  .report-table-container {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid var(--line);
    border-radius: 12px;
    margin-top: 12px;
  }

  /* Logo Styles */
  .header-with-logo {
    text-align: center;
    margin: 20px 0 10px;
  }

  .site-logo {
    max-height: 80px;
    max-width: 100%;
    object-fit: contain;
  }

  /* QR Code Styles */
  .qr-product-info {
    text-align: center;
    margin-top: 15px;
    font-size: 14px;
  }

  .qr-product-name {
    font-weight: bold;
    margin-bottom: 5px;
  }

  .qr-product-details {
    color: #64748b;
    font-size: 12px;
  }
/* QR Code Container */
#qrCodeContainer {
  text-align: center;
  padding: 20px;
  min-height: 300px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

/* Camera Container Fallback */
.camera-fallback-container {
  color: white;
  text-align: center;
  padding: 50px 20px;
  background: #333;
  border-radius: 12px;
  height: 100%;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

/* Scanner Container */
.scanner-fallback-container {
  text-align: center;
  padding: 40px 20px;
  background: #f8f9fa;
  border-radius: 12px;
  height: 100%;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

/* Success States */
.scanner-success {
  text-align: center;
  padding: 30px 20px;
  background: #d4edda;
  border-radius: 12px;
  height: 100%;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}
  /* Camera Styles */
  .camera-controls {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-top: 15px;
  }

  .camera-preview {
    width: 100%;
    height: 400px;
    background: #000;
    border-radius: 12px;
    overflow: hidden;
    position: relative;
  }
.camera-fallback {
  text-align: center;
  padding: 40px 20px;
  color: white;
}

.camera-fallback-icon {
  font-size: 48px;
  margin-bottom: 20px;
}
  /* QR Code Container */
#qrCodeContainer {
  text-align: center;
  padding: 20px;
  min-height: 300px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

/* Camera Container Fallback */
.camera-fallback-container {
  color: white;
  text-align: center;
  padding: 50px 20px;
  background: #333;
  border-radius: 12px;
  height: 100%;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

/* Scanner Container */
.scanner-fallback-container {
  text-align: center;
  padding: 40px 20px;
  background: #f8f9fa;
  border-radius: 12px;
  height: 100%;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

/* Success States */
.scanner-success {
  text-align: center;
  padding: 30px 20px;
  background: #d4edda;
  border-radius: 12px;
  height: 100%;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}
  /* Print Styles for QR Code */
  @media print {
    body * {
      visibility: hidden;
    }
    #qrCodeContainer, #qrCodeContainer * {
      visibility: visible;
    }
    #qrCodeContainer {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      padding: 10mm;
    }
  }
  
  /* Untuk desktop, batasi lebar maksimal tab */
  @media (min-width: 768px) {
    .tab {
        min-width: 110px;
        max-width: 140px;
        flex: 0 1 auto;
    }
    
    .grid2 {
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }
    
    .toolbar {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: nowrap;
    }
    
    .grow {
        flex: 1;
        min-width: 200px;
    }
  }

  /* Mobile Optimizations */
  @media (max-width: 767px) {
    body {
      margin: 16px;
    }
    
    .container {
      padding: 0 8px;
    }
    
    .tabs {
      padding: 4px;
    }
    
    .tab {
      min-width: 80px;
      font-size: 12px;
      padding: 8px 12px;
    }
    
    .headerRow {
      flex-direction: column;
      align-items: flex-start;
      gap: 12px;
    }
    
    .actions {
      width: 100%;
      justify-content: space-between;
    }
    
    .toolbar {
      flex-direction: row;
      flex-wrap: nowrap;
      gap: 6px;
      align-items: center;
    }
    
    .grid2 {
      grid-template-columns: 1fr;
    }
    
    .dashboard {
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    }
    
    .dashboard-value {
      font-size: 24px;
    }
    
    .item {
      grid-template-columns: 60px 1fr;
      gap: 8px;
    }
    
    .thumb {
      width: 60px;
      height: 60px;
    }
    
    .detail-img {
      width: 100%;
      height: 250px;
    }
    
    /* Perbaikan search box dan toolbar untuk mobile */
    #searchBox {
      padding: 8px 10px;
      font-size: 14px;
      min-height: 40px;
      height: 40px;
    }
    
    .toolbar .grow {
      flex: 1;
      min-width: 120px;
    }
    
    #sortKey, #sortDir {
      min-height: 40px;
      height: 40px;
      font-size: 12px;
      padding: 8px;
    }
    
    #sortKey {
      width: 100px;
    }
    
    #sortDir {
      width: 40px;
      min-width: 40px;
    }
    
    .toolbar > * {
      flex-shrink: 0;
    }
    
    /* Perbaikan posisi judul di mobile */
    h1 {
      margin-top: 50px;
      font-size: 28px;
    }
    
    .version-top {
      top: 60px;
      left: 16px;
    }
    
    #userInfo {
      top: 10px;
      right: 16px;
      z-index: 10;
    }
    
    .container {
      position: relative;
    }
    
    .site-logo {
      max-height: 60px;
    }
    
    .header-with-logo {
      margin-top: 40px;
    }
    
    /* Touch-friendly buttons for mobile */
    .btn {
      min-height: 44px;
      min-width: 44px;
    }
    
    .tab {
      min-height: 44px;
    }
    
    .input, select, textarea {
      min-height: 44px;
      font-size: 16px; /* Prevent zoom on iOS */
    }
  }
</style>
</head>
<body>
<!-- Login Modal -->
<div class="modal" id="loginModal">
  <div class="box" onclick="event.stopPropagation()">
    <button class="closeX" onclick="closeLogin()">✕</button>
    <h3>Login Sistem MUJUR BIKES</h3>
    
    <div class="mt8">
      <label>Username</label>
      <input id="loginUsername" class="input" placeholder="Masukkan username">
    </div>
    
    <div class="mt8">
      <label>Password</label>
      <div class="password-container">
        <input id="loginPassword" type="password" class="input" placeholder="Masukkan password">
        <button class="password-toggle" type="button" onclick="toggleLoginPassword()">show</button>
      </div>
    </div>
    
    <div id="loginErr" class="err hidden">Username atau password salah.</div>
    
    <div class="row mt16">
      <button class="btn" onclick="doLogin()">Login</button>
      <button class="btn ghost" onclick="closeLogin()">Batal</button>
    </div>
    
    <!-- Demo Accounts disembunyikan -->
    <div class="mt12 small" style="border-top: 1px solid var(--line); padding-top: 12px; display: none;">
      <strong>Demo Accounts:</strong><br>
      Admin: admin / admin123<br>
      Staff: staff / staff123
    </div>
  </div>
</div>

<div class="container">
  <div class="version-top">Versi 8.0 - Enhanced System</div>
  
  <!-- Ganti judul dengan logo -->
  <div class="header-with-logo">
    <img src="logo.png" alt="MUJUR BIKES" class="site-logo" onerror="this.style.display='none'; document.querySelector('.logo-fallback').style.display='block'">
    <h1 class="logo-fallback" style="display:none">MUJUR BIKES</h1>
  </div>
  <div class="ver">Sistem Manajemen Inventori Sepeda</div>

  <!-- Notification Panel -->
  <div id="notificationPanel" class="section hidden" style="background: var(--soft-yellow); border-left: 4px solid var(--amber);">
    <div class="headerRow">
      <h3>Notifikasi Stok</h3>
      <button class="btn ghost small" onclick="closeNotifications()">Tutup</button>
    </div>
    <div id="notificationList"></div>
  </div>

  <div class="tabs" id="tabs">
    <button class="tab active" data-route="dashboard">Dashboard</button>
    <button class="tab" data-route="masuk">Belum Rakit</button>
    <button class="tab" data-route="dirakit">Sudah Rakit</button>
    <button class="tab" data-route="terjual">Terjual</button>
    <button class="tab" data-route="low">Stok Kurang</button>
    <button class="tab" data-route="master">Data Master</button>
    <button class="tab" data-route="laporan">Laporan</button>
  </div>

  <!-- ===== Dashboard Section ===== -->
  <div id="pageDashboard" class="section">
    <div class="headerRow">
      <h2>Dashboard <span class="real-time-indicator"></span></h2>
      <div>
        <button class="btn refresh-btn" onclick="refreshData()">Refresh</button>
        <button class="btn ghost small" onclick="toggleAutoRefresh()" id="autoRefreshBtn">Auto: ON</button>
      </div>
    </div>
    <div class="dashboard" id="dashboardCards">
      <!-- Dashboard cards will be populated by JavaScript -->
    </div>
    
    <!-- Real-time Charts -->
    <div id="dashboardCharts"></div>
    
    <!-- Auto Backup Status -->
    <div class="backup-status online" id="backupStatus">
      Auto Backup: Aktif - Backup otomatis setiap 5 menit
    </div>
  </div>

  <!-- ===== List Section ===== -->
  <div id="pageList" class="section hidden">
    <div class="headerRow">
      <h2 id="tabTitle">Belum Rakit</h2>
      <div class="actions">
        <button class="btn refresh-btn" onclick="refreshData()">Refresh</button>
        <button class="btn" id="btnScanQR" onclick="openQRScanner()">Scan QR</button>
        <button class="btn ghost" id="btnMulti">Pilih Multiple</button>
        <button class="btn amber hidden" id="btnMassEdit">Edit Massal</button>
        <button class="btn red hidden" id="btnMassDelete">Hapus Dipilih</button>
        <button class="btn ghost hidden" id="btnMassCancel">Batal</button>

        <button class="btn" id="btnExport">Ekspor CSV</button>
        <div class="menu" id="importMenu">
          <button class="btn ghost" id="btnImport">Impor CSV</button>
          <div class="menu-panel">
            <button class="btn" id="btnImportData">Impor Data Sepeda</button>
            <button class="btn" id="btnTpl">Download Template CSV</button>
          </div>
        </div>
      </div>
    </div>

    <div id="lowReminder" class="reminder hidden"></div>

    <div class="toolbar">
      <input id="searchBox" class="input grow" placeholder="Cari nama/tipe/ukuran/supplier/kode...">
      <select id="sortKey" class="input">
        <option value="name">Nama</option>
        <option value="arrivalDate">Tanggal Kedatangan</option>
        <option value="totalQty">Jumlah Stok</option>
        <option value="type">Tipe</option>
        <option value="size">Ukuran</option>
        <option value="supplier">Supplier</option>
        <option value="code">Kode/ID</option>
      </select>
      <button id="sortDir" class="btn ghost" title="Urutan">↑</button>

      <button id="btnAdd" class="btn">Tambah Item</button>
      <button id="btnAddAsm" class="btn ghost hidden">Tambah Sepeda Sudah Rakit</button>
      <button id="btnAddSell" class="btn ghost hidden">Tambah Penjualan</button>
    </div>

    <div id="list" class="list"></div>
    
    <!-- Pagination -->
    <div id="listPagination" class="pagination"></div>
  </div>

  <!-- ===== Master Section ===== -->
  <div id="pageMaster" class="section hidden">
    <div class="headerRow">
      <h2>Data Master</h2>
      <button class="btn refresh-btn" onclick="refreshData()">Refresh</button>
    </div>
    
    <div id="masterRead"></div>
    <div id="masterEdit" class="hidden"></div>
    <div class="row mt8" id="masterBar">
      <button class="btn" id="btnMasterEdit">Edit</button>
      <button class="btn hidden" id="btnMasterSave">Simpan Perubahan</button>
      <button class="btn ghost hidden" id="btnMasterCancel">Batal</button>
    </div>

    <!-- Backup & Restore Section -->
    <div class="section mt8">
      <div class="headerRow"><h2>Backup & Restore</h2><div></div></div>
      <div class="toolbar">
        <button class="btn green" id="backupBtn" onclick="backupData()">Backup Data</button>
        <button class="btn amber" id="restoreBtn" onclick="restoreData()">Restore Data</button>
        <button class="btn ghost" onclick="resetData()">Reset ke Data Demo</button>
      </div>
      <p class="small mt8">Backup: Simpan semua data ke file JSON. Restore: Muat data dari file JSON.</p>
    </div>
  </div>

  <!-- ===== Laporan Section ===== -->
  <div id="pageLaporan" class="section hidden">
    <div class="headerRow">
      <h2>Laporan</h2>
      <button class="btn refresh-btn" onclick="refreshData()">Refresh</button>
    </div>
    
    <button class="btn" id="btnPilihLaporan">Pilih Laporan</button>
    
    <div id="laporanOptions" class="report-options">
      <div class="date-range mt12">
        <label>Rentang Tanggal:</label>
        <input type="date" id="reportStartDate" class="input">
        <span>s/d</span>
        <input type="date" id="reportEndDate" class="input">
        <button class="btn ghost small" onclick="setReportDateRange('today')">Hari Ini</button>
        <button class="btn ghost small" onclick="setReportDateRange('week')">Minggu Ini</button>
        <button class="btn ghost small" onclick="setReportDateRange('month')">Bulan Ini</button>
      </div>
      
      <div class="report-type">
        <button onclick="generateReport('stok')">Laporan Stok</button>
        <button onclick="generateReport('pergerakan')">Laporan Pergerakan Stok</button>
        <button onclick="generateReport('penjualan')">Laporan Penjualan</button>
        <button onclick="generateReport('perakitan')">Laporan Perakitan</button>
        <button onclick="generateReport('prediksi')">Prediksi Stok</button>
        <button onclick="showCustomReportBuilder()">Laporan Custom</button>
      </div>
    </div>
    
    <div id="laporanResult" class="mt16"></div>
    
    <!-- Riwayat Section -->
    <div class="section mt16">
      <div class="headerRow">
        <h2>Riwayat</h2>
        <button class="btn refresh-btn" onclick="renderHistory()">Refresh</button>
      </div>
      
      <div class="toolbar">
        <select id="hisType" class="input" onchange="renderHistory()">
          <option value="all">Semua</option>
          <option value="unit-baru">Unit Baru</option>
          <option value="perubahan-status">Perubahan Status</option>
          <option value="edit">Edit</option>
          <option value="hapus">Hapus</option>
          <option value="impor">Impor</option>
        </select>
      </div>
      
      <div class="scrollable-container">
        <table class="table" id="hisTable">
          <thead>
            <tr>
              <th style="width:140px;text-align:right">Waktu</th>
              <th>Aktivitas</th>
              <th>Detail</th>
              <th style="width:100px">Undo</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ===== Modals ===== -->

<!-- Add / Edit Item -->
<div class="modal" id="addModal" onclick="closeModal('addModal')">
  <div class="box" onclick="event.stopPropagation()">
    <button class="closeX" onclick="closeModal('addModal')">✕</button>
    <h3 id="addTitle">Tambah Item</h3>

    <div class="grid2 mt8">
      <div class="ac-wrap">
        <label>Nama Unit <span class="badge">wajib</span></label>
        <input id="fName" class="input" autocomplete="off" placeholder="mis. Polygon Strada">
        <div id="acList" class="ac-list"></div>
      </div>
      <div>
        <label>Supplier <span class="badge">wajib</span></label>
        <select id="fSup" class="input"><option value="">-- pilih --</option></select>
      </div>
    </div>

    <div class="grid2 mt8">
      <div>
        <label>Tipe <span class="badge">wajib</span></label>
        <select id="fType" class="input"><option value="">-- pilih --</option></select>
      </div>
      <div>
        <label>Ukuran (inci) <span class="badge">wajib</span></label>
        <select id="fSize" class="input"><option value="">-- pilih --</option></select>
      </div>
    </div>

    <div class="grid2 mt8">
      <div>
        <label>Kemasan <span class="badge">wajib</span></label>
        <select id="fPack" class="input"><option value="">-- pilih --</option></select>
      </div>
      <div>
        <label>Status Sepeda <span class="badge">wajib</span></label>
        <select id="fStatus" class="input">
          <option value="">-- pilih --</option>
          <option value="masuk">Belum Rakit</option>
          <option value="dirakit">Sudah Rakit</option>
        </select>
      </div>
    </div>

    <div class="grid2 mt8">
      <div>
        <label>Jumlah Unit Total <span class="badge">wajib</span></label>
        <div class="row">
          <input id="fQty" type="number" class="input" min="1" placeholder="mis. 5" style="width:120px" oninput="min1(this);guardAllLocToQty()">
          <button class="btn ghost small" onclick="stepNum('fQty',+1);guardAllLocToQty()">+</button>
          <button class="btn ghost small" onclick="stepNum('fQty',-1);guardAllLocToQty()">−</button>
        </div>
      </div>
      <div>
        <label>Tanggal Kedatangan</label>
        <div class="row">
          <input id="fArrive" type="date" class="input" style="flex:1">
          <button class="btn ghost small" onclick="setToday('fArrive')">Hari Ini</button>
          <button class="btn ghost small" onclick="openNAModal('fArrive')">N/A</button>
        </div>
      </div>
    </div>

    <div id="asmRow" class="grid2 mt8 hidden">
      <div>
        <label>Tanggal Rakit</label>
        <div class="row">
          <input id="fAsmDate" type="date" class="input" style="flex:1">
          <button class="btn ghost small" onclick="setToday('fAsmDate')">Hari Ini</button>
          <button class="btn ghost small" onclick="openNAModal('fAsmDate')">N/A</button>
        </div>
      </div>
      <div>
        <label>Pegawai Perakit <span class="badge">wajib</span></label>
        <select id="fAsmEmp" class="input"><option value="">-- pilih / N/A --</option></select>
      </div>
    </div>

    <div class="section mt8">
      <h4>Warna & Kuantitas <span class="small">(opsional; total ≤ jumlah)</span></h4>
      <div id="colorWrap"></div>
      <button class="btn ghost mt8 small" onclick="addColorRow()">+ Tambah Warna</button>
    </div>

    <div class="section mt8">
      <h4>Lokasi Penyimpanan & Kuantitas <span class="small">(wajib; total = jumlah)</span></h4>
      <div id="locWrap"></div>
      <button class="btn ghost mt8 small" onclick="addLocRow()">+ Tambah Lokasi</button>
    </div>

    <div class="mt12">
      <label>Gambar (opsional)</label>
      <input id="fImg" type="file" accept="image/*" class="input">
    </div>

    <div class="row mt16">
      <button class="btn" id="btnSave">Simpan</button>
      <button class="btn ghost" onclick="closeModal('addModal')">Batal</button>
    </div>
  </div>
</div>

<!-- Picker Perakitan -->
<div class="modal" id="asmModal" onclick="closeModal('asmModal')"><div class="box" onclick="event.stopPropagation()">
  <button class="closeX" onclick="closeModal('asmModal')">✕</button>
  <h3>Pilih Sepeda (Belum Rakit)</h3>
  <input id="asmSearch" class="input mt8" placeholder="Cari sepeda Belum Rakit...">
  <div id="asmList" class="list scrollable-container mt8"></div>
</div></div>

<!-- Detail Perakitan -->
<div class="modal" id="asmDetailModal" onclick="closeModal('asmDetailModal')"><div class="box" onclick="event.stopPropagation()">
  <button class="closeX" onclick="closeModal('asmDetailModal')">✕</button>
  <div id="asmHeader" class="mt8"></div>
  <div class="grid2 mt8">
    <div>
      <label>Jumlah Unit Dirakit <span class="badge">wajib</span></label>
      <div class="row">
        <input id="adQty" type="number" class="input" min="1" style="width:120px" oninput="clampToStock(this,'asm')">
        <button class="btn ghost small" onclick="stepLocal('adQty','asm',+1)">+</button>
        <button class="btn ghost small" onclick="stepLocal('adQty','asm',-1)">−</button>
      </div>
    </div>
    <div>
      <label>Warna (opsional)</label>
      <input id="adColor" class="input" placeholder="mis. Merah:1; Hitam:2">
    </div>
  </div>
  <div class="grid2 mt8">
    <div>
      <label>Tanggal Rakit</label>
      <div class="row">
        <input id="adDate" type="date" class="input" style="flex:1">
        <button class="btn ghost small" onclick="setToday('adDate')">Hari Ini</button>
        <button class="btn ghost small" onclick="openNAModal('adDate')">N/A</button>
      </div>
    </div>
    <div>
      <label>Nama Pegawai <span class="badge">wajib</span></label>
      <select id="adEmp" class="input"><option value="">-- pilih / N/A --</option></select>
    </div>
  </div>
  <div class="row mt16">
    <button class="btn" id="adSave">Simpan</button>
    <button class="btn ghost" onclick="closeModal('asmDetailModal')">Batal</button>
  </div>
</div></div>

<!-- Picker Penjualan -->
<div class="modal" id="sellModal" onclick="closeModal('sellModal')"><div class="box" onclick="event.stopPropagation()">
  <button class="closeX" onclick="closeModal('sellModal')">✕</button>
  <h3>Pilih Sepeda (Sudah Rakit)</h3>
  <input id="sellSearch" class="input mt8" placeholder="Cari sepeda Sudah Rakit...">
  <div id="sellList" class="list scrollable-container mt8"></div>
</div></div>

<!-- Detail Penjualan -->
<div class="modal" id="sellDetailModal" onclick="closeModal('sellDetailModal')"><div class="box" onclick="event.stopPropagation()">
  <button class="closeX" onclick="closeModal('sellDetailModal')">✕</button>
  <div id="sellHeader" class="mt8"></div>
  <div class="grid2 mt8">
    <div>
      <label>Jumlah Unit Terjual <span class="badge">wajib</span></label>
      <div class="row">
        <input id="sdQty" type="number" class="input" min="1" style="width:120px" oninput="clampToStock(this,'sell')">
        <button class="btn ghost small" onclick="stepLocal('sdQty','sell',+1)">+</button>
        <button class="btn ghost small" onclick="stepLocal('sdQty','sell',-1)">−</button>
      </div>
    </div>
    <div>
      <label>Warna (opsional)</label>
      <input id="sdColor" class="input" placeholder="mis. Merah:1; Hitam:1">
    </div>
  </div>
  <div class="grid2 mt8">
    <div>
      <label>Tanggal Terjual <span class="badge">wajib</span></label>
      <div class="row">
        <input id="sdDate" type="date" class="input" style="flex:1">
        <button class="btn ghost small" onclick="setToday('sdDate')">Hari Ini</button>
      </div>
    </div>
  </div>
  <div class="row mt16">
    <button class="btn" id="sdSave">Simpan</button>
    <button class="btn ghost" onclick="closeModal('sellDetailModal')">Batal</button>
  </div>
</div></div>

<!-- Detail Item -->
<div class="modal" id="detailModal" onclick="closeModal('detailModal')"><div class="box" onclick="event.stopPropagation()">
  <button class="closeX" onclick="closeModal('detailModal')">✕</button>
  <div id="detailBody"></div>
</div></div>

<!-- Mass Edit -->
<div class="modal" id="massEditModal" onclick="closeModal('massEditModal')"><div class="box" onclick="event.stopPropagation()">
  <button class="closeX" onclick="closeModal('massEditModal')">✕</button>
  <h3>Edit Massal</h3>
  <p class="small">Hanya kolom yang diisi akan diterapkan ke semua item terpilih.</p>
  <div class="grid2 mt8">
    <div><label>Supplier</label><select id="meSup" class="input"><option value="">(kosong)</option></select></div>
    <div><label>Tipe</label><select id="meType" class="input"><option value="">(kosong)</option></select></div>
  </div>
  <div class="grid2 mt8">
    <div><label>Ukuran</label><select id="meSize" class="input"><option value="">(kosong)</option></select></div>
    <div><label>Kemasan</label><select id="mePack" class="input"><option value="">(kosong)</option></select></div>
  </div>
  <div class="row mt16">
    <button class="btn" id="meApply">Terapkan</button>
    <button class="btn ghost" onclick="closeModal('massEditModal')">Batal</button>
  </div>
</div></div>

<!-- QR Code Modal -->
<div class="modal" id="qrModal" onclick="closeModal('qrModal')">
  <div class="box" onclick="event.stopPropagation()">
    <button class="closeX" onclick="closeModal('qrModal')">✕</button>
    <h3>QR Code Produk</h3>
    <div id="qrCodeContainer" style="text-align: center; padding: 20px;"></div>
    <div class="row mt12" style="justify-content: center;">
      <button class="btn" onclick="printQRCode()">Print QR Code</button>
    </div>
  </div>
</div>

<!-- Scan QR Modal -->
<div class="modal" id="scanModal" onclick="closeModal('scanModal')">
  <div class="box" onclick="event.stopPropagation()">
    <button class="closeX" onclick="closeModal('scanModal')">✕</button>
    <h3>Scan QR Code</h3>
    <div id="qrScanner" style="width: 100%; height: 300px; background: #f1f5f9; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
      <div id="scannerContainer" style="width: 100%; height: 100%;"></div>
    </div>
    <div class="row mt12" style="justify-content: center;">
      <button class="btn red" id="btnStopScan" onclick="stopQRScanner()">Stop Scan</button>
    </div>
  </div>
</div>

<!-- Camera Modal -->
<div class="modal" id="cameraModal" onclick="closeModal('cameraModal')">
  <div class="box" onclick="event.stopPropagation()">
    <button class="closeX" onclick="closeCamera()">✕</button>
    <h3>Ambil Foto</h3>
    <div id="cameraContainer" style="width: 100%; height: 400px; background: #000; border-radius: 12px; overflow: hidden; position: relative;">
      <video id="cameraVideo" autoplay playsinline style="width: 100%; height: 100%; object-fit: cover;"></video>
      <canvas id="cameraCanvas" style="display: none;"></canvas>
    </div>
    <div class="row mt12" style="justify-content: center;">
      <button class="btn red" id="btnCapture" onclick="capturePhoto()">Ambil Foto</button>
      <button class="btn ghost" id="btnRetake" onclick="retakePhoto()" style="display: none;">Ulangi</button>
      <button class="btn green" id="btnSavePhoto" onclick="savePhoto()" style="display: none;">Simpan Foto</button>
    </div>
  </div>
</div>

<!-- Custom Report Builder Modal -->
<div class="modal" id="customReportModal" onclick="closeModal('customReportModal')">
  <div class="box" onclick="event.stopPropagation()">
    <button class="closeX" onclick="closeModal('customReportModal')">✕</button>
    <h3>Laporan Custom</h3>
    
    <div class="custom-report-builder">
      <h4>Pilih Kolom</h4>
      <div class="column-selector" id="columnSelector">
        <!-- Columns will be populated by JavaScript -->
      </div>
      
      <h4>Filter Data</h4>
      <div class="filter-conditions" id="filterConditions">
        <div class="filter-row">
          <select class="input" id="filterField">
            <option value="status">Status</option>
            <option value="type">Tipe</option>
            <option value="supplier">Supplier</option>
            <option value="size">Ukuran</option>
            <option value="totalQty">Jumlah Stok</option>
          </select>
          <select class="input" id="filterOperator">
            <option value="equals">Sama dengan</option>
            <option value="contains">Mengandung</option>
            <option value="greater">Lebih besar dari</option>
            <option value="less">Lebih kecil dari</option>
          </select>
          <input class="input" id="filterValue" placeholder="Nilai filter">
          <button class="btn small" onclick="addFilter()">+ Tambah Filter</button>
        </div>
        <div id="activeFilters"></div>
      </div>
      
      <div class="row mt16">
        <button class="btn" onclick="generateCustomReport()">Generate Laporan</button>
        <button class="btn ghost" onclick="closeModal('customReportModal')">Batal</button>
      </div>
    </div>
  </div>
</div>

<!-- Zoom -->
<div id="zoomBox" onclick="this.style.display='none'"><img src="" alt=""></div>

<!-- Modal Kecil: Pilihan Tanggal N/A -->
<div class="modal" id="naModal" onclick="closeModal('naModal')">
  <div class="box" onclick="event.stopPropagation()">
    <button class="closeX" onclick="closeModal('naModal')">✕</button>
    <h3 id="naTitle">Informasi Tanggal</h3>
    <p class="mt8">Apakah ada informasi tanggal untuk field ini?</p>
    <div class="row mt12">
      <button class="btn" id="naYes">Iya (pilih tanggal)</button>
      <button class="btn ghost" id="naNo">Tidak Ada Informasi Tanggal (N/A)</button>
    </div>
  </div>
</div>

<!-- Password Modal -->
<div class="modal" id="passModal" onclick="closePass(false)">
  <div class="box" onclick="event.stopPropagation()">
    <button class="closeX" onclick="closePass(false)">✕</button>
    <h3 id="passTitle">Masukkan Password</h3>
    <div class="password-container">
      <input id="passInput" type="password" class="input mt8" placeholder="Password">
      <button class="password-toggle" type="button" onclick="togglePasswordVisibility()">show</button>
    </div>
    <div id="passErr" class="err hidden">Password salah.</div>
    <div class="row mt12">
      <button class="btn" onclick="submitPass()">OK</button>
      <button class="btn ghost" onclick="closePass(false)">Batal</button>
    </div>
  </div>
</div>

<!-- Success Modal -->
<div class="modal" id="successModal" onclick="closeModal('successModal')">
  <div class="box" onclick="event.stopPropagation()">
    <button class="closeX" onclick="closeModal('successModal')">✕</button>
    <h3>Berhasil</h3>
    <p id="successMessage" class="mt8">Aksi berhasil dilakukan.</p>
    <div class="row mt16" style="justify-content: center;">
      <button class="btn" onclick="closeModal('successModal'); refreshData();">Oke</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast"></div>

<!-- PWA Install Button -->
<button id="installBtn" class="hidden">Install App</button>

<script>
/* ========= ENKRIPSI DATA ========= */
const ENCRYPTION_KEY = "mujur-bikes-v8-encryption-key-2024"; // Bisa diganti

// Fungsi enkripsi sederhana menggunakan AES simulation
function encryptData(data) {
    try {
        const dataStr = JSON.stringify(data);
        let result = '';
        for (let i = 0; i < dataStr.length; i++) {
            result += String.fromCharCode(dataStr.charCodeAt(i) ^ ENCRYPTION_KEY.charCodeAt(i % ENCRYPTION_KEY.length));
        }
        return btoa(result);
    } catch (error) {
        console.error('Encryption error:', error);
        return null;
    }
}

function decryptData(encryptedData) {
    try {
        const decoded = atob(encryptedData);
        let result = '';
        for (let i = 0; i < decoded.length; i++) {
            result += String.fromCharCode(decoded.charCodeAt(i) ^ ENCRYPTION_KEY.charCodeAt(i % ENCRYPTION_KEY.length));
        }
        return JSON.parse(result);
    } catch (error) {
        console.error('Decryption error:', error);
        return null;
    }
}

function getDefaultStore() {
    return {
        items:[],
        suppliers:["VL","JY","KL","N/A"],
        employees:["N/A","Andi","Nursan","Sudi"],
        types:["BMX","Mini","MTB","Road","Lipat"],
        sizes:['12"','16"','18"','20"','24"','26"','27.5"','29"'],
        packs:["Dus","Karung","N/A"],
        locations:["Toko","Gudang"],
        history:[],
        settings: {
            autoRefresh: true,
            autoBackup: true,
            // Tambahkan setting password
            masterPassword: "pabalusepeda",
            userPasswords: {
                admin: "admin123",
                staff: "staff123"
            }
        }
    };
}

/* ========= FIREBASE CONFIGURATION ========= */
// GANTI DENGAN KONFIGURASI FIREBASE ANDA SENDIRI
const firebaseConfig = {
  apiKey: "AIzaSyBeDyMBZJywkawfu61AW7dHvWeAXcJuHV4",
  authDomain: "mujur-bikes-v8-22bfd.firebaseapp.com",
  databaseURL: "https://mujur-bikes-v8-22bfd-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "mujur-bikes-v8-22bfd",
  storageBucket: "mujur-bikes-v8-22bfd.firebasestorage.app",
  messagingSenderId: "967663855989",
  appId: "1:967663855989:web:27f0cc56ead59590428b3c"
};

// Initialize Firebase
try {
  firebase.initializeApp(firebaseConfig);
  console.log('Firebase initialized successfully');
} catch (error) {
  console.error('Firebase initialization error:', error);
}

const database = firebase.database();
const auth = firebase.auth();

// Firebase state
let isOnline = false;
let syncInProgress = false;

/* ========= State & Utils ========= */
const $=id=>document.getElementById(id);
let route="dashboard", multi=false, selectedIds=new Set(), currentList=[], currentIndex=-1, editingId=null, asmPick=null, sellPick=null;

// Pagination state
let currentPage = 1;
let itemsPerPage = 10;

// Fitur baru: Auto refresh dan backup
let autoRefreshInterval = null;
let autoBackupInterval = null;
let isAutoRefreshEnabled = true;
let isAutoBackupEnabled = true;

// Custom report state
let selectedColumns = ['name', 'type', 'size', 'status', 'totalQty'];
let activeFilters = [];

// detail re-open context agar box tidak menghilang
let _detailCtx=null;

// tanggal N/A flow
let _naTarget=null, _naContinue=null;

// password modal flow
let _passResolve=null, _passTitle="Masukkan Password";

// PWA install prompt
let deferredPrompt;

// QR Code dan Camera state
let qrScanner = null;
let cameraStream = null;
let currentPhotoItemId = null;

// Modifikasi inisialisasi store untuk handle data terenkripsi
let store = (function() {
    const stored = localStorage.getItem("mujur-v80");
    if (!stored) {
        return getDefaultStore();
    }
    
    // Coba decrypt dulu
    try {
        const decrypted = decryptData(stored);
        if (decrypted) {
            return decrypted;
        }
    } catch (e) {
        console.log('Data tidak terenkripsi, menggunakan fallback');
    }
    
    // Fallback untuk data lama yang belum terenkripsi
    try {
        const parsed = JSON.parse(stored);
        // Pastikan settings ada
        if (!parsed.settings) {
            parsed.settings = getDefaultStore().settings;
        }
        if (!parsed.settings.userPasswords) {
            parsed.settings.userPasswords = getDefaultStore().settings.userPasswords;
        }
        if (!parsed.settings.masterPassword) {
            parsed.settings.masterPassword = getDefaultStore().settings.masterPassword;
        }
        return parsed;
    } catch (e) {
        console.error('Error parsing stored data:', e);
        return getDefaultStore();
    }
})();

/* ========= User Management ========= */
let currentUser = null;

const ROLE_PERMISSIONS = {
  admin: ['view', 'add', 'edit', 'delete', 'import', 'export', 'master', 'reports', 'backup', 'restore'],
  staff: ['view', 'add', 'edit', 'delete', 'import', 'export', 'reports'] // Staff bisa hapus
};

// ========= FITUR BARU: MOBILE APP/PWA =========

// Service Worker Registration
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('/sw.js').then(function(registration) {
      console.log('SW registered: ', registration);
    }).catch(function(registrationError) {
      console.log('SW registration failed: ', registrationError);
    });
  });
}

// PWA Install Prompt
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  $('installBtn').classList.remove('hidden');
});

$('installBtn').addEventListener('click', async () => {
  if (!deferredPrompt) return;
  
  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  
  if (outcome === 'accepted') {
    $('installBtn').classList.add('hidden');
  }
  
  deferredPrompt = null;
});

window.addEventListener('appinstalled', () => {
  $('installBtn').classList.add('hidden');
  deferredPrompt = null;
  toast('Aplikasi berhasil diinstall!');
});

// ========= FITUR BARU: DASHBOARD REAL-TIME =========

function initRealTimeFeatures() {
  // Auto refresh dashboard
  if (isAutoRefreshEnabled) {
    autoRefreshInterval = setInterval(() => {
      if (route === 'dashboard') {
        refreshData();
      }
    }, 30000); // Refresh setiap 30 detik
  }
  
  // Auto backup
  if (isAutoBackupEnabled) {
    autoBackupInterval = setInterval(() => {
      autoBackup();
    }, 300000); // Backup setiap 5 menit
  }
}

function toggleAutoRefresh() {
  isAutoRefreshEnabled = !isAutoRefreshEnabled;
  const btn = $('#autoRefreshBtn');
  
  if (isAutoRefreshEnabled) {
    btn.textContent = 'Auto: ON';
    initRealTimeFeatures();
    toast('Auto refresh diaktifkan');
  } else {
    btn.textContent = 'Auto: OFF';
    clearInterval(autoRefreshInterval);
    toast('Auto refresh dimatikan');
  }
  
  store.settings.autoRefresh = isAutoRefreshEnabled;
  save();
}

// ========= FITUR BARU: AUTO BACKUP CLOUD =========

function autoBackup() {
  if (!isAutoBackupEnabled) return;
  
  const backupData = {
    version: 'mujur-bikes-v8.0',
    timestamp: new Date().toISOString(),
    data: store,
    user: currentUser ? currentUser.username : 'unknown'
  };
  
  // Simpan ke localStorage sebagai simulasi cloud backup
  const backupKey = `mujur-backup-${new Date().toISOString().split('T')[0]}`;
  localStorage.setItem(backupKey, JSON.stringify(backupData));
  
  // Update status backup
  $('#backupStatus').textContent = `Auto Backup: Aktif - Terakhir backup ${new Date().toLocaleTimeString('id-ID')}`;
  
  // Hapus backup yang lebih dari 7 hari
  cleanupOldBackups();
}

function cleanupOldBackups() {
  const oneWeekAgo = new Date();
  oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
  
  Object.keys(localStorage).forEach(key => {
    if (key.startsWith('mujur-backup-')) {
      const dateStr = key.replace('mujur-backup-', '');
      const backupDate = new Date(dateStr);
      if (backupDate < oneWeekAgo) {
        localStorage.removeItem(key);
      }
    }
  });
}

function restoreFromAutoBackup() {
  // Cari backup terbaru
  let latestBackupKey = null;
  let latestDate = new Date(0);
  
  Object.keys(localStorage).forEach(key => {
    if (key.startsWith('mujur-backup-')) {
      const dateStr = key.replace('mujur-backup-', '');
      const backupDate = new Date(dateStr);
      if (backupDate > latestDate) {
        latestDate = backupDate;
        latestBackupKey = key;
      }
    }
  });
  
  if (latestBackupKey) {
    const backupData = JSON.parse(localStorage.getItem(latestBackupKey));
    if (backupData && backupData.data) {
      store = backupData.data;
      save();
      showSuccess(`Data berhasil direstore dari backup ${latestDate.toLocaleDateString('id-ID')}`);
      return true;
    }
  }
  return false;
}

// ========= FITUR BARU: CUSTOM REPORT BUILDER =========

function showCustomReportBuilder() {
  // Setup column selector
  const columns = [
    { id: 'name', label: 'Nama', checked: true },
    { id: 'type', label: 'Tipe', checked: true },
    { id: 'size', label: 'Ukuran', checked: true },
    { id: 'supplier', label: 'Supplier', checked: false },
    { id: 'status', label: 'Status', checked: true },
    { id: 'totalQty', label: 'Jumlah Stok', checked: true },
    { id: 'arrivalDate', label: 'Tanggal Datang', checked: false },
    { id: 'pack', label: 'Kemasan', checked: false }
  ];
  
  let columnHTML = '';
  columns.forEach(col => {
    columnHTML += `
      <label style="display: flex; align-items: center; gap: 8px;">
        <input type="checkbox" ${col.checked ? 'checked' : ''} value="${col.id}" onchange="updateSelectedColumns()">
        ${col.label}
      </label>
    `;
  });
  
  $('#columnSelector').innerHTML = columnHTML;
  $('#activeFilters').innerHTML = '';
  activeFilters = [];
  
  showModal('customReportModal');
}

function updateSelectedColumns() {
  selectedColumns = [];
  $('#columnSelector').querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
    selectedColumns.push(checkbox.value);
  });
}

function addFilter() {
  const field = $('#filterField').value;
  const operator = $('#filterOperator').value;
  const value = $('#filterValue').value.trim();
  
  if (!value) {
    alert('Masukkan nilai filter');
    return;
  }
  
  const filter = { field, operator, value };
  activeFilters.push(filter);
  
  renderActiveFilters();
}

function renderActiveFilters() {
  let html = '';
  activeFilters.forEach((filter, index) => {
    html += `
      <div class="filter-row">
        <span>${filter.field} ${getOperatorText(filter.operator)} "${filter.value}"</span>
        <button class="btn ghost small" onclick="removeFilter(${index})">Hapus</button>
      </div>
    `;
  });
  $('#activeFilters').innerHTML = html;
}

function getOperatorText(operator) {
  switch(operator) {
    case 'equals': return '=';
    case 'contains': return 'mengandung';
    case 'greater': return '>';
    case 'less': return '<';
    default: return operator;
  }
}

function removeFilter(index) {
  activeFilters.splice(index, 1);
  renderActiveFilters();
}

function generateCustomReport() {
  if (selectedColumns.length === 0) {
    alert('Pilih minimal satu kolom');
    return;
  }
  
  const startDate = $('#reportStartDate').value;
  const endDate = $('#reportEndDate').value;
  
  let filteredItems = store.items.filter(item => {
    // Filter by date range
    if (startDate && endDate && item.arrivalDate && item.arrivalDate !== 'N/A') {
      if (item.arrivalDate < startDate || item.arrivalDate > endDate) {
        return false;
      }
    }
    
    // Apply custom filters
    for (const filter of activeFilters) {
      const itemValue = String(item[filter.field] || '').toLowerCase();
      const filterValue = filter.value.toLowerCase();
      
      switch(filter.operator) {
        case 'equals':
          if (itemValue !== filterValue) return false;
          break;
        case 'contains':
          if (!itemValue.includes(filterValue)) return false;
          break;
        case 'greater':
          if (Number(itemValue) <= Number(filterValue)) return false;
          break;
        case 'less':
          if (Number(itemValue) >= Number(filterValue)) return false;
          break;
      }
    }
    
    return true;
  });
  
  // Generate report table
  let html = `<h3>Laporan Custom (${startDate || 'Semua'} s/d ${endDate || 'Semua'})</h3>`;
  html += `<div class="report-table-container">`;
  html += `<table class="table"><thead><tr>`;
  
  // Header columns
  selectedColumns.forEach(col => {
    let colName = '';
    switch(col) {
      case 'name': colName = 'Nama'; break;
      case 'type': colName = 'Tipe'; break;
      case 'size': colName = 'Ukuran'; break;
      case 'supplier': colName = 'Supplier'; break;
      case 'status': colName = 'Status'; break;
      case 'totalQty': colName = 'Jumlah Stok'; break;
      case 'arrivalDate': colName = 'Tanggal Datang'; break;
      case 'pack': colName = 'Kemasan'; break;
    }
    html += `<th>${colName}</th>`;
  });
  
  html += `</tr></thead><tbody>`;
  
  // Data rows
  filteredItems.forEach(item => {
    html += `<tr>`;
    selectedColumns.forEach(col => {
      let value = item[col] || '-';
      if (col === 'status') {
        value = value === 'masuk' ? 'Belum Rakit' : 
                value === 'dirakit' ? 'Sudah Rakit' : 'Terjual';
      }
      html += `<td>${value}</td>`;
    });
    html += `</tr>`;
  });
  
  html += `</tbody></table>`;
  html += `</div>`;
  html += `<div class="mt12"><strong>Total Data: ${filteredItems.length} item</strong></div>`;
  
  $('#laporanResult').innerHTML = html;
  closeModal('customReportModal');
}

/* ========= QR Code Functions ========= */
function generateQRCode(itemId) {
  console.log('🚀 generateQRCode called with itemId:', itemId);
  console.log('📦 Available QRCode library:', typeof QRCode);
  
  const item = store.items.find(x => x.id === itemId);
  console.log('🔍 Item found:', item);
  
  if (!item) {
    console.error('❌ Item not found for ID:', itemId);
    alert('Item tidak ditemukan');
    return;
  }

  const qrData = JSON.stringify({
    id: item.id,
    name: item.name,
    type: item.type,
    size: item.size,
    supplier: item.supplier,
    code: item.code || genCode(item.supplier, item.arrivalDate),
    timestamp: new Date().toISOString()
  });

  const qrContainer = $('#qrCodeContainer');
  qrContainer.innerHTML = '<div style="text-align:center; padding:20px;">Generating QR Code...</div>';

  // Clear previous QR code
  qrContainer.innerHTML = '';
  
  try {
    // Create canvas element for QR code
    const canvas = document.createElement('canvas');
    qrContainer.appendChild(canvas);
    
    // Generate QR code using the library
    QRCode.toCanvas(canvas, qrData, {
      width: 200,
      margin: 2,
      color: {
        dark: '#000000',
        light: '#FFFFFF'
      }
    }, function(error) {
      if (error) {
        console.error('QR Code generation error:', error);
        showQRCodeFallback(qrData, qrContainer, item);
        return;
      }
      
      // Add product info below QR code
      const productInfo = document.createElement('div');
      productInfo.className = 'qr-product-info';
      productInfo.innerHTML = `
        <div class="qr-product-name">${item.name}</div>
        <div class="qr-product-details">${item.type} • ${item.size}</div>
        <div class="qr-product-details">Supplier: ${item.supplier || 'N/A'}</div>
        <div class="qr-product-details">Kode: ${item.code || 'No Code'}</div>
      `;
      qrContainer.appendChild(productInfo);
    });
    
  } catch (error) {
    console.error('QR Code generation failed:', error);
    showQRCodeFallback(qrData, qrContainer, item);
  }

  showModal('qrModal');
}

function showQRCodeFallback(qrData, container, item) {
  container.innerHTML = `
    <div style="text-align: center; padding: 20px; border: 2px dashed #ccc; border-radius: 10px; background: #f9f9f9;">
      <div style="font-size: 48px; margin-bottom: 10px;">📄</div>
      <div style="font-weight: bold; margin-bottom: 10px;">QR Code Data</div>
      <div style="margin-bottom: 5px; font-weight: bold;">${item.name}</div>
      <div style="color: #64748b; font-size: 14px; margin-bottom: 10px;">${item.type} • ${item.size}</div>
      <div style="background: white; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 10px; word-break: break-all;">
        ${qrData}
      </div>
      <div style="margin-top: 15px; font-size: 12px; color: #666;">
        Data di atas dapat digunakan untuk generate QR code external
      </div>
    </div>
    <div class="qr-product-info">
      <div class="qr-product-name">${item.name}</div>
      <div class="qr-product-details">${item.type} • ${item.size}</div>
      <div class="qr-product-details">Kode: ${item.code || 'No Code'}</div>
    </div>
  `;
}

function printQRCode() {
  const printContent = $('#qrCodeContainer').innerHTML;
  const originalContent = document.body.innerHTML;

  document.body.innerHTML = printContent;
  window.print();
  document.body.innerHTML = originalContent;
  
  // Setelah print, kita perlu render ulang karena body diubah
  render();
}

function openQRScanner() {
  console.log('🔍 openQRScanner called');
  
  showModal('scanModal');
  
  // Gunakan approach yang lebih sederhana dan reliable
  $('#scannerContainer').innerHTML = `
    <div class="scanner-fallback-container">
      <div style="font-size: 64px; margin-bottom: 20px;">🔍</div>
      <div style="font-weight: bold; margin-bottom: 10px; font-size: 20px;">Scanner QR Code</div>
      <div style="margin-bottom: 20px; text-align: center; color: #666; line-height: 1.5;">
        Pilih metode scanning:
      </div>
      
      <div style="display: flex; flex-direction: column; gap: 10px; width: 100%; max-width: 250px;">
        <button class="btn" onclick="simulateQRScan()" style="padding: 12px;">
          <span style="font-size: 20px; margin-right: 8px;">🎲</span>
          Scan Item Random
        </button>
        <button class="btn ghost" onclick="testManualQRInput()" style="padding: 12px;">
          <span style="font-size: 20px; margin-right: 8px;">⌨️</span>
          Input Manual Kode
        </button>
      </div>
      
      <div style="font-size: 12px; color: #999; margin-top: 25px; text-align: center;">
        Tips: Untuk scanning QR nyata, gunakan aplikasi scanner QR<br>
        dan input kode manual di atas.
      </div>
    </div>
  `;
}

function simulateQRScan() {
  const availableItems = store.items.filter(item => item.status === 'masuk' || item.status === 'dirakit');
  if (availableItems.length === 0) {
    alert('Tidak ada item yang bisa di-scan');
    return;
  }
  
  const randomItem = availableItems[Math.floor(Math.random() * availableItems.length)];
  
  $('#scannerContainer').innerHTML = `
    <div class="scanner-success">
      <div style="color: var(--green); font-size: 64px; margin-bottom: 15px;">✅</div>
      <div style="font-weight: bold; margin-bottom: 15px; font-size: 22px;">Berhasil di-scan!</div>
      <div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; text-align: left;">
        <div style="font-weight: bold; margin-bottom: 8px;">${randomItem.name}</div>
        <div style="color: #666; margin-bottom: 5px;">${randomItem.type} • ${randomItem.size}</div>
        <div style="color: #666; font-size: 12px;">Kode: ${randomItem.code || 'No Code'}</div>
      </div>
      <div style="display: flex; gap: 10px;">
        <button class="btn" onclick="openDetailFromScan('${randomItem.id}')">Lihat Detail</button>
        <button class="btn ghost" onclick="openQRScanner()">Scan Lagi</button>
      </div>
    </div>
  `;
}

function testManualQRInput() {
  const itemCode = prompt("Masukkan kode item atau nama item:");
  if (itemCode === null || itemCode.trim() === '') return;
  
  // Cari item berdasarkan kode atau nama
  let item = store.items.find(x => 
    x.code === itemCode || 
    x.name.toLowerCase().includes(itemCode.toLowerCase()) ||
    x.id === itemCode
  );
  
  if (!item) {
    // Jika tidak ditemukan, coba item random
    const availableItems = store.items.filter(item => item.status === 'masuk' || item.status === 'dirakit');
    if (availableItems.length > 0) {
      item = availableItems[Math.floor(Math.random() * availableItems.length)];
      alert('Item tidak ditemukan. Menampilkan item random sebagai contoh.');
    } else {
      alert('Item tidak ditemukan dan tidak ada item tersedia');
      return;
    }
  }
  
  openDetailFromScan(item.id);
}

function openDetailFromScan(itemId) {
  closeModal('scanModal');
  const item = store.items.find(x => x.id === itemId);
  if (item) {
    // Cari item di current list atau buka detail langsung
    const index = currentList.findIndex(x => x.id === itemId);
    if (index !== -1) {
      openDetail(item, index);
    } else {
      openDetail(item, 0);
    }
  }
}

function stopQRScanner() {
  closeModal('scanModal');
  // Di implementasi nyata, hentikan scanner di sini
  if (cameraStream) {
    cameraStream.getTracks().forEach(track => {
      track.stop();
    });
    cameraStream = null;
  }
}

/* ========= Camera Functions ========= */
function takePhoto(itemId) {
  console.log('📷 takePhoto called with itemId:', itemId);
  currentPhotoItemId = itemId;
  showModal('cameraModal');
  
  // Reset camera container dengan approach yang lebih sederhana
  $('#cameraContainer').innerHTML = `
    <div id="cameraPreview" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #000; border-radius: 12px;">
      <div id="cameraLoading" style="color: white; text-align: center;">
        <div style="font-size: 48px; margin-bottom: 20px;">📷</div>
        <div>Menginisialisasi kamera...</div>
      </div>
      <video id="cameraVideo" autoplay playsinline style="width: 100%; height: 100%; object-fit: cover; display: none;"></video>
      <canvas id="cameraCanvas" style="display: none;"></canvas>
    </div>
  `;
  
  startCamera();
}

function startCamera() {
  const video = $('#cameraVideo');
  const loading = $('#cameraLoading');
  
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    showCameraFallback();
    return;
  }

  // Coba akses kamera dengan approach yang lebih sederhana
  navigator.mediaDevices.getUserMedia({ 
    video: {
      facingMode: 'environment',
      width: { ideal: 640 },
      height: { ideal: 480 }
    },
    audio: false 
  }).then(function(stream) {
    cameraStream = stream;
    video.srcObject = stream;
    
    // Tampilkan video dan sembunyikan loading
    video.style.display = 'block';
    if (loading) loading.style.display = 'none';
    
    video.play().catch(function(err) {
      console.error('Error playing video:', err);
      showCameraFallback();
    });
    
  }).catch(function(err) {
    console.error('Error accessing camera:', err);
    showCameraFallback();
  });
}

function showCameraFallback() {
  $('#cameraContainer').innerHTML = `
    <div class="camera-fallback-container">
      <div style="font-size: 48px; margin-bottom: 20px;">❌</div>
      <div style="margin-bottom: 15px; font-size: 18px;">Kamera Tidak Dapat Diakses</div>
      <div style="font-size: 14px; margin-bottom: 20px; text-align: center;">
        Browser tidak dapat mengakses kamera.<br>
        Pastikan izin kamera sudah diaktifkan.
      </div>
      <button class="btn" onclick="uploadPhotoFallback('${currentPhotoItemId}')">Unggah Foto dari File</button>
      <button class="btn ghost" onclick="closeCamera()" style="margin-top: 10px;">Tutup</button>
    </div>
  `;
}

function uploadPhotoFallback(itemId) {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  
  input.onchange = function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(event) {
      const item = store.items.find(x => x.id === itemId);
      if (item) {
        item.image = event.target.result;
        save();
        showSuccess("Foto berhasil diunggah");
        
        // Refresh detail view
        const currentItem = store.items.find(x => x.id === itemId);
        if (currentItem) {
          const currentIndex = currentList.findIndex(x => x.id === itemId);
          if (currentIndex !== -1) {
            openDetail(currentItem, currentIndex);
          }
        }
      }
    };
    reader.readAsDataURL(file);
  };
  
  input.click();
}

function capturePhoto() {
  const video = $('#cameraVideo');
  const canvas = $('#cameraCanvas');
  const context = canvas.getContext('2d');
  
  if (!video.srcObject) {
    alert('Kamera tidak aktif');
    return;
  }

  // Set canvas size
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  
  // Capture frame
  context.drawImage(video, 0, 0, canvas.width, canvas.height);
  
  // Tampilkan preview
  $('#cameraContainer').innerHTML = `
    <div style="text-align: center;">
      <img src="${canvas.toDataURL('image/jpeg')}" style="max-width: 100%; max-height: 350px; border-radius: 8px;">
      <div style="margin-top: 10px; color: white;">Preview Foto</div>
    </div>
  `;
  
  // Update tombol
  $('#btnCapture').style.display = 'none';
  $('#btnRetake').style.display = 'block';
  $('#btnSavePhoto').style.display = 'block';
  
  // Stop kamera
  stopCamera();
}

function retakePhoto() {
  // Kembali ke mode kamera
  $('#cameraContainer').innerHTML = `
    <div id="cameraPreview" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #000; border-radius: 12px;">
      <div id="cameraLoading" style="color: white; text-align: center;">
        <div style="font-size: 48px; margin-bottom: 20px;">📷</div>
        <div>Menginisialisasi kamera...</div>
      </div>
      <video id="cameraVideo" autoplay playsinline style="width: 100%; height: 100%; object-fit: cover; display: none;"></video>
      <canvas id="cameraCanvas" style="display: none;"></canvas>
    </div>
  `;
  
  startCamera();
}

function savePhoto() {
  if (!currentPhotoItemId) return;
  
  const canvas = $('#cameraCanvas');
  const imageData = canvas.toDataURL('image/jpeg');
  
  const item = store.items.find(x => x.id === currentPhotoItemId);
  if (item) {
    item.image = imageData;
    
    // Jika ada item dengan nama, tipe, dan ukuran yang sama, update juga gambarnya
    store.items.forEach(it => {
      if (it.name === item.name && it.type === item.type && it.size === item.size && !it.image) {
        it.image = imageData;
      }
    });
    
    save();
    showSuccess("Foto berhasil disimpan");
    
    // Refresh detail view
    const currentItem = store.items.find(x => x.id === currentPhotoItemId);
    if (currentItem) {
      const currentIndex = currentList.findIndex(x => x.id === currentPhotoItemId);
      if (currentIndex !== -1) {
        openDetail(currentItem, currentIndex);
      }
    }
  }
  
  closeCamera();
}

function stopCamera() {
  if (cameraStream) {
    cameraStream.getTracks().forEach(track => {
      track.stop();
    });
    cameraStream = null;
  }
}

function closeCamera() {
  stopCamera();
  closeModal('cameraModal');
}

// ========= FUNGSI UTAMA YANG SUDAH ADA =========

function save(){ 
  // Tambahkan timestamp
  store.lastSync = Date.now();
  
  // Enkripsi data sebelum menyimpan ke localStorage
  const encryptedData = encryptData(store);
  if (encryptedData) {
    localStorage.setItem("mujur-v80", encryptedData);
  } else {
    // Fallback ke penyimpanan tanpa enkripsi jika error
    localStorage.setItem("mujur-v80", JSON.stringify(store));
  }
  
  // Auto backup ketika ada perubahan data
  if (isAutoBackupEnabled) {
    setTimeout(autoBackup, 1000);
  }
  
  // Selalu render ulang setelah save untuk memastikan UI update
  if(route === "master") {
    renderMaster();
  } else if(route === "dashboard") {
    renderDashboard();
  } else if(route === "laporan") {
    renderHistory();
  } else {
    renderList();
  }
  
  // Check notifications after save
  if (currentUser) {
    setTimeout(checkStockNotifications, 500);
  }
}

function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
function ddmmyy(d){const [y,m,dd]=d.split("-");return dd+m+y.slice(-2);}
function isoFromDDMMYY(s){ if(!s) return ""; s=s.replace(/[^\d]/g,""); if(s.length!==6) return ""; const dd=s.slice(0,2),mm=s.slice(2,4),yy=s.slice(4); return `20${yy}-${mm}-${dd}`;}
function genCode(sup,arr){ if(!sup||!arr||arr==="N/A") return null; return sup+ddmmyy(arr); }
function min1(inp){ let v=parseInt(inp.value||0); if(isNaN(v)||v<1) v=1; inp.value=v; }
function stepNum(id,delta){ const el=$(id); let v=parseInt(el.value||0)||0; v+=delta; if(v<1) v=1; el.value=v; }
function setToday(id){ const t=new Date().toISOString().slice(0,10); const el=$(id); el.value=t; el.dataset.na=""; }
function toast(msg){ const t=$("toast"); t.textContent=msg; t.style.display="block"; clearTimeout(t._to); t._to=setTimeout(()=>t.style.display="none",2000); }
function chips(arr,key='color',val='qty'){ return (arr||[]).map(x=>`${x[key]}:${x[val]}`).join("; "); }
function esc(s){return (s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");}

// Fitur Baru: Validasi urutan tanggal
function validateDateSequence(arrivalDate, assemblyDate, saleDate) {
    const messages = [];
    
    if (assemblyDate && arrivalDate && assemblyDate < arrivalDate) {
        messages.push("Tanggal rakit tidak boleh lebih awal dari tanggal kedatangan");
    }
    
    if (saleDate && assemblyDate && saleDate < assemblyDate) {
        messages.push("Tanggal terjual tidak boleh lebih awal dari tanggal rakit");
    }
    
    if (saleDate && arrivalDate && saleDate < arrivalDate) {
        messages.push("Tanggal terjual tidak boleh lebih awal dari tanggal kedatangan");
    }
    
    return messages;
}

// Fitur Baru: Refresh data
function refreshData() {
  if(route === "master") {
    renderMaster();
  } else if(route === "dashboard") {
    renderDashboard();
  } else if(route === "laporan") {
    renderHistory();
  } else {
    renderList();
  }
  toast("Data diperbarui");
}

// Fitur Baru: Show success modal
function showSuccess(message) {
  $("successMessage").textContent = message;
  showModal("successModal");
}

/* ========= Password Visibility Toggle ========= */
function togglePasswordVisibility() {
  const input = $("passInput");
  const toggle = document.querySelector("#passModal .password-toggle");
  
  if (input.type === "password") {
    input.type = "text";
    toggle.textContent = "hide";
  } else {
    input.type = "password";
    toggle.textContent = "show";
  }
}

function toggleLoginPassword() {
  const input = $('loginPassword');
  const toggle = document.querySelector('#loginModal .password-toggle');
  
  if (input.type === 'password') {
    input.type = 'text';
    toggle.textContent = 'hide';
  } else {
    input.type = 'password';
    toggle.textContent = 'show';
  }
}

/* ========= User Management Functions ========= */
function initAuth() {
  const savedUser = localStorage.getItem('mujur-currentUser');
  if (savedUser) {
    currentUser = JSON.parse(savedUser);
    applyUserPermissions();
    showUserInfo();
  } else {
    showModal('loginModal');
  }
}

function doLogin() {
  const username = $('loginUsername').value;
  const password = $('loginPassword').value;
  
  // Cek password dari settings
  const storedPassword = store.settings.userPasswords[username];
  
  if (storedPassword && storedPassword === password) {
    currentUser = {
      username: username,
      role: username === 'admin' ? 'admin' : 'staff',
      name: username === 'admin' ? 'Administrator' : 'Staff',
      password: password
    };
    
    localStorage.setItem('mujur-currentUser', JSON.stringify(currentUser));
    
    closeModal('loginModal');
    applyUserPermissions();
    showUserInfo();
    toast(`Selamat datang, ${currentUser.name}!`);
    checkStockNotifications();
  } else {
    $('loginErr').classList.remove('hidden');
  }
}

function logout() {
  if (!confirm("Apakah Anda yakin ingin logout?")) {
    return;
  }
  
  currentUser = null;
  localStorage.removeItem('mujur-currentUser');
  isOnline = false;
  
  // Clear form login
  $('loginUsername').value = '';
  $('loginPassword').value = '';
  $('loginErr').classList.add('hidden');
  
  showModal('loginModal');
  toast('Anda telah logout');
}

function applyUserPermissions() {
  const permissions = ROLE_PERMISSIONS[currentUser.role] || [];
  
  // Sembunyikan tombol berdasarkan permission
  const elementsToHide = {
    'add': ['btnAdd', 'btnAddAsm', 'btnAddSell'],
    'edit': ['btnMassEdit'],
    'delete': ['btnMassDelete'],
    'import': ['btnImport'],
    'export': ['btnExport'],
    'master': ['tab[data-route="master"]'],
    'reports': ['tab[data-route="laporan"]'],
    'backup': ['backupBtn'],
    'restore': ['restoreBtn']
  };
  
  Object.keys(elementsToHide).forEach(permission => {
    if (!permissions.includes(permission)) {
      elementsToHide[permission].forEach(id => {
        const element = $(id);
        if (element) {
          element.style.display = 'none';
        }
      });
    }
  });
  
  // Jika tidak ada permission master, redirect dari halaman master
  if (route === 'master' && !permissions.includes('master')) {
    setRoute('dashboard');
  }
  
  // Jika tidak ada permission laporan, redirect dari halaman laporan
  if (route === 'laporan' && !permissions.includes('reports')) {
    setRoute('dashboard');
  }
}

function showUserInfo() {
  // Tambahkan info user di header
  let userInfo = document.getElementById('userInfo');
  if (!userInfo) {
    userInfo = document.createElement('div');
    userInfo.id = 'userInfo';
    userInfo.style.cssText = 'position: absolute; top: 10px; right: 10px; font-size: 12px; color: #64748b;';
    document.querySelector('.container').appendChild(userInfo);
  }
  
  userInfo.innerHTML = `
    <div class="menu" id="userMenu">
      <button class="btn ghost small" style="font-size: 12px; padding: 4px 8px;">
        ${currentUser.name} (${currentUser.role})
      </button>
      <div class="menu-panel">
        <button class="btn" onclick="logout()">Logout</button>
      </div>
    </div>
  `;
  
  // Event listener untuk user menu
  document.getElementById('userMenu').onclick = (e) => {
    e.stopPropagation();
    document.getElementById('userMenu').classList.toggle('open');
  };
}

function closeLogin() {
  if (!currentUser) {
    alert('Anda harus login untuk menggunakan sistem ini.');
    return;
  }
  closeModal('loginModal');
}

/* ========= Password Modal ========= */
function askPass(title="Masukkan Password"){
  // Skip password check for admin users
  if (currentUser && currentUser.role === 'admin') {
    return Promise.resolve(true);
  }
  
  _passTitle=title; 
  $("passTitle").textContent=title; 
  $("passInput").value=""; 
  $("passErr").classList.add("hidden");
  
  // Reset password visibility
  $("passInput").type = "password";
  document.querySelector("#passModal .password-toggle").textContent = "show";
  
  return new Promise(res=>{ 
    _passResolve=res; 
    showModal("passModal"); 
    $("passInput").focus(); 
  });
}

function submitPass(){
  const inputPassword = $("passInput").value;
  const masterPassword = store.settings.masterPassword;
  const ok = inputPassword === masterPassword;
  
  if(!ok){ 
    $("passErr").classList.remove("hidden"); 
    return; 
  }
  closePass(true);
}

function closePass(ok){
  $("passModal").classList.remove("show");
  if(_passResolve){ _passResolve(!!ok); _passResolve=null; }
}

/* ========= Backup & Restore System ========= */
function backupData() {
  if (!currentUser || !ROLE_PERMISSIONS[currentUser.role].includes('backup')) {
    alert('Anda tidak memiliki izin untuk backup data.');
    return;
  }
  
  const backupData = {
    version: 'mujur-bikes-v8.0',
    timestamp: new Date().toISOString(),
    data: store,
    user: currentUser.username
  };
  
  const dataStr = JSON.stringify(backupData, null, 2);
  const dataBlob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(dataBlob);
  
  const a = document.createElement('a');
  a.href = url;
  a.download = `mujur-bikes-backup-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  
  URL.revokeObjectURL(url);
  
  addHistory('backup', { 
    filename: a.download,
    undone: false 
  });
  
  toast('Backup data berhasil!');
}

function restoreData() {
  if (!currentUser || !ROLE_PERMISSIONS[currentUser.role].includes('restore')) {
    alert('Anda tidak memiliki izin untuk restore data.');
    return;
  }
  
  if (!confirm('PERINGATAN: Restore data akan mengganti semua data saat ini. Pastikan Anda sudah backup data terbaru. Lanjutkan?')) {
    return;
  }
  
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  
  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = event => {
      try {
        const backup = JSON.parse(event.target.result);
        
        // Validasi file backup
        if (!backup.data || !backup.data.items) {
          throw new Error('Format file backup tidak valid');
        }
        
        if (backup.version !== 'mujur-bikes-v8.0') {
          if (!confirm('File backup mungkin dari versi yang berbeda. Lanjutkan restore?')) {
            return;
          }
        }
        
        // Ganti data store
        store = backup.data;
        save();
        
        addHistory('restore', {
          filename: file.name,
          timestamp: backup.timestamp,
          undone: false
        });
        
        showSuccess('Data berhasil di-restore! Halaman akan direfresh.');
        setTimeout(() => {
          location.reload();
        }, 2000);
        
      } catch (error) {
        console.error('Restore error:', error);
        alert('Error: File backup tidak valid atau korup.');
      }
    };
    
    reader.readAsText(file);
  };
  
  input.click();
}

function resetData() {
  if (!confirm('Reset akan menghapus semua data dan mengembalikan data demo. Lanjutkan?')) {
    return;
  }
  
  // Hapus semua data
  store = getDefaultStore();
  
  // Tambah data demo
  if(!store.items.length){
    store.items.push({
      id: uid(),
      status: "masuk",
      name: "Centrum 3.0",
      type: "BMX",
      size: '12"',
      supplier: "N/A",
      arrivalDate: "2025-09-20",
      totalQty: 1,
      colors: [{color: "Merah", qty: 1}],
      locations: [{name: "Toko", qty: 1}],
      pack: "Dus",
      image: null,
      assembleLogs: [],
      sellLogs: []
    });
    
    store.items.push({
      id: uid(),
      status: "dirakit",
      name: "Velion 3.0",
      type: "BMX",
      size: '20"',
      supplier: "VL",
      arrivalDate: "2025-09-14",
      totalQty: 2,
      colors: [],
      locations: [{name: "Toko", qty: 2}],
      pack: "Dus",
      image: null,
      assembleLogs: [{date: "2025-09-22", qty: 1, employee: "VL"}],
      sellLogs: []
    });
  }
  
  save();
  showSuccess('Data berhasil direset ke data demo!');
  setTimeout(() => {
    location.reload();
  }, 2000);
}

/* ========= Stock Notification System ========= */
function checkStockNotifications() {
  const lowStockItems = store.items.filter(i => 
    i.status === "masuk" && Number(i.totalQty || 0) <= 2 && Number(i.totalQty || 0) > 0
  );
  
  const zeroStockItems = store.items.filter(i => 
    i.status === "masuk" && Number(i.totalQty || 0) === 0
  );
  
  const criticalItems = store.items.filter(i => 
    i.status === "masuk" && Number(i.totalQty || 0) <= 1
  );
  
  let notifications = [];
  
  if (criticalItems.length > 0) {
    notifications.push({
      type: 'critical',
      message: ` ${criticalItems.length} item stok kritis (≤ 1 unit)`,
      items: criticalItems
    });
  }
  
  if (lowStockItems.length > 0 && criticalItems.length === 0) {
    notifications.push({
      type: 'warning',
      message: ` ${lowStockItems.length} item stok menipis (≤ 2 unit)`,
      items: lowStockItems
    });
  }
  
  if (zeroStockItems.length > 0) {
    notifications.push({
      type: 'info',
      message: ` ${zeroStockItems.length} item stok habis`,
      items: zeroStockItems
    });
  }
  
  showNotifications(notifications);
}

function showNotifications(notifications) {
  const panel = $('#notificationPanel');
  const list = $('#notificationList');
  
  if (notifications.length === 0) {
    panel.classList.add('hidden');
    return;
  }
  
  panel.classList.remove('hidden');
  
  let html = '';
  notifications.forEach(notif => {
    html += `<div class="notification-item" data-type="${notif.type}">
      <strong>${notif.message}</strong>`;
    
    // Tampilkan 3 item pertama
    notif.items.slice(0, 3).forEach(item => {
      html += `<div class="small" style="margin-top: 4px;">• ${item.name} (${item.type} - ${item.size}): ${item.totalQty} unit</div>`;
    });
    
    if (notif.items.length > 3) {
      html += `<div class="small" style="margin-top: 4px;">... dan ${notif.items.length - 3} item lainnya</div>`;
    }
    
    html += `</div>`;
  });
  
  list.innerHTML = html;
}

function closeNotifications() {
  $('#notificationPanel').classList.add('hidden');
}

/* ========= Dashboard ========= */
function renderDashboard() {
  const masuk = store.items.filter(i => i.status === "masuk").length;
  const dirakit = store.items.filter(i => i.status === "dirakit").length;
  const terjual = store.items.filter(i => i.status === "terjual").length;
  const lowStock = store.items.filter(i => i.status === "masuk" && Number(i.totalQty||0) <= 2).length;
  
  // Hitung total tipe sepeda (unik berdasarkan nama+tipe+ukuran)
  const uniqueBikes = new Set();
  store.items.forEach(item => {
    const key = `${item.name}-${item.type}-${item.size}`;
    uniqueBikes.add(key);
  });
  const totalTipe = uniqueBikes.size;
  
  // Hitung total unit sepeda (sum dari semua quantity)
  const totalUnit = store.items.reduce((sum, item) => sum + Number(item.totalQty || 0), 0);
  
  // Hitung statistik tambahan untuk charts
  const totalMasukQty = store.items
    .filter(i => i.status === "masuk")
    .reduce((sum, item) => sum + Number(item.totalQty || 0), 0);
  
  const totalDirakitQty = store.items
    .filter(i => i.status === "dirakit")
    .reduce((sum, item) => sum + Number(item.totalQty || 0), 0);
  
  const totalTerjualQty = store.items
    .filter(i => i.status === "terjual")
    .reduce((sum, item) => sum + Number(item.totalQty || 0), 0);
  
  const maxQty = Math.max(totalMasukQty, totalDirakitQty, totalTerjualQty, 1);
  
  $("dashboardCards").innerHTML = `
    <div class="dashboard-card">
      <div class="dashboard-label">Total Tipe Sepeda</div>
      <div class="dashboard-value">${totalTipe}</div>
    </div>
    <div class="dashboard-card">
      <div class="dashboard-label">Total Unit Sepeda</div>
      <div class="dashboard-value">${totalUnit}</div>
    </div>
    <div class="dashboard-card">
      <div class="dashboard-label">Belum Rakit</div>
      <div class="dashboard-value">${masuk}</div>
    </div>
    <div class="dashboard-card">
      <div class="dashboard-label">Sudah Rakit</div>
      <div class="dashboard-value">${dirakit}</div>
    </div>
    <div class="dashboard-card">
      <div class="dashboard-label">Terjual</div>
      <div class="dashboard-value">${terjual}</div>
    </div>
    <div class="dashboard-card">
      <div class="dashboard-label">Stok Menipis</div>
      <div class="dashboard-value ${lowStock > 0 ? 'red' : ''}">${lowStock}</div>
    </div>
  `;
  
  // Render charts
  renderDashboardCharts(totalMasukQty, totalDirakitQty, totalTerjualQty, maxQty);
}

function renderDashboardCharts(totalMasukQty, totalDirakitQty, totalTerjualQty, maxQty) {
  const chartWidth = 300; // Max width for bars
  
  const masukWidth = (totalMasukQty / maxQty) * chartWidth;
  const dirakitWidth = (totalDirakitQty / maxQty) * chartWidth;
  const terjualWidth = (totalTerjualQty / maxQty) * chartWidth;
  
  $("dashboardCharts").innerHTML = `
    <div class="chart-container">
      <h3>Distribusi Stok</h3>
      <div class="chart-row">
        <div class="chart-label">Belum Rakit</div>
        <div class="chart-bar" style="width: ${masukWidth}px; background: var(--pri);">${totalMasukQty}</div>
        <div class="chart-value">${totalMasukQty} unit</div>
      </div>
      <div class="chart-row">
        <div class="chart-label">Sudah Rakit</div>
        <div class="chart-bar" style="width: ${dirakitWidth}px; background: var(--amber);">${totalDirakitQty}</div>
        <div class="chart-value">${totalDirakitQty} unit</div>
      </div>
      <div class="chart-row">
        <div class="chart-label">Terjual</div>
        <div class="chart-bar" style="width: ${terjualWidth}px; background: var(--green);">${totalTerjualQty}</div>
        <div class="chart-value">${totalTerjualQty} unit</div>
      </div>
    </div>
    
    <div class="chart-container">
      <h3>Trend Bulan Ini</h3>
      <div class="small" style="text-align: center; color: var(--muted); padding: 20px;">
        Data real-time akan ditampilkan di sini<br>
        <span class="real-time-indicator"></span> Terhubung ke sistem real-time
      </div>
    </div>
  `;
}

/* ========= Modal Tanggal N/A (custom, tanpa OK/Cancel) ========= */
function openNAModal(inputId, title="Informasi Tanggal"){
  _naTarget=$(inputId);
  $("naTitle").textContent = title;
  showModal("naModal");
}
$("naYes").onclick=()=>{ // pilih tanggal
  closeModal("naModal");
  if(!_naTarget) return;
  _naTarget.dataset.na=""; // hapus N/A
  if(_naTarget.showPicker){ _naTarget.showPicker(); }
};
$("naNo").onclick=()=>{ // set N/A
  closeModal("naModal");
  if(!_naTarget) return;
  _naTarget.value=""; _naTarget.dataset.na="1";
};

/* ========= Router ========= */
document.querySelectorAll("#tabs .tab").forEach(b=>{
  b.onclick=async ()=>{
    const r=b.dataset.route;
    
    // Check if user is logged in
    if (!currentUser) {
      showModal('loginModal');
      return;
    }
    
    // Check permissions for specific routes
    if (r === 'master' && !ROLE_PERMISSIONS[currentUser.role].includes('master')) {
      toast('Anda tidak memiliki akses ke Data Master');
      return;
    }
    
    if (r === 'laporan' && !ROLE_PERMISSIONS[currentUser.role].includes('reports')) {
      toast('Anda tidak memiliki akses ke Laporan');
      return;
    }
    
    if(r==="master" || r==="laporan"){
      const ok=await askPass(`Masukkan password untuk ${r==="master"?"Data Master":"Laporan"}:`);
      if(!ok){ return; }
    }
    setRoute(r);
  };
});
function setRoute(r){
  // Check if user is logged in
  if (!currentUser) {
    showModal('loginModal');
    return;
  }
  
  // Check permissions for specific routes
  if (r === 'master' && !ROLE_PERMISSIONS[currentUser.role].includes('master')) {
    toast('Anda tidak memiliki akses ke Data Master');
    return;
  }
  
  if (r === 'laporan' && !ROLE_PERMISSIONS[currentUser.role].includes('reports')) {
    toast('Anda tidak memiliki akses ke Laporan');
    return;
  }
  
  route=r; multi=false; selectedIds.clear();
  currentPage = 1; // Reset to first page when changing route
  ["btnMulti","btnMassEdit","btnMassDelete","btnMassCancel"].forEach(id=>$(id).classList.add("hidden"));
  $("btnMulti").classList.toggle("hidden", r !== "masuk" && r !== "low");
  
  document.querySelectorAll("#tabs .tab").forEach(b=>b.classList.toggle("active",b.dataset.route===r));
  
  // Show/hide pages
  $("pageDashboard").classList.toggle("hidden", r !== "dashboard");
  $("pageList").classList.toggle("hidden", r === "master" || r === "dashboard" || r === "laporan");
  $("pageMaster").classList.toggle("hidden", r !== "master");
  $("pageLaporan").classList.toggle("hidden", r !== "laporan");
  
  if(r==="master"){ 
    renderMaster(); 
  } else if(r==="dashboard") {
    renderDashboard();
  } else if(r==="laporan") {
    renderLaporan();
  } else { 
    renderList(); 
  }
}

/* ========= Render Guard (jaga modal detail tidak hilang) ========= */
function guardedRender(){
  const detailOpen=$("detailModal").classList.contains("show");
  const ctx=_detailCtx ? {..._detailCtx} : null;
  
  // Render sesuai route aktif
  if(route === "master") {
    renderMaster();
  } else if(route === "dashboard") {
    renderDashboard();
  } else if(route === "laporan") {
    renderLaporan();
  } else {
    renderList();
  }
  
  // Jika detail modal terbuka, buka kembali dengan data terbaru
  if(detailOpen && ctx){
    let target=null, idx=-1;
    if(ctx.route==="dirakit"||ctx.route==="terjual"){
      for(let i=0;i<currentList.length;i++){
        const it=currentList[i];
        const key=`${it.name}|${it.type}|${it.size}`;
        if(key===ctx.key){ target=it; idx=i; break; }
      }
    } else {
      for(let i=0;i<currentList.length;i++){
        if(currentList[i].id===ctx.id){ target=currentList[i]; idx=i; break; }
      }
    }
    if(target) {
      openDetail(target,idx);
    } else {
      // Jika item tidak ditemukan (mungkin dihapus), tutup modal
      closeModal("detailModal");
    }
  }
}

/* ========= Render ========= */
function render(){ 
  if(route==="master"){ 
    renderMaster();
  } else if(route==="dashboard") {
    renderDashboard();
  } else if(route==="laporan") {
    renderLaporan();
  } else { 
    renderList(); 
  }
}

function renderList(){
  const titles={masuk:"Belum Rakit",dirakit:"Sudah Rakit",terjual:"Terjual",low:"Stok Kurang"};
  $("tabTitle").textContent=titles[route];
  $("btnAdd").classList.toggle("hidden",route!=="masuk");
  $("btnAddAsm").classList.toggle("hidden",route!=="dirakit");
  $("btnAddSell").classList.toggle("hidden",route!=="terjual");

  // Reminder stok kurang (masuk)
  const low=store.items.filter(i=>i.status==="masuk"&&Number(i.totalQty||0)<=2);
  if(route!=="master" && route!=="laporan" && low.length){ 
    $("lowReminder").innerHTML=`Ada unit sepeda dengan stok yang sudah menipis. <a href="#" onclick="setRoute('low');return false;">Klik di sini</a> untuk melihat.`; 
    $("lowReminder").classList.remove("hidden"); 
  } else {
    $("lowReminder").classList.add("hidden"); 
  }

  let arr=[];
  if(route==="low") {
    arr=store.items.filter(i=>i.status==="masuk"&&Number(i.totalQty||0)<=2);
  } else if(route==="dirakit"){
    const map=new Map();
    store.items.filter(i=>i.status==="dirakit").forEach(i=>{
      const key=`${i.name}|${i.type}|${i.size}`;
      if(!map.has(key)) {
        map.set(key,{
          ...i,
          groupIds:[i.id],
          totalQty:Number(i.totalQty||0),
          assembleLogs:[...(i.assembleLogs||[])]
        });
      } else {
        const g=map.get(key);
        g.groupIds.push(i.id);
        g.totalQty+=Number(i.totalQty||0);
        g.assembleLogs.push(...(i.assembleLogs||[])); 
        if(!g.image&&i.image) g.image=i.image;
      }
    });
    arr=[...map.values()];
  } else {
    arr=store.items.filter(i=>i.status===route);
  }

  currentList=arr;

  const q=($("searchBox").value||"").toLowerCase();
  arr=arr.filter(i=>{
    const code=genCode(i.supplier,i.arrivalDate)||"";
    return `${i.name} ${i.type} ${i.size} ${i.supplier||""} ${code}`.toLowerCase().includes(q);
  });

  const asc=$("sortDir").dataset.desc!=="1", key=$("sortKey").value;
  arr.sort((a,b)=>{
    let va=a[key], vb=b[key];
    if(key==="totalQty"){
      va=Number(va)||0;
      vb=Number(vb)||0;
      return asc?va-vb:vb-va;
    }
    va=(va||"").toString(); 
    vb=(vb||"").toString();
    return asc?va.localeCompare(vb):vb.localeCompare(va);
  });

  // Pagination calculation
  const totalItems = arr.length;
  const totalPages = Math.ceil(totalItems / itemsPerPage);
  
  // Validasi currentPage
  if (currentPage > totalPages && totalPages > 0) {
    currentPage = totalPages;
  }
  if (currentPage < 1) {
    currentPage = 1;
  }
  
  const startIndex = (currentPage - 1) * itemsPerPage;
  const paginatedItems = arr.slice(startIndex, startIndex + itemsPerPage);

  const list=$("list"); 
  list.innerHTML="";
  
  paginatedItems.forEach((it,idx)=>{
    const globalIndex = startIndex + idx;
    const qty=Number(it.totalQty||0);
    const card=document.createElement("div"); 
    card.className="item";
    
    if((route==="masuk"||route==="low")){ 
      if(qty===0) card.classList.add("zero"); 
      else if(qty<3) card.classList.add("low"); 
    }

    // kanan: checkbox (mode multi)
    const right=document.createElement("div");
    right.className="checkwrap";
    
    if(multi){
      const cb=document.createElement("input"); 
      cb.type="checkbox";
      cb.checked = selectedIds.has(it.id);
      cb.onclick=(e)=>{ 
        e.stopPropagation(); 
        if(cb.checked) {
          selectedIds.add(it.id);
        } else {
          selectedIds.delete(it.id);
        } 
      };
      right.appendChild(cb);
      
      // MODE MULTI: klik kartu = toggle centang, TIDAK buka detail
      card.onclick=(e)=>{ 
        if(e.target!==cb){ 
          cb.checked=!cb.checked; 
          if(cb.checked) {
            selectedIds.add(it.id);
          } else {
            selectedIds.delete(it.id);
          }
        } 
      };
    } else {
      card.onclick=()=>openDetail(it,globalIndex);
    }

    const img=it.image?`<img src="${it.image}">`:`<span class="small">Tanpa Gambar</span>`;
    const code=genCode(it.supplier,it.arrivalDate)||"-";
    const meta= route==="masuk"? `Tgl Datang: ${it.arrivalDate||"N/A"} • Stok: ${qty}`:
                route==="dirakit"? `Tersedia: ${qty} • Log rakit: ${(it.assembleLogs||[]).length}`:
                route==="terjual"? `Total terjual: ${(it.sellLogs||[]).reduce((s,a)=>s+Number(a.qty||0),0)}`:`Stok: ${qty}`;

    card.innerHTML=`
      <div class="thumb">${img}</div>
      <div>
        <div class="name">${it.name}</div>
        <div class="sub">${it.type||"-"} • ${it.size||"-"}</div>
        <div class="meta">ID: ${code} • Supplier: ${it.supplier||"N/A"} • Kemasan: ${it.pack||"-"}</div>
        <div class="meta mt8">${meta}</div>
      </div>`;
    card.appendChild(right);
    list.appendChild(card);
  });

  // Add pagination controls
  addPaginationControls(totalItems, totalPages, 'list');
}

function addPaginationControls(totalItems, totalPages, type) {
  // Remove existing pagination if any
  const existingPagination = $(`${type}Pagination`);
  if (existingPagination) {
    existingPagination.remove();
  }

  if (totalPages <= 1 && totalItems <= itemsPerPage) {
    return;
  }

  const pagination = document.createElement('div');
  pagination.id = `${type}Pagination`;
  pagination.className = 'pagination';

  const startItem = ((currentPage - 1) * itemsPerPage) + 1;
  const endItem = Math.min(currentPage * itemsPerPage, totalItems);

  pagination.innerHTML = `
    <div class="pagination-info">Menampilkan ${startItem}-${endItem} dari ${totalItems} item</div>
    <div class="page-size">
      <label>Item per halaman:</label>
      <select onchange="changeItemsPerPage(this.value, '${type}')">
        <option value="10" ${itemsPerPage === 10 ? 'selected' : ''}>10</option>
        <option value="25" ${itemsPerPage === 25 ? 'selected' : ''}>25</option>
        <option value="50" ${itemsPerPage === 50 ? 'selected' : ''}>50</option>
      </select>
    </div>
    <button onclick="goToPage(1, '${type}')" ${currentPage === 1 ? 'disabled' : ''}>◀◀</button>
    <button onclick="goToPage(${currentPage - 1}, '${type}')" ${currentPage === 1 ? 'disabled' : ''}>◀</button>
    <span style="padding: 0 10px;">Halaman ${currentPage} dari ${totalPages}</span>
    <button onclick="goToPage(${currentPage + 1}, '${type}')" ${currentPage === totalPages ? 'disabled' : ''}>▶</button>
    <button onclick="goToPage(${totalPages}, '${type}')" ${currentPage === totalPages ? 'disabled' : ''}>▶▶</button>
  `;

  const container = type === 'history' ? $('hisTable').parentNode : $('list');
  container.parentNode.insertBefore(pagination, container.nextSibling);
}

function changeItemsPerPage(value, type) {
  itemsPerPage = parseInt(value);
  currentPage = 1;
  renderList();
}

function goToPage(page, type) {
  currentPage = page;
  renderList();
}

/* ========= Multi select & Mass edit/delete ========= */
$("btnMulti").onclick=()=>{
  multi=true;
  $("btnMulti").classList.add("hidden");
  $("btnMassEdit").classList.remove("hidden");
  $("btnMassDelete").classList.remove("hidden");
  $("btnMassCancel").classList.remove("hidden");
  renderList();
};

$("btnMassCancel").onclick=()=>{
  multi=false;
  selectedIds.clear();
  $("btnMulti").classList.remove("hidden");
  $("btnMassEdit").classList.add("hidden");
  $("btnMassDelete").classList.add("hidden");
  $("btnMassCancel").classList.add("hidden");
  renderList();
};

$("btnMassDelete").onclick=async ()=>{
  if(!selectedIds.size) {
    return alert("Pilih item dulu.");
  }
  
  // Check delete permission
  if (!ROLE_PERMISSIONS[currentUser.role].includes('delete')) {
    toast('Anda tidak memiliki izin untuk menghapus item');
    return;
  }
  
  const ok=await askPass("Masukkan password:");
  if(!ok) return;
  
  if(!confirm("Hapus item terpilih?")) return;
  
  const removed=[];
  store.items=store.items.filter(i=>{ 
    if(selectedIds.has(i.id)) {
      removed.push(i); 
      return false;
    } 
    return true; 
  });
  
  addHistory('hapus',{qty:removed.length}, {type:"restore-items", payload:removed});
  selectedIds.clear(); 
  
  // Reset ke halaman 1 setelah hapus massal
  currentPage = 1;
  save(); 
  showSuccess("Item terpilih berhasil dihapus");
};

$("btnMassEdit").onclick=()=>{ 
  if(!selectedIds.size) return alert("Pilih item dulu."); 
  buildMasterOptionsMass(); 
  showModal("massEditModal"); 
};

function buildMasterOptionsMass(){
  $("meSup").innerHTML=`<option value="">(kosong)</option>`+store.suppliers.map(s=>`<option>${s}</option>`).join("");
  $("meType").innerHTML=`<option value="">(kosong)</option>`+store.types.map(s=>`<option>${s}</option>`).join("");
  $("meSize").innerHTML=`<option value="">(kosong)</option>`+store.sizes.map(s=>`<option>${s}</option>`).join("");
  $("mePack").innerHTML=`<option value="">(kosong)</option>`+store.packs.map(s=>`<option>${s}</option>`).join("");
}

$("meApply").onclick=async ()=>{ 
  const ok=await askPass("Masukkan password:"); 
  if(!ok) return; 
  
  const sup=$("meSup").value,
        type=$("meType").value,
        size=$("meSize").value,
        pack=$("mePack").value;
        
  store.items.forEach(i=>{ 
    if(selectedIds.has(i.id)){ 
      if(sup) i.supplier=sup; 
      if(type) i.type=type; 
      if(size) i.size=size; 
      if(pack) i.pack=pack; 
      i.code=genCode(i.supplier,i.arrivalDate); 
    } 
  });
  
  closeModal("massEditModal"); 
  $("btnMassCancel").onclick(); 
  save(); 
  showSuccess("Perubahan massal berhasil diterapkan");
};

/* ========= Add/Edit Item ========= */
$("btnAdd").onclick=()=>openAdd();

function openAdd(){
  editingId=null; 
  buildMasterOptions(); 
  fillNameSuggest();
  $("addTitle").textContent="Tambah Item";
  ["fName","fQty"].forEach(id=>$(id).value="");
  ["fSup","fType","fSize","fPack","fStatus","fAsmEmp"].forEach(id=>$(id).value="");
  ["fArrive","fAsmDate"].forEach(id=>{ $(id).value=""; $(id).dataset.na=""; });
  $("asmRow").classList.add("hidden");
  $("colorWrap").innerHTML=""; 
  $("locWrap").innerHTML=""; 
  addLocRow(); // minimal 1 baris lokasi
  $("fImg").value="";
  bindBtnSaveOnce(saveNewItem);
  showModal("addModal");
}

function bindBtnSaveOnce(handler){
  const btn=$("btnSave");
  const clone=btn.cloneNode(true);
  btn.parentNode.replaceChild(clone,btn);
  clone.id="btnSave";
  clone.onclick=handler;
}

function buildMasterOptions(){
  $("fSup").innerHTML=`<option value="">-- pilih --</option>`+store.suppliers.map(s=>`<option>${s}</option>`).join("");
  $("fType").innerHTML=`<option value="">-- pilih --</option>`+store.types.map(s=>`<option>${s}</option>`).join("");
  $("fSize").innerHTML=`<option value="">-- pilih --</option>`+store.sizes.map(s=>`<option>${s}</option>`).join("");
  $("fPack").innerHTML=`<option value="">-- pilih --</option>`+store.packs.map(s=>`<option>${s}</option>`).join("");
  $("fAsmEmp").innerHTML=`<option value="">-- pilih / N/A --</option>`+store.employees.map(s=>`<option>${s}</option>`).join("");
}

function fillNameSuggest(){
  const box=$("fName"), list=$("acList");
  const names=[...new Set(store.items.map(i=>i.name))].sort();
  
  function show(){
    const q=(box.value||"").toLowerCase().trim();
    if(q.length<2){ 
      list.style.display="none"; 
      return; 
    }
    
    const cand=names.filter(n=>n.toLowerCase().includes(q)).slice(0,15);
    if(!cand.length){ 
      list.style.display="none"; 
      return; 
    }
    
    list.innerHTML=cand.map(n=>`<div class="ac-item">${n}</div>`).join("");
    list.style.display="block";
    
    list.querySelectorAll(".ac-item").forEach(div=>{
      div.onclick=()=>{ 
        box.value=div.textContent; 
        list.style.display="none"; 
        box.focus(); 
        box.setSelectionRange(box.value.length,box.value.length); 
      };
    });
  }
  
  box.oninput=show; 
  box.onfocus=show; 
  box.onblur=()=>setTimeout(()=>list.style.display="none",120);
}

$("fStatus").onchange=()=>{
  $("asmRow").classList.toggle("hidden",$("fStatus").value!=="dirakit");
};

function addColorRow(c="",q=""){
  const row=document.createElement("div"); 
  row.className="row mt8"; 
  row.innerHTML=`
    <input class="input" placeholder="Warna" value="${c}">
    <input type="number" class="input" placeholder="Jumlah" min="0" value="${q}" style="width:100px">
    <button class="btn ghost small" onclick="this.parentNode.remove()">✕</button>
  `;
  $("colorWrap").appendChild(row);
}

function addLocRow(loc="",q=""){
  const row=document.createElement("div"); 
  row.className="row mt8"; 
  row.innerHTML=`
    <select class="input">${store.locations.map(l=>`<option ${l===loc?"selected":""}>${l}</option>`).join("")}</select>
    <input type="number" class="input" placeholder="Jumlah" min="0" value="${q}" style="width:100px">
    <button class="btn ghost small" onclick="this.parentNode.remove()">✕</button>
  `;
  $("locWrap").appendChild(row);
}

function guardAllLocToQty(){
  const totalLocQty=Array.from($("locWrap").children).reduce((sum,row)=>sum+(parseInt(row.querySelector("input").value)||0),0);
  const totalQty=parseInt($("fQty").value)||1;
  if(totalLocQty>totalQty){
    const delta=totalLocQty-totalQty;
    $("fQty").value=totalLocQty;
    toast(`Jumlah lokasi disesuaikan (+${delta})`);
  }
}

function saveNewItem(){
  const name=($("fName").value||"").trim();
  const supplier=$("fSup").value;
  const type=$("fType").value;
  const size=$("fSize").value;
  const pack=$("fPack").value;
  const status=$("fStatus").value;
  const totalQty=parseInt($("fQty").value)||0;
  
  if(!name||!supplier||!type||!size||!pack||!status||!totalQty){
    return alert("Isi semua field wajib.");
  }

  // Validasi jumlah lokasi = totalQty
  const locs=Array.from($("locWrap").children).map(row=>{
    const loc=row.querySelector("select").value;
    const qty=parseInt(row.querySelector("input").value)||0;
    return {name:loc,qty:qty};
  }).filter(x=>x.name&&x.qty>0);
  
  const totalLocQty=locs.reduce((sum,x)=>sum+x.qty,0);
  if(totalLocQty!==totalQty){
    return alert(`Total kuantitas lokasi (${totalLocQty}) harus sama dengan jumlah unit total (${totalQty}).`);
  }

  const colors=Array.from($("colorWrap").children).map(row=>{
    const color=(row.querySelector("input").value||"").trim();
    const qty=parseInt(row.querySelectorAll("input")[1].value)||0;
    return {color,qty};
  }).filter(x=>x.color&&x.qty>0);
  
  const totalColorQty=colors.reduce((sum,x)=>sum+x.qty,0);
  if(totalColorQty>totalQty){
    return alert(`Total kuantitas warna (${totalColorQty}) tidak boleh lebih dari jumlah unit total (${totalQty}).`);
  }

  const arrivalDate=$("fArrive").dataset.na?"N/A":($("fArrive").value||"N/A");
  const asmDate=$("fAsmDate").dataset.na?"N/A":($("fAsmDate").value||"N/A");
  const asmEmp=$("fAsmEmp").value||"N/A";

  const imgFile=$("fImg").files[0];
  const imgPromise=imgFile?readFileAsDataURL(imgFile):Promise.resolve(null);

  imgPromise.then(image=>{
    const item={
      id:editingId||uid(),
      status,
      name,
      type,
      size,
      supplier,
      arrivalDate,
      totalQty,
      colors,
      locations:locs,
      pack,
      image,
      assembleLogs:[],
      sellLogs:[]
    };

    if(status==="dirakit"){
      item.assembleLogs.push({
        date:asmDate,
        qty:totalQty,
        employee:asmEmp,
        colors:colors.length?chips(colors):null
      });
    }

    if(editingId){
      const idx=store.items.findIndex(i=>i.id===editingId);
      if(idx!==-1){ 
        const old=store.items[idx];
        item.assembleLogs=old.assembleLogs||[]; 
        item.sellLogs=old.sellLogs||[];
        store.items[idx]=item; 
        addHistory('edit',{name,type,size}, {type:"restore-item",payload:old});
      }
    } else {
      store.items.push(item);
      addHistory('unit-baru',{name,type,size,qty:totalQty});
    }

    closeModal("addModal");
    save();
    showSuccess(editingId?"Item berhasil diedit":"Item berhasil ditambahkan");
  });
}

function readFileAsDataURL(file){
  return new Promise((resolve,reject)=>{
    const reader=new FileReader();
    reader.onload=e=>resolve(e.target.result);
    reader.onerror=reject;
    reader.readAsDataURL(file);
  });
}

/* ========= Add Sudah Rakit ========= */
$("btnAddAsm").onclick=()=>{
  asmPick="add";
  $("asmList").innerHTML="";
  store.items.filter(i=>i.status==="masuk").forEach(it=>{
    const card=document.createElement("div"); 
    card.className="item"; 
    card.onclick=()=>openAsmDetail(it);
    const img=it.image?`<img src="${it.image}">`:`<span class="small">Tanpa Gambar</span>`;
    card.innerHTML=`
      <div class="thumb">${img}</div>
      <div>
        <div class="name">${it.name}</div>
        <div class="sub">${it.type||"-"} • ${it.size||"-"}</div>
        <div class="meta">Stok: ${it.totalQty||0}</div>
      </div>`;
    $("asmList").appendChild(card);
  });
  $("asmSearch").oninput=()=>{
    const q=$("asmSearch").value.toLowerCase();
    Array.from($("asmList").children).forEach(c=>{
      const txt=c.querySelector(".name").textContent.toLowerCase();
      c.classList.toggle("hidden",!txt.includes(q));
    });
  };
  showModal("asmModal");
};

function openAsmDetail(item){
  $("asmHeader").innerHTML=`${item.name} (${item.type}, ${item.size}) - Stok: ${item.totalQty||0}`;
  $("adQty").value="1";
  $("adColor").value=chips(item.colors);
  $("adDate").value=new Date().toISOString().slice(0,10);
  $("adEmp").value="N/A";
  $("adEmp").innerHTML=`<option value="">-- pilih / N/A --</option>`+store.employees.map(s=>`<option>${s}</option>`).join("");
  bindBtnSaveAsmOnce(()=>saveAsm(item));
  showModal("asmDetailModal");
}

function bindBtnSaveAsmOnce(handler){
  const btn=$("adSave");
  const clone=btn.cloneNode(true);
  btn.parentNode.replaceChild(clone,btn);
  clone.id="adSave";
  clone.onclick=handler;
}

function clampToStock(el,type){
  const max=type==="asm"?asmPick.maxStock:type==="sell"?sellPick.maxStock:999;
  let v=parseInt(el.value)||0;
  if(v<1) v=1;
  if(v>max) v=max;
  el.value=v;
}

function stepLocal(id,type,delta){
  const el=$(id);
  let v=parseInt(el.value)||0;
  v+=delta;
  clampToStock(el,type);
}

function saveAsm(item){
  const qty=parseInt($("adQty").value)||0;
  const color=($("adColor").value||"").trim();
  const date=$("adDate").dataset.na?"N/A":($("adDate").value||"N/A");
  const emp=$("adEmp").value||"N/A";

  if(qty<1) return alert("Jumlah minimal 1.");
  if(qty>Number(item.totalQty||0)) return alert("Jumlah melebihi stok.");
  if(!emp) return alert("Pilih pegawai.");

  // Kurangi stok item lama
  item.totalQty=Number(item.totalQty||0)-qty;

  // Buat item baru (sudah rakit)
  const newItem={
    id:uid(),
    status:"dirakit",
    name:item.name,
    type:item.type,
    size:item.size,
    supplier:item.supplier,
    arrivalDate:item.arrivalDate,
    totalQty:qty,
    colors:color?color.split(";").map(p=>{
      const [c,q]=p.split(":").map(x=>x.trim());
      return {color:c,qty:parseInt(q)||1};
    }).filter(x=>x.color):[],
    locations:item.locations?[...item.locations]:[{name:"Toko",qty:qty}],
    pack:item.pack,
    image:item.image,
    assembleLogs:[{
      date,
      qty,
      employee:emp,
      colors:color||null
    }],
    sellLogs:[]
  };

  store.items.push(newItem);
  
  addHistory('perubahan-status',{
    name:item.name,
    type:item.type,
    size:item.size,
    dari:"masuk",
    ke:"dirakit",
    qty:qty
  }, {type:"reverse-status",payload:{itemId:newItem.id,from:"dirakit",to:"masuk",qty:qty}});

  closeModal("asmDetailModal"); 
  closeModal("asmModal"); 
  save(); 
  showSuccess("Status berhasil diubah menjadi Sudah Rakit");
}

/* ========= Add Terjual ========= */
$("btnAddSell").onclick=()=>{
  sellPick="add";
  $("sellList").innerHTML="";
  store.items.filter(i=>i.status==="dirakit").forEach(it=>{
    const card=document.createElement("div"); 
    card.className="item"; 
    card.onclick=()=>openSellDetail(it);
    const img=it.image?`<img src="${it.image}">`:`<span class="small">Tanpa Gambar</span>`;
    card.innerHTML=`
      <div class="thumb">${img}</div>
      <div>
        <div class="name">${it.name}</div>
        <div class="sub">${it.type||"-"} • ${it.size||"-"}</div>
        <div class="meta">Stok: ${it.totalQty||0}</div>
      </div>`;
    $("sellList").appendChild(card);
  });
  $("sellSearch").oninput=()=>{
    const q=$("sellSearch").value.toLowerCase();
    Array.from($("sellList").children).forEach(c=>{
      const txt=c.querySelector(".name").textContent.toLowerCase();
      c.classList.toggle("hidden",!txt.includes(q));
    });
  };
  showModal("sellModal");
};

function openSellDetail(item){
  $("sellHeader").innerHTML=`${item.name} (${item.type}, ${item.size}) - Stok: ${item.totalQty||0}`;
  $("sdQty").value="1";
  $("sdColor").value="";
  $("sdDate").value=new Date().toISOString().slice(0,10);
  bindBtnSaveSellOnce(()=>saveSell(item));
  showModal("sellDetailModal");
}

function bindBtnSaveSellOnce(handler){
  const btn=$("sdSave");
  const clone=btn.cloneNode(true);
  btn.parentNode.replaceChild(clone,btn);
  clone.id="sdSave";
  clone.onclick=handler;
}

function saveSell(item){
  const qty=parseInt($("sdQty").value)||0;
  const color=($("sdColor").value||"").trim();
  const date=$("sdDate").value||"";

  if(qty<1) return alert("Jumlah minimal 1.");
  if(qty>Number(item.totalQty||0)) return alert("Jumlah melebihi stok.");
  if(!date) return alert("Isi tanggal terjual.");

  // Kurangi stok item lama
  item.totalQty=Number(item.totalQty||0)-qty;

  // Buat item baru (terjual)
  const newItem={
    id:uid(),
    status:"terjual",
    name:item.name,
    type:item.type,
    size:item.size,
    supplier:item.supplier,
    arrivalDate:item.arrivalDate,
    totalQty:qty,
    colors:color?color.split(";").map(p=>{
      const [c,q]=p.split(":").map(x=>x.trim());
      return {color:c,qty:parseInt(q)||1};
    }).filter(x=>x.color):[],
    locations:item.locations?[...item.locations]:[{name:"Toko",qty:qty}],
    pack:item.pack,
    image:item.image,
    assembleLogs:item.assembleLogs||[],
    sellLogs:[{
      date,
      qty,
      colors:color||null
    }]
  };

  store.items.push(newItem);
  
  addHistory('perubahan-status',{
    name:item.name,
    type:item.type,
    size:item.size,
    dari:"dirakit",
    ke:"terjual",
    qty:qty
  }, {type:"reverse-status",payload:{itemId:newItem.id,from:"terjual",to:"dirakit",qty:qty}});

  closeModal("sellDetailModal"); 
  closeModal("sellModal"); 
  save(); 
  showSuccess("Status berhasil diubah menjadi Terjual");
}

/* ========= Detail Item ========= */
function openDetail(item,index){
  currentIndex=index;
  
  // Simpan context untuk re-open
  if(item.groupIds){
    _detailCtx={route,key:`${item.name}|${item.type}|${item.size}`};
  } else {
    _detailCtx={route,id:item.id};
  }

  const body=$("detailBody"); 
  body.innerHTML="";
  
  const img=item.image?`<img src="${item.image}" onclick="zoomImg(this.src)">`:`<span class="small">Tanpa Gambar</span>`;
  const code=genCode(item.supplier,item.arrivalDate)||"-";
  const statusText=item.status==="masuk"?"Belum Rakit":item.status==="dirakit"?"Sudah Rakit":"Terjual";
  
  body.innerHTML=`
    <div class="detail-img">${img}</div>
    <div class="detail-title">${item.name}</div>
    <div class="detail-sub">${item.type||"-"} • ${item.size||"-"}</div>
    <div class="detail-stock">Status: ${statusText} • Stok: ${item.totalQty||0}</div>
    
    <div class="readLine">Supplier: ${item.supplier||"N/A"}</div>
    <div class="readLine">Kemasan: ${item.pack||"-"}</div>
    <div class="readLine">Tanggal Kedatangan: ${item.arrivalDate||"N/A"}</div>
    <div class="readLine">ID/Kode: ${code}</div>
    
    ${item.colors&&item.colors.length?`<div class="readLine">Warna: ${chips(item.colors)}</div>`:""}
    ${item.locations&&item.locations.length?`<div class="readLine">Lokasi: ${chips(item.locations,"name","qty")}</div>`:""}
    
    ${item.status==="dirakit"||item.status==="terjual"?`
      <div class="section mt16">
        <h4>Log ${item.status==="dirakit"?"Perakitan":"Penjualan"}</h4>
        <table class="table">
          <thead>
            <tr>
              <th>Tanggal</th>
              <th>Jumlah</th>
              ${item.status==="dirakit"?'<th>Pegawai</th>':""}
              ${item.colors&&item.colors.length?'<th>Warna</th>':""}
            </tr>
          </thead>
          <tbody>
            ${(item.status==="dirakit"?item.assembleLogs:item.sellLogs).map(log=>`
              <tr>
                <td>${log.date||"N/A"}</td>
                <td>${log.qty||0}</td>
                ${item.status==="dirakit"?`<td>${log.employee||"N/A"}</td>`:""}
                ${item.colors&&item.colors.length?`<td>${log.colors||"-"}</td>`:""}
              </tr>
            `).join("")}
          </tbody>
        </table>
      </div>
    `:""}
    
    <div class="row mt16" style="justify-content:center">
      <button class="btn" onclick="editItem()">Edit</button>
      <button class="btn ghost" onclick="duplicateItem()">Duplikasi</button>
      <button class="btn red" onclick="deleteItem()">Hapus</button>
      <button class="btn amber" onclick="generateQRCode('${item.id}')">QR Code</button>
      <button class="btn green" onclick="takePhoto('${item.id}')">Ambil Foto</button>
      <button class="btn ghost" onclick="closeModal('detailModal')">Tutup</button>
    </div>
  `;
  
  showModal("detailModal");
}

function editItem(){
  const item=currentList[currentIndex];
  editingId=item.id;
  buildMasterOptions();
  fillNameSuggest();
  
  $("addTitle").textContent="Edit Item";
  $("fName").value=item.name||"";
  $("fSup").value=item.supplier||"";
  $("fType").value=item.type||"";
  $("fSize").value=item.size||"";
  $("fPack").value=item.pack||"";
  $("fStatus").value=item.status;
  $("fQty").value=item.totalQty||"";
  $("fArrive").value=item.arrivalDate==="N/A"?"":item.arrivalDate||"";
  $("fArrive").dataset.na=item.arrivalDate==="N/A"?"1":"";
  
  $("asmRow").classList.toggle("hidden",item.status!=="dirakit");
  if(item.status==="dirakit"&&item.assembleLogs&&item.assembleLogs.length){
    const last=item.assembleLogs[item.assembleLogs.length-1];
    $("fAsmDate").value=last.date==="N/A"?"":last.date||"";
    $("fAsmDate").dataset.na=last.date==="N/A"?"1":"";
    $("fAsmEmp").value=last.employee||"";
  } else {
    $("fAsmDate").value=""; 
    $("fAsmDate").dataset.na="";
    $("fAsmEmp").value="";
  }
  
  $("colorWrap").innerHTML="";
  (item.colors||[]).forEach(c=>addColorRow(c.color,c.qty));
  
  $("locWrap").innerHTML="";
  (item.locations||[]).forEach(l=>addLocRow(l.name,l.qty));
  
  $("fImg").value="";
  
  bindBtnSaveOnce(saveNewItem);
  closeModal("detailModal");
  showModal("addModal");
}

function duplicateItem(){
  const item=currentList[currentIndex];
  editingId=null;
  buildMasterOptions();
  fillNameSuggest();
  
  $("addTitle").textContent="Duplikasi Item";
  $("fName").value=item.name||"";
  $("fSup").value=item.supplier||"";
  $("fType").value=item.type||"";
  $("fSize").value=item.size||"";
  $("fPack").value=item.pack||"";
  $("fStatus").value=item.status;
  $("fQty").value=item.totalQty||"";
  $("fArrive").value="";
  $("fArrive").dataset.na="";
  
  $("asmRow").classList.toggle("hidden",item.status!=="dirakit");
  $("fAsmDate").value=""; 
  $("fAsmDate").dataset.na="";
  $("fAsmEmp").value="";
  
  $("colorWrap").innerHTML="";
  (item.colors||[]).forEach(c=>addColorRow(c.color,c.qty));
  
  $("locWrap").innerHTML="";
  (item.locations||[]).forEach(l=>addLocRow(l.name,l.qty));
  
  $("fImg").value="";
  
  bindBtnSaveOnce(saveNewItem);
  closeModal("detailModal");
  showModal("addModal");
}

function deleteItem(){
  const item=currentList[currentIndex];
  if(!confirm(`Hapus item "${item.name}"?`)) return;
  
  // Check delete permission
  if (!ROLE_PERMISSIONS[currentUser.role].includes('delete')) {
    toast('Anda tidak memiliki izin untuk menghapus item');
    return;
  }
  
  const idx=store.items.findIndex(i=>i.id===item.id);
  if(idx!==-1){
    const removed=store.items.splice(idx,1)[0];
    addHistory('hapus',{name:item.name,type:item.type,size:item.size}, {type:"restore-item",payload:removed});
  }
  
  closeModal("detailModal");
  save();
  showSuccess("Item berhasil dihapus");
}

function zoomImg(src){
  $("zoomBox").style.display="flex";
  $("zoomBox").querySelector("img").src=src;
}

/* ========= Data Master ========= */
function renderMaster(){
  const r=$("masterRead"); 
  r.innerHTML=`
    <div class="grid2">
      <div class="section">
        <h4>Supplier</h4>
        <div id="supList"></div>
      </div>
      <div class="section">
        <h4>Tipe Sepeda</h4>
        <div id="typeList"></div>
      </div>
    </div>
    <div class="grid2">
      <div class="section">
        <h4>Ukuran (inci)</h4>
        <div id="sizeList"></div>
      </div>
      <div class="section">
        <h4>Kemasan</h4>
        <div id="packList"></div>
      </div>
    </div>
    <div class="grid2">
      <div class="section">
        <h4>Lokasi</h4>
        <div id="locList"></div>
      </div>
      <div class="section">
        <h4>Pegawai</h4>
        <div id="empList"></div>
      </div>
    </div>
  `;
  
  renderMasterList("supList",store.suppliers,"supplier");
  renderMasterList("typeList",store.types,"type");
  renderMasterList("sizeList",store.sizes,"size");
  renderMasterList("packList",store.packs,"pack");
  renderMasterList("locList",store.locations,"location");
  renderMasterList("empList",store.employees,"employee");
}

function renderMasterList(id,arr,type){
  const el=$(id);
  el.innerHTML=arr.map(x=>`<div class="chip">${x} <button class="x" onclick="removeMasterItem('${type}','${x}')">✕</button></div>`).join("");
  el.innerHTML+=`<input class="input mt8" placeholder="Tambah ${type}" id="add${type}" style="width:200px">`;
  $(`add${type}`).onkeydown=e=>{
    if(e.key==="Enter"){
      const v=e.target.value.trim();
      if(v&&!arr.includes(v)){
        arr.push(v);
        save();
        renderMaster();
        toast(`${type} "${v}" ditambahkan`);
      }
      e.target.value="";
    }
  };
}

function removeMasterItem(type,val){
  if(!confirm(`Hapus ${type} "${val}"?`)) return;
  
  let arr;
  if(type==="supplier") arr=store.suppliers;
  else if(type==="type") arr=store.types;
  else if(type==="size") arr=store.sizes;
  else if(type==="pack") arr=store.packs;
  else if(type==="location") arr=store.locations;
  else if(type==="employee") arr=store.employees;
  else return;
  
  const idx=arr.indexOf(val);
  if(idx!==-1) arr.splice(idx,1);
  save();
  renderMaster();
  toast(`${type} "${val}" dihapus`);
}

/* ========= Laporan ========= */
function renderLaporan(){
  $("btnPilihLaporan").onclick=()=>{
    $("laporanOptions").classList.toggle("show");
  };
  
  // Set default date range (bulan ini)
  const now=new Date();
  const firstDay=new Date(now.getFullYear(),now.getMonth(),1).toISOString().slice(0,10);
  const lastDay=new Date(now.getFullYear(),now.getMonth()+1,0).toISOString().slice(0,10);
  
  $("reportStartDate").value=firstDay;
  $("reportEndDate").value=lastDay;
  
  renderHistory();
}

function setReportDateRange(range){
  const now=new Date();
  let start,end;
  
  switch(range){
    case "today":
      start=end=now.toISOString().slice(0,10);
      break;
    case "week":
      const day=now.getDay();
      const diff=now.getDate()-day+(day===0?-6:1);
      start=new Date(now.setDate(diff)).toISOString().slice(0,10);
      end=new Date(now.setDate(diff+6)).toISOString().slice(0,10);
      break;
    case "month":
      start=new Date(now.getFullYear(),now.getMonth(),1).toISOString().slice(0,10);
      end=new Date(now.getFullYear(),now.getMonth()+1,0).toISOString().slice(0,10);
      break;
  }
  
  $("reportStartDate").value=start;
  $("reportEndDate").value=end;
}

function generateReport(type){
  const start=$("reportStartDate").value;
  const end=$("reportEndDate").value;
  
  let html=`<h3>Laporan ${type} (${start} s/d ${end})</h3>`;
  
  switch(type){
    case "stok":
      html+=renderStockReport(start,end);
      break;
    case "pergerakan":
      html+=renderMovementReport(start,end);
      break;
    case "penjualan":
      html+=renderSalesReport(start,end);
      break;
    case "perakitan":
      html+=renderAssemblyReport(start,end);
      break;
    case "prediksi":
      html+=renderPredictionReport(start,end);
      break;
  }
  
  $("laporanResult").innerHTML=html;
}

function renderStockReport(start,end){
  const items=store.items.filter(i=>{
    const date=i.arrivalDate;
    return date && date!=="N/A" && date>=start && date<=end;
  });
  
  let html=`<table class="table"><thead><tr><th>Nama</th><th>Tipe</th><th>Ukuran</th><th>Supplier</th><th>Stok</th><th>Status</th></tr></thead><tbody>`;
  
  items.forEach(i=>{
    html+=`<tr>
      <td>${i.name}</td>
      <td>${i.type}</td>
      <td>${i.size}</td>
      <td>${i.supplier}</td>
      <td>${i.totalQty}</td>
      <td>${i.status==="masuk"?"Belum Rakit":i.status==="dirakit"?"Sudah Rakit":"Terjual"}</td>
    </tr>`;
  });
  
  html+=`</tbody></table>`;
  html+=`<div class="mt12"><strong>Total: ${items.length} item</strong></div>`;
  return html;
}

function renderMovementReport(start,end){
  let html=`<div class="small">Laporan pergerakan stok akan ditampilkan di sini.</div>`;
  return html;
}

function renderSalesReport(start,end){
  const sales=store.items.filter(i=>i.status==="terjual").flatMap(i=>
    (i.sellLogs||[]).map(s=>({...s,item:i}))
  ).filter(s=>s.date>=start&&s.date<=end);
  
  let html=`<table class="table"><thead><tr><th>Tanggal</th><th>Nama</th><th>Tipe</th><th>Ukuran</th><th>Jumlah</th></tr></thead><tbody>`;
  
  sales.forEach(s=>{
    html+=`<tr>
      <td>${s.date}</td>
      <td>${s.item.name}</td>
      <td>${s.item.type}</td>
      <td>${s.item.size}</td>
      <td>${s.qty}</td>
    </tr>`;
  });
  
  html+=`</tbody></table>`;
  html+=`<div class="mt12"><strong>Total Penjualan: ${sales.reduce((sum,s)=>sum+s.qty,0)} unit</strong></div>`;
  return html;
}

function renderAssemblyReport(start,end){
  const assemblies=store.items.filter(i=>i.status==="dirakit").flatMap(i=>
    (i.assembleLogs||[]).map(a=>({...a,item:i}))
  ).filter(a=>a.date>=start&&a.date<=end);
  
  let html=`<table class="table"><thead><tr><th>Tanggal</th><th>Nama</th><th>Tipe</th><th>Ukuran</th><th>Jumlah</th><th>Pegawai</th></tr></thead><tbody>`;
  
  assemblies.forEach(a=>{
    html+=`<tr>
      <td>${a.date}</td>
      <td>${a.item.name}</td>
      <td>${a.item.type}</td>
      <td>${a.item.size}</td>
      <td>${a.qty}</td>
      <td>${a.employee}</td>
    </tr>`;
  });
  
  html+=`</tbody></table>`;
  html+=`<div class="mt12"><strong>Total Perakitan: ${assemblies.reduce((sum,a)=>sum+a.qty,0)} unit</strong></div>`;
  return html;
}

function renderPredictionReport(start,end){
  let html=`<div class="small">Prediksi stok akan ditampilkan di sini.</div>`;
  return html;
}

/* ========= Riwayat ========= */
function renderHistory(){
  const type=$("hisType").value;
  let arr=store.history||[];
  
  if(type!=="all"){
    arr=arr.filter(h=>h.type===type);
  }
  
  // Sort by timestamp descending (newest first)
  arr.sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));
  
  const tbody=$("hisTable").querySelector("tbody");
  tbody.innerHTML="";
  
  arr.forEach(h=>{
    const tr=document.createElement("tr");
    const time=new Date(h.timestamp).toLocaleString("id-ID");
    
    let action="";
    if(h.type==="unit-baru"){
      action=`Unit baru: ${h.data.name} (${h.data.type}, ${h.data.size}) - ${h.data.qty} unit`;
    } else if(h.type==="perubahan-status"){
      action=`Status berubah: ${h.data.name} dari ${h.data.dari} ke ${h.data.ke} - ${h.data.qty} unit`;
    } else if(h.type==="edit"){
      action=`Edit: ${h.data.name} (${h.data.type}, ${h.data.size})`;
    } else if(h.type==="hapus"){
      if(h.data.qty){
        action=`Hapus ${h.data.qty} item`;
      } else {
        action=`Hapus: ${h.data.name} (${h.data.type}, ${h.data.size})`;
      }
    } else if(h.type==="impor"){
      action=`Impor ${h.data.qty} item dari CSV`;
    } else if(h.type==="backup"){
      action=`Backup data: ${h.data.filename}`;
    } else if(h.type==="restore"){
      action=`Restore data: ${h.data.filename}`;
    }
    
    let undoBtn="";
    if(h.undoAction&&!h.undone){
      undoBtn=`<button class="btn ghost small" onclick="undoHistory('${h.id}')">Undo</button>`;
    }
    
    tr.innerHTML=`
      <td style="text-align:right">${time}</td>
      <td>${action}</td>
      <td>${h.user||"System"}</td>
      <td>${undoBtn}</td>
    `;
    tbody.appendChild(tr);
  });
  
  // Add pagination for history
  addPaginationControls(arr.length, Math.ceil(arr.length / itemsPerPage), 'history');
}

function addHistory(type,data,undoAction){
  const entry={
    id:uid(),
    type,
    data,
    timestamp:new Date().toISOString(),
    user:currentUser?currentUser.username:"System",
    undoAction,
    undone:false
  };
  
  if(!store.history) store.history=[];
  store.history.unshift(entry);
  
  // Keep only last 1000 entries
  if(store.history.length>1000){
    store.history=store.history.slice(0,1000);
  }
  
  save();
}

function undoHistory(id){
  const entry=store.history.find(h=>h.id===id);
  if(!entry||entry.undone||!entry.undoAction) return;
  
  const action=entry.undoAction;
  
  if(action.type==="restore-item"){
    store.items.push(action.payload);
    toast("Item dikembalikan");
  } else if(action.type==="restore-items"){
    store.items.push(...action.payload);
    toast(`${action.payload.length} item dikembalikan`);
  } else if(action.type==="reverse-status"){
    const item=store.items.find(i=>i.id===action.payload.itemId);
    if(item){
      item.status=action.payload.to;
      
      // Adjust quantities if needed
      if(action.payload.qty){
        // This is a simplified reversal - in a real app you'd need more complex logic
        item.totalQty=action.payload.qty;
      }
    }
    toast("Status dikembalikan");
  }
  
  entry.undone=true;
  save();
  renderHistory();
}

/* ========= Export/Import CSV ========= */
$("btnExport").onclick=()=>{
  const items=store.items.filter(i=>i.status==="masuk");
  const headers=["Nama","Tipe","Ukuran","Supplier","Tanggal_Kedatangan","Jumlah_Unit","Warna","Lokasi","Kemasan"];
  
  let csv=headers.join(",")+"\n";
  
  items.forEach(i=>{
    const colors=chips(i.colors);
    const locations=chips(i.locations,"name","qty");
    const row=[
      i.name,
      i.type,
      i.size,
      i.supplier,
      i.arrivalDate,
      i.totalQty,
      `"${colors}"`,
      `"${locations}"`,
      i.pack
    ].map(f=>f||"").join(",");
    csv+=row+"\n";
  });
  
  const blob=new Blob([csv],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download=`mujur-bikes-export-${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  
  addHistory('ekspor',{qty:items.length});
  toast(`Diekspor ${items.length} item`);
};

$("btnImportData").onclick=()=>{
  const input=document.createElement("input");
  input.type="file";
  input.accept=".csv";
  
  input.onchange=e=>{
    const file=e.target.files[0];
    if(!file) return;
    
    const reader=new FileReader();
    reader.onload=event=>{
      const csv=event.target.result;
      const lines=csv.split("\n").filter(l=>l.trim());
      const headers=lines[0].split(",").map(h=>h.trim());
      
      const imported=[];
      
      for(let i=1;i<lines.length;i++){
        const values=parseCSVLine(lines[i]);
        if(values.length<headers.length) continue;
        
        const item={
          id:uid(),
          status:"masuk",
          name:values[0]||"",
          type:values[1]||"",
          size:values[2]||"",
          supplier:values[3]||"N/A",
          arrivalDate:values[4]||"N/A",
          totalQty:parseInt(values[5])||0,
          colors:parseColorQty(values[6]),
          locations:parseLocQty(values[7]),
          pack:values[8]||"N/A",
          image:null,
          assembleLogs:[],
          sellLogs:[]
        };
        
        if(item.name&&item.type&&item.size&&item.totalQty>0){
          store.items.push(item);
          imported.push(item);
        }
      }
      
      if(imported.length){
        addHistory('impor',{qty:imported.length}, {type:"restore-items",payload:imported});
        save();
        showSuccess(`Diimpor ${imported.length} item dari CSV`);
      } else {
        alert("Tidak ada item yang valid di file CSV.");
      }
    };
    
    reader.readAsText(file);
  };
  
  input.click();
};

$("btnTpl").onclick=()=>{
  const csv=`Nama,Tipe,Ukuran,Supplier,Tanggal_Kedatangan,Jumlah_Unit,Warna,Lokasi,Kemasan
Polygon Strada,MTB,27.5",VL,2025-09-20,5,"Merah:2; Hitam:3","Toko:3; Gudang:2",Dus
United Seattle 3.0,Road,29",JY,2025-09-15,3,"Biru:1; Putih:2","Toko:3",Karung`;
  
  const blob=new Blob([csv],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="mujur-bikes-template.csv";
  a.click();
  URL.revokeObjectURL(url);
};

function parseCSVLine(line){
  const result=[];
  let current="";
  let inQuotes=false;
  
  for(let i=0;i<line.length;i++){
    const char=line[i];
    
    if(char==='"'&&(i===0||line[i-1]!=='\\')){
      inQuotes=!inQuotes;
    } else if(char===','&&!inQuotes){
      result.push(current);
      current="";
    } else {
      current+=char;
    }
  }
  
  result.push(current);
  return result.map(f=>f.replace(/^"|"$/g,'').trim());
}

function parseColorQty(str){
  if(!str) return [];
  return str.split(";").map(p=>{
    const [color,qty]=p.split(":").map(x=>x.trim());
    return {color,qty:parseInt(qty)||1};
  }).filter(x=>x.color);
}

function parseLocQty(str){
  if(!str) return [{name:"Toko",qty:1}];
  return str.split(";").map(p=>{
    const [name,qty]=p.split(":").map(x=>x.trim());
    return {name,qty:parseInt(qty)||1};
  }).filter(x=>x.name);
}

/* ========= Modal Helpers ========= */
function showModal(id){ 
  $(id).classList.add("show"); 
  document.body.style.overflow="hidden"; 
}
function closeModal(id){ 
  $(id).classList.remove("show"); 
  document.body.style.overflow=""; 
  _detailCtx=null;
}

// Close modals when clicking outside
document.querySelectorAll(".modal").forEach(m=>{
  m.onclick=e=>{
    if(e.target===m) closeModal(m.id);
  };
});

/* ========= Initialize ========= */
function init(){
  // Initialize auth first
  initAuth();
  
  // Initialize real-time features
  initRealTimeFeatures();
  
  // Check stock notifications
  checkStockNotifications();
  
  // Render initial view
  render();
  
  // Auto-save every 30 seconds
  setInterval(()=>{
    if(store.items.length>0){
      save();
    }
  },30000);
  
  console.log("🚀 MUJUR BIKES v8.0 Enhanced System initialized");
  console.log("📊 Total items:", store.items.length);
  console.log("👤 Current user:", currentUser);
}

// Start the application
init();
</script>
</body>
</html>
