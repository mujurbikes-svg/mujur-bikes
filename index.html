<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MUJUR BIKES v8.0 - Enhanced System</title>
<!-- Manifest untuk PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2563eb"/>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="MUJUR BIKES">
<link rel="apple-touch-icon" href="icons/icon-192x192.png">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

<!-- QR Code Library -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

<style>
  :root{
    --bg:#f6f8fb; --card:#ffffff; --ink:#0f172a;
    --muted:#475569; --line:#e5e7eb; --pri:#2563eb; --pri-ink:#fff;
    --amber:#f59e0b; --red:#ef4444; --green:#16a34a;
    --soft-yellow:#fff8db; --soft-red:#ffe6e6;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:28px;background:var(--bg);color:var(--ink);font-family:Arial,Helvetica,sans-serif}
  .container{max-width:1200px;margin:0 auto;padding:0 16px;}
  h1{font-size:32px;font-weight:900;text-align:center;margin:24px 0 6px;}
  .ver{font-size:14px;color:#64748b;text-align:center;margin-bottom:26px}
  h2{font-size:20px;margin:0;font-weight:700;}
  h3{font-size:18px;margin:0 0 12px 0;font-weight:600;}
  .tabs{display:flex;gap:4px;justify-content:center;margin:6px 0 20px;flex-wrap:wrap;background:#f1f5f9;padding:8px;border-radius:12px;}
  .tab{padding:10px 16px;border:0;border-radius:8px;background:#e5e7eb;font-weight:600;cursor:pointer;min-width:110px;text-align:center;font-size:13px;transition:all 0.2s ease;flex:1;}
  .tab.active{background:var(--pri);color:var(--pri-ink);box-shadow:0 2px 4px rgba(0,0,0,0.1);}
  .section{background:var(--card);border-radius:18px;box-shadow:0 2px 12px rgba(0,0,0,.06);padding:16px}
  .section+.section{margin-top:16px}
  .headerRow{display:flex;align-items:center;justify-content:space-between;margin:4px 6px 14px}
  .actions{display:flex;gap:10px;flex-wrap:wrap}
  .toolbar{display:flex;gap:12px;flex-wrap:wrap;margin:0 6px 14px}
  .grow{flex:1 1 320px}
  .input,select,textarea{border:1px solid var(--line);border-radius:12px;padding:10px 12px;background:#fff}
  .btn{border:0;border-radius:12px;padding:10px 14px;background:var(--pri);color:var(--pri-ink);cursor:pointer}
  .btn.ghost{background:#e7eaf1;color:#111}
  .btn.red{background:var(--red)}
  .btn.green{background:var(--green)}
  .btn.amber{background:var(--amber)}
  .btn.small{padding:6px 10px;border-radius:10px}
  .badge{display:inline-block;background:#eef2ff;color:#3730a3;padding:3px 8px;border-radius:999px;font-size:12px}
  .reminder{background:#fff7d6;border:1px solid #fde68a;padding:10px;border-radius:12px;margin:8px 6px}
  .list{display:grid;gap:14px}
  .item{display:grid;grid-template-columns:80px 1fr auto;gap:12px;align-items:center;background:#fff;border:1px solid var(--line);border-radius:16px;padding:12px;cursor:pointer}
  .item:hover{background:#f9fafb}
  .item.low{background:var(--soft-yellow)}
  .item.zero{background:var(--soft-red)}
  .thumb{width:80px;height:80px;background:#f1f5f9;border-radius:12px;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .thumb img{width:100%;height:100%;object-fit:cover}
  .name{font-size:16px;font-weight:900;margin:0 0 6px}
  .sub{color:#334155;margin:0 0 6px}
  .meta{color:#64748b;font-size:12px}
  .checkwrap{display:flex;align-items:center;gap:8px}
  .hidden{display:none!important}
  .menu{position:relative}
  .menu-panel{position:absolute;right:0;top:110%;background:#fff;border:1px solid var(--line);border-radius:14px;padding:8px;box-shadow:0 8px 18px rgba(0,0,0,.12);display:none;z-index:20;min-width:240px}
  .menu.open .menu-panel{display:block}
  .menu-panel .btn{width:100%;text-align:left;background:#f3f4f6;color:#111}
  .menu-panel .btn:hover{background:#e5e7eb}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:16px;z-index:100}
  .modal.show{display:flex}
  .box{background:#fff;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.18);padding:16px;max-width:860px;width:96vw;max-height:92vh;overflow:auto;position:relative}
  /* box Detail 80% */
  #detailModal .box{max-width:760px;width:80vw}
  .closeX{position:absolute;right:12px;top:10px;font-size:20px;border:0;background:transparent;cursor:pointer;z-index:5}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .mt8{margin-top:10px}.mt12{margin-top:14px}.mt16{margin-top:18px}
  .small{font-size:12px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .detail-img{width:320px;height:320px;background:#f1f5f9;border-radius:14px;margin:0 auto 12px;overflow:hidden;display:flex;align-items:center;justify-content:center;position:relative;z-index:1}
  .detail-img img{max-width:100%;max-height:100%;object-fit:contain;cursor:zoom-in}
  .detail-title{font-size:24px;font-weight:900;margin:6px 0 2px}
  .detail-sub{font-size:16px;font-weight:700;color:#334155;margin:0 0 6px}
  .detail-stock{font-size:16px;font-weight:700;margin:0 0 10px}
  .table{width:100%;border-collapse:separate;border-spacing:0 8px;margin-top:8px}
  .table th,.table td{background:#fff;border:1px solid var(--line);padding:10px;border-radius:10px}
  .table th{background:#f8fafc}
  .chip{display:inline-flex;gap:6px;align-items:center;background:#eef2ff;color:#3730a3;padding:6px 10px;border-radius:999px;margin:4px 6px 0 0;font-size:13px}
  .chip .x{background:var(--red);border:0;color:#fff;border-radius:999px;padding:0 6px;cursor:pointer}
  .readLine{margin:6px 0}
  .ac-wrap{position:relative}
  .ac-list{position:absolute;left:0;right:0;top:100%;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 6px 16px rgba(0,0,0,.1);max-height:220px;overflow:auto;display:none;z-index:30}
  .ac-item{padding:8px 12px;cursor:pointer}.ac-item:hover{background:#f3f4f6}
  #zoomBox{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;z-index:80}
  #zoomBox img{max-width:86vw;max-height:86vh;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.4);cursor:zoom-out}
  /* Modal kecil NA */
  #naModal .box{max-width:420px;width:90vw}
  /* Notification */
  #toast{position:fixed;right:18px;top:18px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;z-index:120;display:none;box-shadow:0 8px 18px rgba(0,0,0,.2)}
  /* Password modal */
  #passModal .box{max-width:380px;width:90vw}
  .err{color:#ef4444;font-size:12px;margin-top:6px}
  
  /* Pagination */
  .pagination{display:flex;justify-content:center;align-items:center;gap:12px;margin:20px 0;flex-wrap:wrap}
  .pagination button{border:1px solid var(--line);background:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}
  .pagination button:disabled{background:#f3f4f6;color:#9ca3af;cursor:not-allowed}
  .pagination button.active{background:var(--pri);color:var(--pri-ink);border-color:var(--pri)}
  .pagination-info{color:var(--muted);font-size:14px}
  .page-size{display:flex;align-items:center;gap:8px;margin-left:auto}
  .page-size select{border:1px solid var(--line);border-radius:6px;padding:4px 8px;background:#fff}

  /* Date Range Filter */
  .date-range{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:14px}
  .date-range select,.date-range input{border:1px solid var(--line);border-radius:8px;padding:6px 10px;background:#fff}

  /* Dashboard */
  .dashboard {display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;}
  .dashboard-card {background: var(--card); border-radius: 14px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,.05); text-align: center;}
  .dashboard-value {font-size: 32px; font-weight: 900; margin: 8px 0;}
  .dashboard-label {font-size: 14px; color: var(--muted);}

  /* PWA Install Button */
  #installBtn {position: fixed; bottom: 20px; right: 20px; background: var(--pri); color: white; border: none; border-radius: 50px; padding: 12px 20px; box-shadow: 0 4px 12px rgba(0,0,0,.2); z-index: 100; display: none; cursor: pointer;}

  /* ===== Fitur Baru ===== */
  
  /* Version di kiri atas */
  .version-top {position: absolute; top: 10px; left: 10px; font-size: 12px; color: #64748b;}
  
  /* Password visibility toggle */
  .password-container {position: relative;}
  .password-toggle {position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 12px; color: var(--pri);}
  
  /* Scrollable containers */
  .scrollable-container {max-height: 400px; overflow-y: auto; border: 1px solid var(--line); border-radius: 12px; padding: 12px;}
  
  /* Success Modal */
  #successModal .box {max-width: 420px; width: 90vw; text-align: center;}
  
  /* Report Section */
  .report-options {display: none; margin-top: 16px;}
  .report-options.show {display: block;}
  .report-type {display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; margin: 16px 0;}
  .report-type button {padding: 12px; border: 1px solid var(--line); border-radius: 12px; background: #f8fafc; cursor: pointer; text-align: center;}
  .report-type button:hover {background: #e5e7eb;}
  
  /* Refresh button */
  .refresh-btn {background: var(--green); margin-left: auto;}
  
  /* Notification Styles */
  .notification-item {
    border-left: 3px solid;
    padding-left: 10px;
    margin-bottom: 12px;
    padding: 8px;
    border-radius: 8px;
  }

  .notification-item[data-type="critical"] {
    border-left-color: var(--red);
    background: #fee2e2;
  }

  .notification-item[data-type="warning"] {
    border-left-color: var(--amber);
    background: #fef3c7;
  }

  .notification-item[data-type="info"] {
    border-left-color: var(--pri);
    background: #e0f2fe;
  }

  /* User Menu Styles */
  #userInfo {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 10;
  }

  /* Login Modal */
  #loginModal .box {
    max-width: 400px;
    width: 90vw;
  }

  /* Chart Styles */
  .chart-container {
    background: var(--card);
    border-radius: 14px;
    padding: 16px;
    margin: 16px 0;
    box-shadow: 0 2px 8px rgba(0,0,0,.05);
  }
  
  .chart-row {
    display: flex;
    align-items: center;
    margin: 8px 0;
    gap: 12px;
  }
  
  .chart-label {
    min-width: 120px;
    font-size: 14px;
  }
  
  .chart-bar {
    height: 24px;
    background: var(--pri);
    border-radius: 12px;
    transition: width 0.5s ease;
    min-width: 40px;
    text-align: right;
    padding-right: 8px;
    color: white;
    font-size: 12px;
    line-height: 24px;
  }
  
  .chart-value {
    min-width: 60px;
    text-align: right;
    font-weight: bold;
  }

  /* Custom Report Builder */
  .custom-report-builder {
    background: var(--card);
    border-radius: 14px;
    padding: 16px;
    margin: 16px 0;
  }
  
  .column-selector {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 8px;
    margin: 12px 0;
  }
  
  .filter-conditions {
    margin: 16px 0;
  }
  
  .filter-row {
    display: flex;
    gap: 8px;
    margin: 8px 0;
    align-items: center;
    flex-wrap: wrap;
  }
  
  /* Auto Backup Status */
  .backup-status {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
    font-size: 12px;
    color: var(--muted);
  }
  
  .backup-status.online::before {
    content: "●";
    color: var(--green);
  }
  
  .backup-status.offline::before {
    content: "●";
    color: var(--red);
  }

  /* Real-time Indicators */
  .real-time-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--green);
    margin-right: 6px;
    animation: pulse 2s infinite;
  }
  
  @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
  }
  
  /* Report Table Container */
  .report-table-container {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid var(--line);
    border-radius: 12px;
    margin-top: 12px;
  }

  /* Logo Styles */
  .header-with-logo {
    text-align: center;
    margin: 20px 0 10px;
  }

  .site-logo {
    max-height: 80px;
    max-width: 100%;
    object-fit: contain;
  }

  /* QR Code Styles */
  .qr-product-info {
    text-align: center;
    margin-top: 15px;
    font-size: 14px;
  }

  .qr-product-name {
    font-weight: bold;
    margin-bottom: 5px;
  }

  .qr-product-details {
    color: #64748b;
    font-size: 12px;
  }
/* QR Code Container */
#qrCodeContainer {
  text-align: center;
  padding: 20px;
  min-height: 300px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

/* Camera Container Fallback */
.camera-fallback-container {
  color: white;
  text-align: center;
  padding: 50px 20px;
  background: #333;
  border-radius: 12px;
  height: 100%;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

/* Scanner Container */
.scanner-fallback-container {
  text-align: center;
  padding: 40px 20px;
  background: #f8f9fa;
  border-radius: 12px;
  height: 100%;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

/* Success States */
.scanner-success {
  text-align: center;
  padding: 30px 20px;
  background: #d4edda;
  border-radius: 12px;
  height: 100%;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}
  /* Camera Styles */
  .camera-controls {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-top: 15px;
  }

  .camera-preview {
    width: 100%;
    height: 400px;
    background: #000;
    border-radius: 12px;
    overflow: hidden;
    position: relative;
  }
.camera-fallback {
  text-align: center;
  padding: 40px 20px;
  color: white;
}

.camera-fallback-icon {
  font-size: 48px;
  margin-bottom: 20px;
}
  /* QR Code Container */
#qrCodeContainer {
  text-align: center;
  padding: 20px;
  min-height: 300px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

/* Camera Container Fallback */
.camera-fallback-container {
  color: white;
  text-align: center;
  padding: 50px 20px;
  background: #333;
  border-radius: 12px;
  height: 100%;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

/* Scanner Container */
.scanner-fallback-container {
  text-align: center;
  padding: 40px 20px;
  background: #f8f9fa;
  border-radius: 12px;
  height: 100%;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

/* Success States */
.scanner-success {
  text-align: center;
  padding: 30px 20px;
  background: #d4edda;
  border-radius: 12px;
  height: 100%;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}
  /* Print Styles for QR Code */
  @media print {
    body * {
      visibility: hidden;
    }
    #qrCodeContainer, #qrCodeContainer * {
      visibility: visible;
    }
    #qrCodeContainer {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      padding: 10mm;
    }
  }
  
  /* Untuk desktop, batasi lebar maksimal tab */
  @media (min-width: 768px) {
    .tab {
        min-width: 110px;
        max-width: 140px;
        flex: 0 1 auto;
    }
    
    .grid2 {
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }
    
    .toolbar {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: nowrap;
    }
    
    .grow {
        flex: 1;
        min-width: 200px;
    }
  }

  /* Mobile Optimizations */
  @media (max-width: 767px) {
    body {
      margin: 16px;
    }
    
    .container {
      padding: 0 8px;
    }
    
    .tabs {
      padding: 4px;
    }
    
    .tab {
      min-width: 80px;
      font-size: 12px;
      padding: 8px 12px;
    }
    
    .headerRow {
      flex-direction: column;
      align-items: flex-start;
      gap: 12px;
    }
    
    .actions {
      width: 100%;
      justify-content: space-between;
    }
    
    .toolbar {
      flex-direction: row;
      flex-wrap: nowrap;
      gap: 6px;
      align-items: center;
    }
    
    .grid2 {
      grid-template-columns: 1fr;
    }
    
    .dashboard {
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    }
    
    .dashboard-value {
      font-size: 24px;
    }
    
    .item {
      grid-template-columns: 60px 1fr;
      gap: 8px;
    }
    
    .thumb {
      width: 60px;
      height: 60px;
    }
    
    .detail-img {
      width: 100%;
      height: 250px;
    }
    
    /* Perbaikan search box dan toolbar untuk mobile */
    #searchBox {
      padding: 8px 10px;
      font-size: 14px;
      min-height: 40px;
      height: 40px;
    }
    
    .toolbar .grow {
      flex: 1;
      min-width: 120px;
    }
    
    #sortKey, #sortDir {
      min-height: 40px;
      height: 40px;
      font-size: 12px;
      padding: 8px;
    }
    
    #sortKey {
      width: 100px;
    }
    
    #sortDir {
      width: 40px;
      min-width: 40px;
    }
    
    .toolbar > * {
      flex-shrink: 0;
    }
    
    /* Perbaikan posisi judul di mobile */
    h1 {
      margin-top: 50px;
      font-size: 28px;
    }
    
    .version-top {
      top: 60px;
      left: 16px;
    }
    
    #userInfo {
      top: 10px;
      right: 16px;
      z-index: 10;
    }
    
    .container {
      position: relative;
    }
    
    .site-logo {
      max-height: 60px;
    }
    
    .header-with-logo {
      margin-top: 40px;
    }
    
    /* Touch-friendly buttons for mobile */
    .btn {
      min-height: 44px;
      min-width: 44px;
    }
    
    .tab {
      min-height: 44px;
    }
    
    .input, select, textarea {
      min-height: 44px;
      font-size: 16px; /* Prevent zoom on iOS */
    }
  }
</style>
</head>
<body>
<!-- Login Modal -->
<div class="modal" id="loginModal">
  <div class="box" onclick="event.stopPropagation()">
    <button class="closeX" onclick="closeLogin()">✕</button>
    <h3>Login Sistem MUJUR BIKES</h3>
    
    <div class="mt8">
      <label>Username</label>
      <input id="loginUsername" class="input" placeholder="Masukkan username">
    </div>
    
    <div class="mt8">
      <label>Password</label>
      <div class="password-container">
        <input id="loginPassword" type="password" class="input" placeholder="Masukkan password">
        <button class="password-toggle" type="button" onclick="toggleLoginPassword()">show</button>
      </div>
    </div>
    
    <div id="loginErr" class="err hidden">Username atau password salah.</div>
    
    <div class="row mt16">
      <button class="btn" onclick="doLogin()">Login</button>
      <button class="btn ghost" onclick="closeLogin()">Batal</button>
    </div>
    
    <!-- Demo Accounts disembunyikan -->
    <div class="mt12 small" style="border-top: 1px solid var(--line); padding-top: 12px; display: none;">
      <strong>Demo Accounts:</strong><br>
      Admin: admin / admin123<br>
      Staff: staff / staff123
    </div>
  </div>
</div>

<div class="container">
  <div class="version-top">Versi 8.0 - Enhanced System</div>
  
  <!-- Ganti judul dengan logo -->
  <div class="header-with-logo">
    <img src="logo.png" alt="MUJUR BIKES" class="site-logo" onerror="this.style.display='none'; document.querySelector('.logo-fallback').style.display='block'">
    <h1 class="logo-fallback" style="display:none">MUJUR BIKES</h1>
  </div>
  <div class="ver">Sistem Manajemen Inventori Sepeda</div>

  <!-- Notification Panel -->
  <div id="notificationPanel" class="section hidden" style="background: var(--soft-yellow); border-left: 4px solid var(--amber);">
    <div class="headerRow">
      <h3>Notifikasi Stok</h3>
      <button class="btn ghost small" onclick="closeNotifications()">Tutup</button>
    </div>
    <div id="notificationList"></div>
  </div>

  <div class="tabs" id="tabs">
    <button class="tab active" data-route="dashboard">Dashboard</button>
    <button class="tab" data-route="masuk">Belum Rakit</button>
    <button class="tab" data-route="dirakit">Sudah Rakit</button>
    <button class="tab" data-route="terjual">Terjual</button>
    <button class="tab" data-route="low">Stok Kurang</button>
    <button class="tab" data-route="master">Data Master</button>
    <button class="tab" data-route="laporan">Laporan</button>
  </div>

  <!-- ===== Dashboard Section ===== -->
  <div id="pageDashboard" class="section">
    <div class="headerRow">
      <h2>Dashboard <span class="real-time-indicator"></span></h2>
      <div>
        <button class="btn refresh-btn" onclick="refreshData()">Refresh</button>
        <button class="btn ghost small" onclick="toggleAutoRefresh()" id="autoRefreshBtn">Auto: ON</button>
      </div>
    </div>
    <div class="dashboard" id="dashboardCards">
      <!-- Dashboard cards will be populated by JavaScript -->
    </div>
    
    <!-- Real-time Charts -->
    <div id="dashboardCharts"></div>
    
    <!-- Auto Backup Status -->
    <div class="backup-status online" id="backupStatus">
      Auto Backup: Aktif - Backup otomatis setiap 5 menit
    </div>
  </div>

  <!-- ===== List Section ===== -->
  <div id="pageList" class="section hidden">
    <div class="headerRow">
      <h2 id="tabTitle">Belum Rakit</h2>
      <div class="actions">
        <button class="btn refresh-btn" onclick="refreshData()">Refresh</button>
        <button class="btn" id="btnScanQR" onclick="openQRScanner()">Scan QR</button>
        <button class="btn ghost" id="btnMulti">Pilih Multiple</button>
        <button class="btn amber hidden" id="btnMassEdit">Edit Massal</button>
        <button class="btn red hidden" id="btnMassDelete">Hapus Dipilih</button>
        <button class="btn ghost hidden" id="btnMassCancel">Batal</button>

        <button class="btn" id="btnExport">Ekspor CSV</button>
        <div class="menu" id="importMenu">
          <button class="btn ghost" id="btnImport">Impor CSV</button>
          <div class="menu-panel">
            <button class="btn" id="btnImportData">Impor Data Sepeda</button>
            <button class="btn" id="btnTpl">Download Template CSV</button>
          </div>
        </div>
      </div>
    </div>

    <div id="lowReminder" class="reminder hidden"></div>

    <div class="toolbar">
      <input id="searchBox" class="input grow" placeholder="Cari nama/tipe/ukuran/supplier/kode...">
      <select id="sortKey" class="input">
        <option value="name">Nama</option>
        <option value="arrivalDate">Tanggal Kedatangan</option>
        <option value="totalQty">Jumlah Stok</option>
        <option value="type">Tipe</option>
        <option value="size">Ukuran</option>
        <option value="supplier">Supplier</option>
        <option value="code">Kode/ID</option>
      </select>
      <button id="sortDir" class="btn ghost" title="Urutan">↑</button>

      <button id="btnAdd" class="btn">Tambah Item</button>
      <button id="btnAddAsm" class="btn ghost hidden">Tambah Sepeda Sudah Rakit</button>
      <button id="btnAddSell" class="btn ghost hidden">Tambah Penjualan</button>
    </div>

    <div id="list" class="list"></div>
    
    <!-- Pagination -->
    <div id="listPagination" class="pagination"></div>
  </div>

  <!-- ===== Master Section ===== -->
  <div id="pageMaster" class="section hidden">
    <div class="headerRow">
      <h2>Data Master</h2>
      <button class="btn refresh-btn" onclick="refreshData()">Refresh</button>
    </div>
    
    <div id="masterRead"></div>
    <div id="masterEdit" class="hidden"></div>
    <div class="row mt8" id="masterBar">
      <button class="btn" id="btnMasterEdit">Edit</button>
      <button class="btn hidden" id="btnMasterSave">Simpan Perubahan</button>
      <button class="btn ghost hidden" id="btnMasterCancel">Batal</button>
    </div>

    <!-- Backup & Restore Section -->
    <div class="section mt8">
      <div class="headerRow"><h2>Backup & Restore</h2><div></div></div>
      <div class="toolbar">
        <button class="btn green" id="backupBtn" onclick="backupData()">Backup Data</button>
        <button class="btn amber" id="restoreBtn" onclick="restoreData()">Restore Data</button>
        <button class="btn ghost" onclick="resetData()">Reset ke Data Demo</button>
      </div>
      <p class="small mt8">Backup: Simpan semua data ke file JSON. Restore: Muat data dari file JSON.</p>
    </div>
  </div>

  <!-- ===== Laporan Section ===== -->
  <div id="pageLaporan" class="section hidden">
    <div class="headerRow">
      <h2>Laporan</h2>
      <button class="btn refresh-btn" onclick="refreshData()">Refresh</button>
    </div>
    
    <button class="btn" id="btnPilihLaporan">Pilih Laporan</button>
    
    <div id="laporanOptions" class="report-options">
      <div class="date-range mt12">
        <label>Rentang Tanggal:</label>
        <input type="date" id="reportStartDate" class="input">
        <span>s/d</span>
        <input type="date" id="reportEndDate" class="input">
        <button class="btn ghost small" onclick="setReportDateRange('today')">Hari Ini</button>
        <button class="btn ghost small" onclick="setReportDateRange('week')">Minggu Ini</button>
        <button class="btn ghost small" onclick="setReportDateRange('month')">Bulan Ini</button>
      </div>
      
      <div class="report-type">
        <button onclick="generateReport('stok')">Laporan Stok</button>
        <button onclick="generateReport('pergerakan')">Laporan Pergerakan Stok</button>
        <button onclick="generateReport('penjualan')">Laporan Penjualan</button>
        <button onclick="generateReport('perakitan')">Laporan Perakitan</button>
        <button onclick="generateReport('prediksi')">Prediksi Stok</button>
        <button onclick="showCustomReportBuilder()">Laporan Custom</button>
      </div>
    </div>
    
    <div id="laporanResult" class="mt16"></div>
    
    <!-- Riwayat Section -->
    <div class="section mt16">
      <div class="headerRow">
        <h2>Riwayat</h2>
        <button class="btn refresh-btn" onclick="renderHistory()">Refresh</button>
      </div>
      
      <div class="toolbar">
        <select id="hisType" class="input" onchange="renderHistory()">
          <option value="all">Semua</option>
          <option value="unit-baru">Unit Baru</option>
          <option value="perubahan-status">Perubahan Status</option>
          <option value="edit">Edit</option>
          <option value="hapus">Hapus</option>
          <option value="impor">Impor</option>
        </select>
      </div>
      
      <div class="scrollable-container">
        <table class="table" id="hisTable">
          <thead>
            <tr>
              <th style="width:140px;text-align:right">Waktu</th>
              <th>Aktivitas</th>
              <th>Detail</th>
              <th style="width:100px">Undo</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ===== Modals ===== -->

<!-- Add / Edit Item -->
<div class="modal" id="addModal" onclick="closeModal('addModal')">
  <div class="box" onclick="event.stopPropagation()">
    <button class="closeX" onclick="closeModal('addModal')">✕</button>
    <h3 id="addTitle">Tambah Item</h3>

    <div class="grid2 mt8">
      <div class="ac-wrap">
        <label>Nama Unit <span class="badge">wajib</span></label>
        <input id="fName" class="input" autocomplete="off" placeholder="mis. Polygon Strada">
        <div id="acList" class="ac-list"></div>
      </div>
      <div>
        <label>Supplier <span class="badge">wajib</span></label>
        <select id="fSup" class="input"><option value="">-- pilih --</option></select>
      </div>
    </div>

    <div class="grid2 mt8">
      <div>
        <label>Tipe <span class="badge">wajib</span></label>
        <select id="fType" class="input"><option value="">-- pilih --</option></select>
      </div>
      <div>
        <label>Ukuran (inci) <span class="badge">wajib</span></label>
        <select id="fSize" class="input"><option value="">-- pilih --</option></select>
      </div>
    </div>

    <div class="grid2 mt8">
      <div>
        <label>Kemasan <span class="badge">wajib</span></label>
        <select id="fPack" class="input"><option value="">-- pilih --</option></select>
      </div>
      <div>
        <label>Status Sepeda <span class="badge">wajib</span></label>
        <select id="fStatus" class="input">
          <option value="">-- pilih --</option>
          <option value="masuk">Belum Rakit</option>
          <option value="dirakit">Sudah Rakit</option>
        </select>
      </div>
    </div>

    <div class="grid2 mt8">
      <div>
        <label>Jumlah Unit Total <span class="badge">wajib</span></label>
        <div class="row">
          <input id="fQty" type="number" class="input" min="1" placeholder="mis. 5" style="width:120px" oninput="min1(this);guardAllLocToQty()">
          <button class="btn ghost small" onclick="stepNum('fQty',+1);guardAllLocToQty()">+</button>
          <button class="btn ghost small" onclick="stepNum('fQty',-1);guardAllLocToQty()">−</button>
        </div>
      </div>
      <div>
        <label>Tanggal Kedatangan</label>
        <div class="row">
          <input id="fArrive" type="date" class="input" style="flex:1">
          <button class="btn ghost small" onclick="setToday('fArrive')">Hari Ini</button>
          <button class="btn ghost small" onclick="openNAModal('fArrive')">N/A</button>
        </div>
      </div>
    </div>

    <div id="asmRow" class="grid2 mt8 hidden">
      <div>
        <label>Tanggal Rakit</label>
        <div class="row">
          <input id="fAsmDate" type="date" class="input" style="flex:1">
          <button class="btn ghost small" onclick="setToday('fAsmDate')">Hari Ini</button>
          <button class="btn ghost small" onclick="openNAModal('fAsmDate')">N/A</button>
        </div>
      </div>
      <div>
        <label>Pegawai Perakit <span class="badge">wajib</span></label>
        <select id="fAsmEmp" class="input"><option value="">-- pilih / N/A --</option></select>
      </div>
    </div>

    <div class="section mt8">
      <h4>Warna & Kuantitas <span class="small">(opsional; total ≤ jumlah)</span></h4>
      <div id="colorWrap"></div>
      <button class="btn ghost mt8 small" onclick="addColorRow()">+ Tambah Warna</button>
    </div>

    <div class="section mt8">
      <h4>Lokasi Penyimpanan & Kuantitas <span class="small">(wajib; total = jumlah)</span></h4>
      <div id="locWrap"></div>
      <button class="btn ghost mt8 small" onclick="addLocRow()">+ Tambah Lokasi</button>
    </div>

    <div class="mt12">
      <label>Gambar (opsional)</label>
      <input id="fImg" type="file" accept="image/*" class="input">
    </div>

    <div class="row mt16">
      <button class="btn" id="btnSave">Simpan</button>
      <button class="btn ghost" onclick="closeModal('addModal')">Batal</button>
    </div>
  </div>
</div>

<!-- Picker Perakitan -->
<div class="modal" id="asmModal" onclick="closeModal('asmModal')"><div class="box" onclick="event.stopPropagation()">
  <button class="closeX" onclick="closeModal('asmModal')">✕</button>
  <h3>Pilih Sepeda (Belum Rakit)</h3>
  <input id="asmSearch" class="input mt8" placeholder="Cari sepeda Belum Rakit...">
  <div id="asmList" class="list scrollable-container mt8"></div>
</div></div>

<!-- Detail Perakitan -->
<div class="modal" id="asmDetailModal" onclick="closeModal('asmDetailModal')"><div class="box" onclick="event.stopPropagation()">
  <button class="closeX" onclick="closeModal('asmDetailModal')">✕</button>
  <div id="asmHeader" class="mt8"></div>
  <div class="grid2 mt8">
    <div>
      <label>Jumlah Unit Dirakit <span class="badge">wajib</span></label>
      <div class="row">
        <input id="adQty" type="number" class="input" min="1" style="width:120px" oninput="clampToStock(this,'asm')">
        <button class="btn ghost small" onclick="stepLocal('adQty','asm',+1)">+</button>
        <button class="btn ghost small" onclick="stepLocal('adQty','asm',-1)">−</button>
      </div>
    </div>
    <div>
      <label>Warna (opsional)</label>
      <input id="adColor" class="input" placeholder="mis. Merah:1; Hitam:2">
    </div>
  </div>
  <div class="grid2 mt8">
    <div>
      <label>Tanggal Rakit</label>
      <div class="row">
        <input id="adDate" type="date" class="input" style="flex:1">
        <button class="btn ghost small" onclick="setToday('adDate')">Hari Ini</button>
        <button class="btn ghost small" onclick="openNAModal('adDate')">N/A</button>
      </div>
    </div>
    <div>
      <label>Nama Pegawai <span class="badge">wajib</span></label>
      <select id="adEmp" class="input"><option value="">-- pilih / N/A --</option></select>
    </div>
  </div>
  <div class="row mt16">
    <button class="btn" id="adSave">Simpan</button>
    <button class="btn ghost" onclick="closeModal('asmDetailModal')">Batal</button>
  </div>
</div></div>

<!-- Picker Penjualan -->
<div class="modal" id="sellModal" onclick="closeModal('sellModal')"><div class="box" onclick="event.stopPropagation()">
  <button class="closeX" onclick="closeModal('sellModal')">✕</button>
  <h3>Pilih Sepeda (Sudah Rakit)</h3>
  <input id="sellSearch" class="input mt8" placeholder="Cari sepeda Sudah Rakit...">
  <div id="sellList" class="list scrollable-container mt8"></div>
</div></div>

<!-- Detail Penjualan -->
<div class="modal" id="sellDetailModal" onclick="closeModal('sellDetailModal')"><div class="box" onclick="event.stopPropagation()">
  <button class="closeX" onclick="closeModal('sellDetailModal')">✕</button>
  <div id="sellHeader" class="mt8"></div>
  <div class="grid2 mt8">
    <div>
      <label>Jumlah Unit Terjual <span class="badge">wajib</span></label>
      <div class="row">
        <input id="sdQty" type="number" class="input" min="1" style="width:120px" oninput="clampToStock(this,'sell')">
        <button class="btn ghost small" onclick="stepLocal('sdQty','sell',+1)">+</button>
        <button class="btn ghost small" onclick="stepLocal('sdQty','sell',-1)">−</button>
      </div>
    </div>
    <div>
      <label>Warna (opsional)</label>
      <input id="sdColor" class="input" placeholder="mis. Merah:1; Hitam:1">
    </div>
  </div>
  <div class="grid2 mt8">
    <div>
      <label>Tanggal Terjual <span class="badge">wajib</span></label>
      <div class="row">
        <input id="sdDate" type="date" class="input" style="flex:1">
        <button class="btn ghost small" onclick="setToday('sdDate')">Hari Ini</button>
      </div>
    </div>
  </div>
  <div class="row mt16">
    <button class="btn" id="sdSave">Simpan</button>
    <button class="btn ghost" onclick="closeModal('sellDetailModal')">Batal</button>
  </div>
</div></div>

<!-- Detail Item -->
<div class="modal" id="detailModal" onclick="closeModal('detailModal')"><div class="box" onclick="event.stopPropagation()">
  <button class="closeX" onclick="closeModal('detailModal')">✕</button>
  <div id="detailBody"></div>
</div></div>

<!-- Mass Edit -->
<div class="modal" id="massEditModal" onclick="closeModal('massEditModal')"><div class="box" onclick="event.stopPropagation()">
  <button class="closeX" onclick="closeModal('massEditModal')">✕</button>
  <h3>Edit Massal</h3>
  <p class="small">Hanya kolom yang diisi akan diterapkan ke semua item terpilih.</p>
  <div class="grid2 mt8">
    <div><label>Supplier</label><select id="meSup" class="input"><option value="">(kosong)</option></select></div>
    <div><label>Tipe</label><select id="meType" class="input"><option value="">(kosong)</option></select></div>
  </div>
  <div class="grid2 mt8">
    <div><label>Ukuran</label><select id="meSize" class="input"><option value="">(kosong)</option></select></div>
    <div><label>Kemasan</label><select id="mePack" class="input"><option value="">(kosong)</option></select></div>
  </div>
  <div class="row mt16">
    <button class="btn" id="meApply">Terapkan</button>
    <button class="btn ghost" onclick="closeModal('massEditModal')">Batal</button>
  </div>
</div></div>

<!-- QR Code Modal -->
<div class="modal" id="qrModal" onclick="closeModal('qrModal')">
  <div class="box" onclick="event.stopPropagation()">
    <button class="closeX" onclick="closeModal('qrModal')">✕</button>
    <h3>QR Code Produk</h3>
    <div id="qrCodeContainer" style="text-align: center; padding: 20px;"></div>
    <div class="row mt12" style="justify-content: center;">
      <button class="btn" onclick="printQRCode()">Print QR Code</button>
    </div>
  </div>
</div>

<!-- Scan QR Modal -->
<div class="modal" id="scanModal" onclick="closeModal('scanModal')">
  <div class="box" onclick="event.stopPropagation()">
    <button class="closeX" onclick="closeModal('scanModal')">✕</button>
    <h3>Scan QR Code</h3>
    <div id="qrScanner" style="width: 100%; height: 300px; background: #f1f5f9; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
      <div id="scannerContainer" style="width: 100%; height: 100%;"></div>
    </div>
    <div class="row mt12" style="justify-content: center;">
      <button class="btn red" id="btnStopScan" onclick="stopQRScanner()">Stop Scan</button>
    </div>
  </div>
</div>

<!-- Camera Modal -->
<div class="modal" id="cameraModal" onclick="closeModal('cameraModal')">
  <div class="box" onclick="event.stopPropagation()">
    <button class="closeX" onclick="closeCamera()">✕</button>
    <h3>Ambil Foto</h3>
    <div id="cameraContainer" style="width: 100%; height: 400px; background: #000; border-radius: 12px; overflow: hidden; position: relative;">
      <video id="cameraVideo" autoplay playsinline style="width: 100%; height: 100%; object-fit: cover;"></video>
      <canvas id="cameraCanvas" style="display: none;"></canvas>
    </div>
    <div class="row mt12" style="justify-content: center;">
      <button class="btn red" id="btnCapture" onclick="capturePhoto()">Ambil Foto</button>
      <button class="btn ghost" id="btnRetake" onclick="retakePhoto()" style="display: none;">Ulangi</button>
      <button class="btn green" id="btnSavePhoto" onclick="savePhoto()" style="display: none;">Simpan Foto</button>
    </div>
  </div>
</div>

<!-- Custom Report Builder Modal -->
<div class="modal" id="customReportModal" onclick="closeModal('customReportModal')">
  <div class="box" onclick="event.stopPropagation()">
    <button class="closeX" onclick="closeModal('customReportModal')">✕</button>
    <h3>Laporan Custom</h3>
    
    <div class="custom-report-builder">
      <h4>Pilih Kolom</h4>
      <div class="column-selector" id="columnSelector">
        <!-- Columns will be populated by JavaScript -->
      </div>
      
      <h4>Filter Data</h4>
      <div class="filter-conditions" id="filterConditions">
        <div class="filter-row">
          <select class="input" id="filterField">
            <option value="status">Status</option>
            <option value="type">Tipe</option>
            <option value="supplier">Supplier</option>
            <option value="size">Ukuran</option>
            <option value="totalQty">Jumlah Stok</option>
          </select>
          <select class="input" id="filterOperator">
            <option value="equals">Sama dengan</option>
            <option value="contains">Mengandung</option>
            <option value="greater">Lebih besar dari</option>
            <option value="less">Lebih kecil dari</option>
          </select>
          <input class="input" id="filterValue" placeholder="Nilai filter">
          <button class="btn small" onclick="addFilter()">+ Tambah Filter</button>
        </div>
        <div id="activeFilters"></div>
      </div>
      
      <div class="row mt16">
        <button class="btn" onclick="generateCustomReport()">Generate Laporan</button>
        <button class="btn ghost" onclick="closeModal('customReportModal')">Batal</button>
      </div>
    </div>
  </div>
</div>

<!-- Zoom -->
<div id="zoomBox" onclick="this.style.display='none'"><img src="" alt=""></div>

<!-- Modal Kecil: Pilihan Tanggal N/A -->
<div class="modal" id="naModal" onclick="closeModal('naModal')">
  <div class="box" onclick="event.stopPropagation()">
    <button class="closeX" onclick="closeModal('naModal')">✕</button>
    <h3 id="naTitle">Informasi Tanggal</h3>
    <p class="mt8">Apakah ada informasi tanggal untuk field ini?</p>
    <div class="row mt12">
      <button class="btn" id="naYes">Iya (pilih tanggal)</button>
      <button class="btn ghost" id="naNo">Tidak Ada Informasi Tanggal (N/A)</button>
    </div>
  </div>
</div>

<!-- Password Modal -->
<div class="modal" id="passModal" onclick="closePass(false)">
  <div class="box" onclick="event.stopPropagation()">
    <button class="closeX" onclick="closePass(false)">✕</button>
    <h3 id="passTitle">Masukkan Password</h3>
    <div class="password-container">
      <input id="passInput" type="password" class="input mt8" placeholder="Password">
      <button class="password-toggle" type="button" onclick="togglePasswordVisibility()">show</button>
    </div>
    <div id="passErr" class="err hidden">Password salah.</div>
    <div class="row mt12">
      <button class="btn" onclick="submitPass()">OK</button>
      <button class="btn ghost" onclick="closePass(false)">Batal</button>
    </div>
  </div>
</div>

<!-- Success Modal -->
<div class="modal" id="successModal" onclick="closeModal('successModal')">
  <div class="box" onclick="event.stopPropagation()">
    <button class="closeX" onclick="closeModal('successModal')">✕</button>
    <h3>Berhasil</h3>
    <p id="successMessage" class="mt8">Aksi berhasil dilakukan.</p>
    <div class="row mt16" style="justify-content: center;">
      <button class="btn" onclick="closeModal('successModal'); refreshData();">Oke</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast"></div>

<!-- PWA Install Button -->
<button id="installBtn" class="hidden">Install App</button>

<script>
/* ========= ENKRIPSI DATA ========= */
const ENCRYPTION_KEY = "mujur-bikes-v8-encryption-key-2024"; // Bisa diganti

// Fungsi enkripsi sederhana menggunakan AES simulation
function encryptData(data) {
    try {
        const dataStr = JSON.stringify(data);
        let result = '';
        for (let i = 0; i < dataStr.length; i++) {
            result += String.fromCharCode(dataStr.charCodeAt(i) ^ ENCRYPTION_KEY.charCodeAt(i % ENCRYPTION_KEY.length));
        }
        return btoa(result);
    } catch (error) {
        console.error('Encryption error:', error);
        return null;
    }
}

function decryptData(encryptedData) {
    try {
        const decoded = atob(encryptedData);
        let result = '';
        for (let i = 0; i < decoded.length; i++) {
            result += String.fromCharCode(decoded.charCodeAt(i) ^ ENCRYPTION_KEY.charCodeAt(i % ENCRYPTION_KEY.length));
        }
        return JSON.parse(result);
    } catch (error) {
        console.error('Decryption error:', error);
        return null;
    }
}

function getDefaultStore() {
    return {
        items:[],
        suppliers:["VL","JY","KL","N/A"],
        employees:["N/A","Andi","Nursan","Sudi"],
        types:["BMX","Mini","MTB","Road","Lipat"],
        sizes:['12"','16"','18"','20"','24"','26"','27.5"','29"'],
        packs:["Dus","Karung","N/A"],
        locations:["Toko","Gudang"],
        history:[],
        settings: {
            autoRefresh: true,
            autoBackup: true,
            // Tambahkan setting password
            masterPassword: "pabalusepeda",
            userPasswords: {
                admin: "admin123",
                staff: "staff123"
            }
        }
    };
}

/* ========= FIREBASE CONFIGURATION ========= */
// GANTI DENGAN KONFIGURASI FIREBASE ANDA SENDIRI
const firebaseConfig = {
  apiKey: "AIzaSyBeDyMBZJywkawfu61AW7dHvWeAXcJuHV4",
  authDomain: "mujur-bikes-v8-22bfd.firebaseapp.com",
  databaseURL: "https://mujur-bikes-v8-22bfd-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "mujur-bikes-v8-22bfd",
  storageBucket: "mujur-bikes-v8-22bfd.firebasestorage.app",
  messagingSenderId: "967663855989",
  appId: "1:967663855989:web:27f0cc56ead59590428b3c"
};

// Initialize Firebase
try {
  firebase.initializeApp(firebaseConfig);
  console.log('Firebase initialized successfully');
} catch (error) {
  console.error('Firebase initialization error:', error);
}

const database = firebase.database();
const auth = firebase.auth();

// Firebase state
let isOnline = false;
let syncInProgress = false;

/* ========= State & Utils ========= */
const $=id=>document.getElementById(id);
let route="dashboard", multi=false, selectedIds=new Set(), currentList=[], currentIndex=-1, editingId=null, asmPick=null, sellPick=null;

// Pagination state
let currentPage = 1;
let itemsPerPage = 10;

// Fitur baru: Auto refresh dan backup
let autoRefreshInterval = null;
let autoBackupInterval = null;
let isAutoRefreshEnabled = true;
let isAutoBackupEnabled = true;

// Custom report state
let selectedColumns = ['name', 'type', 'size', 'status', 'totalQty'];
let activeFilters = [];

// detail re-open context agar box tidak menghilang
let _detailCtx=null;

// tanggal N/A flow
let _naTarget=null, _naContinue=null;

// password modal flow
let _passResolve=null, _passTitle="Masukkan Password";

// PWA install prompt
let deferredPrompt;

// QR Code dan Camera state
let qrScanner = null;
let cameraStream = null;
let currentPhotoItemId = null;

// Modifikasi inisialisasi store untuk handle data terenkripsi
let store = (function() {
    const stored = localStorage.getItem("mujur-v80");
    if (!stored) {
        return getDefaultStore();
    }
    
    // Coba decrypt dulu
    try {
        const decrypted = decryptData(stored);
        if (decrypted) {
            return decrypted;
        }
    } catch (e) {
        console.log('Data tidak terenkripsi, menggunakan fallback');
    }
    
    // Fallback untuk data lama yang belum terenkripsi
    try {
        const parsed = JSON.parse(stored);
        // Pastikan settings ada
        if (!parsed.settings) {
            parsed.settings = getDefaultStore().settings;
        }
        if (!parsed.settings.userPasswords) {
            parsed.settings.userPasswords = getDefaultStore().settings.userPasswords;
        }
        if (!parsed.settings.masterPassword) {
            parsed.settings.masterPassword = getDefaultStore().settings.masterPassword;
        }
        return parsed;
    } catch (e) {
        console.error('Error parsing stored data:', e);
        return getDefaultStore();
    }
})();

/* ========= User Management ========= */
let currentUser = null;

const ROLE_PERMISSIONS = {
  admin: ['view', 'add', 'edit', 'delete', 'import', 'export', 'master', 'reports', 'backup', 'restore'],
  staff: ['view', 'add', 'edit', 'delete', 'import', 'export', 'reports'] // Staff bisa hapus
};

// ========= FITUR BARU: MOBILE APP/PWA =========

// Service Worker Registration
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('/sw.js').then(function(registration) {
      console.log('SW registered: ', registration);
    }).catch(function(registrationError) {
      console.log('SW registration failed: ', registrationError);
    });
  });
}

// PWA Install Prompt
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  $('installBtn').classList.remove('hidden');
});

$('installBtn').addEventListener('click', async () => {
  if (!deferredPrompt) return;
  
  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  
  if (outcome === 'accepted') {
    $('installBtn').classList.add('hidden');
  }
  
  deferredPrompt = null;
});

window.addEventListener('appinstalled', () => {
  $('installBtn').classList.add('hidden');
  deferredPrompt = null;
  toast('Aplikasi berhasil diinstall!');
});

// ========= FITUR BARU: DASHBOARD REAL-TIME =========

function initRealTimeFeatures() {
  // Auto refresh dashboard
  if (isAutoRefreshEnabled) {
    autoRefreshInterval = setInterval(() => {
      if (route === 'dashboard') {
        refreshData();
      }
    }, 30000); // Refresh setiap 30 detik
  }
  
  // Auto backup
  if (isAutoBackupEnabled) {
    autoBackupInterval = setInterval(() => {
      autoBackup();
    }, 300000); // Backup setiap 5 menit
  }
}

function toggleAutoRefresh() {
  isAutoRefreshEnabled = !isAutoRefreshEnabled;
  const btn = $('#autoRefreshBtn');
  
  if (isAutoRefreshEnabled) {
    btn.textContent = 'Auto: ON';
    initRealTimeFeatures();
    toast('Auto refresh diaktifkan');
  } else {
    btn.textContent = 'Auto: OFF';
    clearInterval(autoRefreshInterval);
    toast('Auto refresh dimatikan');
  }
  
  store.settings.autoRefresh = isAutoRefreshEnabled;
  save();
}

// ========= FITUR BARU: AUTO BACKUP CLOUD =========

function autoBackup() {
  if (!isAutoBackupEnabled) return;
  
  const backupData = {
    version: 'mujur-bikes-v8.0',
    timestamp: new Date().toISOString(),
    data: store,
    user: currentUser ? currentUser.username : 'unknown'
  };
  
  // Simpan ke localStorage sebagai simulasi cloud backup
  const backupKey = `mujur-backup-${new Date().toISOString().split('T')[0]}`;
  localStorage.setItem(backupKey, JSON.stringify(backupData));
  
  // Update status backup
  $('#backupStatus').textContent = `Auto Backup: Aktif - Terakhir backup ${new Date().toLocaleTimeString('id-ID')}`;
  
  // Hapus backup yang lebih dari 7 hari
  cleanupOldBackups();
}

function cleanupOldBackups() {
  const oneWeekAgo = new Date();
  oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
  
  Object.keys(localStorage).forEach(key => {
    if (key.startsWith('mujur-backup-')) {
      const dateStr = key.replace('mujur-backup-', '');
      const backupDate = new Date(dateStr);
      if (backupDate < oneWeekAgo) {
        localStorage.removeItem(key);
      }
    }
  });
}

function restoreFromAutoBackup() {
  // Cari backup terbaru
  let latestBackupKey = null;
  let latestDate = new Date(0);
  
  Object.keys(localStorage).forEach(key => {
    if (key.startsWith('mujur-backup-')) {
      const dateStr = key.replace('mujur-backup-', '');
      const backupDate = new Date(dateStr);
      if (backupDate > latestDate) {
        latestDate = backupDate;
        latestBackupKey = key;
      }
    }
  });
  
  if (latestBackupKey) {
    const backupData = JSON.parse(localStorage.getItem(latestBackupKey));
    if (backupData && backupData.data) {
      store = backupData.data;
      save();
      showSuccess(`Data berhasil direstore dari backup ${latestDate.toLocaleDateString('id-ID')}`);
      return true;
    }
  }
  return false;
}

// ========= FITUR BARU: CUSTOM REPORT BUILDER =========

function showCustomReportBuilder() {
  // Setup column selector
  const columns = [
    { id: 'name', label: 'Nama', checked: true },
    { id: 'type', label: 'Tipe', checked: true },
    { id: 'size', label: 'Ukuran', checked: true },
    { id: 'supplier', label: 'Supplier', checked: false },
    { id: 'status', label: 'Status', checked: true },
    { id: 'totalQty', label: 'Jumlah Stok', checked: true },
    { id: 'arrivalDate', label: 'Tanggal Datang', checked: false },
    { id: 'pack', label: 'Kemasan', checked: false }
  ];
  
  let columnHTML = '';
  columns.forEach(col => {
    columnHTML += `
      <label style="display: flex; align-items: center; gap: 8px;">
        <input type="checkbox" ${col.checked ? 'checked' : ''} value="${col.id}" onchange="updateSelectedColumns()">
        ${col.label}
      </label>
    `;
  });
  
  $('#columnSelector').innerHTML = columnHTML;
  $('#activeFilters').innerHTML = '';
  activeFilters = [];
  
  showModal('customReportModal');
}

function updateSelectedColumns() {
  selectedColumns = [];
  $('#columnSelector').querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
    selectedColumns.push(checkbox.value);
  });
}

function addFilter() {
  const field = $('#filterField').value;
  const operator = $('#filterOperator').value;
  const value = $('#filterValue').value.trim();
  
  if (!value) {
    alert('Masukkan nilai filter');
    return;
  }
  
  const filter = { field, operator, value };
  activeFilters.push(filter);
  
  renderActiveFilters();
}

function renderActiveFilters() {
  let html = '';
  activeFilters.forEach((filter, index) => {
    html += `
      <div class="filter-row">
        <span>${filter.field} ${getOperatorText(filter.operator)} "${filter.value}"</span>
        <button class="btn ghost small" onclick="removeFilter(${index})">Hapus</button>
      </div>
    `;
  });
  $('#activeFilters').innerHTML = html;
}

function getOperatorText(operator) {
  switch(operator) {
    case 'equals': return '=';
    case 'contains': return 'mengandung';
    case 'greater': return '>';
    case 'less': return '<';
    default: return operator;
  }
}

function removeFilter(index) {
  activeFilters.splice(index, 1);
  renderActiveFilters();
}

function generateCustomReport() {
  if (selectedColumns.length === 0) {
    alert('Pilih minimal satu kolom');
    return;
  }
  
  const startDate = $('#reportStartDate').value;
  const endDate = $('#reportEndDate').value;
  
  let filteredItems = store.items.filter(item => {
    // Filter by date range
    if (startDate && endDate && item.arrivalDate && item.arrivalDate !== 'N/A') {
      if (item.arrivalDate < startDate || item.arrivalDate > endDate) {
        return false;
      }
    }
    
    // Apply custom filters
    for (const filter of activeFilters) {
      const itemValue = String(item[filter.field] || '').toLowerCase();
      const filterValue = filter.value.toLowerCase();
      
      switch(filter.operator) {
        case 'equals':
          if (itemValue !== filterValue) return false;
          break;
        case 'contains':
          if (!itemValue.includes(filterValue)) return false;
          break;
        case 'greater':
          if (Number(itemValue) <= Number(filterValue)) return false;
          break;
        case 'less':
          if (Number(itemValue) >= Number(filterValue)) return false;
          break;
      }
    }
    
    return true;
  });
  
  // Generate report table
  let html = `<h3>Laporan Custom (${startDate || 'Semua'} s/d ${endDate || 'Semua'})</h3>`;
  html += `<div class="report-table-container">`;
  html += `<table class="table"><thead><tr>`;
  
  // Header columns
  selectedColumns.forEach(col => {
    let colName = '';
    switch(col) {
      case 'name': colName = 'Nama'; break;
      case 'type': colName = 'Tipe'; break;
      case 'size': colName = 'Ukuran'; break;
      case 'supplier': colName = 'Supplier'; break;
      case 'status': colName = 'Status'; break;
      case 'totalQty': colName = 'Jumlah Stok'; break;
      case 'arrivalDate': colName = 'Tanggal Datang'; break;
      case 'pack': colName = 'Kemasan'; break;
    }
    html += `<th>${colName}</th>`;
  });
  
  html += `</tr></thead><tbody>`;
  
  // Data rows
  filteredItems.forEach(item => {
    html += `<tr>`;
    selectedColumns.forEach(col => {
      let value = item[col] || '-';
      if (col === 'status') {
        value = value === 'masuk' ? 'Belum Rakit' : 
                value === 'dirakit' ? 'Sudah Rakit' : 'Terjual';
      }
      html += `<td>${value}</td>`;
    });
    html += `</tr>`;
  });
  
  html += `</tbody></table>`;
  html += `</div>`;
  html += `<div class="mt12"><strong>Total Data: ${filteredItems.length} item</strong></div>`;
  
  $('#laporanResult').innerHTML = html;
  closeModal('customReportModal');
}

/* ========= QR Code Functions ========= */
function generateQRCode(itemId) {
  console.log('🚀 generateQRCode called with itemId:', itemId);
  console.log('📦 Available QRCode library:', typeof QRCode);
  
  const item = store.items.find(x => x.id === itemId);
  console.log('🔍 Item found:', item);
  
  if (!item) {
    console.error('❌ Item not found for ID:', itemId);
    alert('Item tidak ditemukan');
    return;
  }

  const qrData = JSON.stringify({
    id: item.id,
    name: item.name,
    type: item.type,
    size: item.size,
    supplier: item.supplier,
    code: item.code || genCode(item.supplier, item.arrivalDate),
    timestamp: new Date().toISOString()
  });

  const qrContainer = $('#qrCodeContainer');
  
  // Clear dan setup container
  qrContainer.innerHTML = `
    <div style="text-align: center; padding: 20px;">
      <div id="qrLoading">Membuat QR Code...</div>
      <div id="qrResult" style="display: none;"></div>
    </div>
  `;

  // Coba generate QR code dengan timeout fallback
  const qrTimeout = setTimeout(() => {
    showQRCodeFallback(qrData, item);
  }, 3000);

  try {
    // Create canvas untuk QR code
    const canvas = document.createElement('canvas');
    canvas.width = 200;
    canvas.height = 200;
    canvas.style.border = '1px solid #ddd';
    canvas.style.borderRadius = '8px';
    
    QRCode.toCanvas(canvas, qrData, {
      width: 180,
      margin: 1,
      color: {
        dark: '#000000',
        light: '#FFFFFF'
      }
    }, function(error) {
      clearTimeout(qrTimeout);
      
      if (error) {
        console.error('QR Code error:', error);
        showQRCodeFallback(qrData, item);
        return;
      }
      
      // Success - tampilkan QR code
      const resultDiv = $('#qrResult');
      const loadingDiv = $('#qrLoading');
      
      if (loadingDiv) loadingDiv.style.display = 'none';
      if (resultDiv) resultDiv.style.display = 'block';
      
      qrContainer.innerHTML = '';
      qrContainer.appendChild(canvas);
      
      // Tambahkan info produk
      const productInfo = document.createElement('div');
      productInfo.className = 'qr-product-info';
      productInfo.innerHTML = `
        <div class="qr-product-name">${item.name}</div>
        <div class="qr-product-details">${item.type} • ${item.size}</div>
        <div class="qr-product-details">Supplier: ${item.supplier || 'N/A'}</div>
        <div class="qr-product-details">Kode: ${item.code || 'No Code'}</div>
        <div class="qr-product-details" style="font-size: 10px; margin-top: 8px;">ID: ${item.id.substring(0, 8)}...</div>
      `;
      qrContainer.appendChild(productInfo);
    });
    
  } catch (error) {
    clearTimeout(qrTimeout);
    console.error('QR Code generation failed:', error);
    showQRCodeFallback(qrData, item);
  }

  showModal('qrModal');
}

function showQRCodeFallback(qrData, item) {
  const qrContainer = $('#qrCodeContainer');
  
  qrContainer.innerHTML = `
    <div style="text-align: center; padding: 20px;">
      <div style="font-size: 48px; margin-bottom: 15px;">📄</div>
      <div style="font-weight: bold; margin-bottom: 15px;">Data QR Code</div>
      
      <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: left;">
        <div style="font-weight: bold; margin-bottom: 8px;">${item.name}</div>
        <div style="color: #666; margin-bottom: 4px;">${item.type} • ${item.size}</div>
        <div style="color: #666; font-size: 12px;">Supplier: ${item.supplier || 'N/A'}</div>
        <div style="color: #666; font-size: 12px;">Kode: ${item.code || 'No Code'}</div>
      </div>
      
      <div style="background: white; padding: 12px; border-radius: 6px; border: 1px dashed #ccc;">
        <div style="font-size: 11px; font-family: monospace; word-break: break-all; color: #666;">
          ${qrData}
        </div>
      </div>
      
      <div style="margin-top: 15px; font-size: 12px; color: #999;">
        Salin data di atas untuk generate QR code external
      </div>
    </div>
  `;
}

function printQRCode() {
  const printContent = $('#qrCodeContainer').innerHTML;
  const originalContent = document.body.innerHTML;

  document.body.innerHTML = printContent;
  window.print();
  document.body.innerHTML = originalContent;
  
  // Setelah print, kita perlu render ulang karena body diubah
  render();
}

function openQRScanner() {
  console.log('🔍 openQRScanner called');
  console.log('📱 Scanner container:', $('#scannerContainer'));
  
  showModal('scanModal');
  
  // Gunakan approach yang lebih sederhana dan reliable
  $('#scannerContainer').innerHTML = `
    <div class="scanner-fallback-container">
      <div style="font-size: 64px; margin-bottom: 20px;">🔍</div>
      <div style="font-weight: bold; margin-bottom: 10px; font-size: 20px;">Scanner QR Code</div>
      <div style="margin-bottom: 20px; text-align: center; color: #666; line-height: 1.5;">
        Pilih metode scanning:
      </div>
      
      <div style="display: flex; flex-direction: column; gap: 10px; width: 100%; max-width: 250px;">
        <button class="btn" onclick="simulateQRScan()" style="padding: 12px;">
          <span style="font-size: 20px; margin-right: 8px;">🎲</span>
          Scan Item Random
        </button>
        <button class="btn ghost" onclick="testManualQRInput()" style="padding: 12px;">
          <span style="font-size: 20px; margin-right: 8px;">⌨️</span>
          Input Manual Kode
        </button>
      </div>
      
      <div style="font-size: 12px; color: #999; margin-top: 25px; text-align: center;">
        Tips: Untuk scanning QR nyata, gunakan aplikasi scanner QR<br>
        dan input kode manual di atas.
      </div>
    </div>
  `;
}

function simulateQRScan() {
  const availableItems = store.items.filter(item => item.status === 'masuk' || item.status === 'dirakit');
  if (availableItems.length === 0) {
    alert('Tidak ada item yang bisa di-scan');
    return;
  }
  
  const randomItem = availableItems[Math.floor(Math.random() * availableItems.length)];
  
  $('#scannerContainer').innerHTML = `
    <div class="scanner-success">
      <div style="color: var(--green); font-size: 64px; margin-bottom: 15px;">✅</div>
      <div style="font-weight: bold; margin-bottom: 15px; font-size: 22px;">Berhasil di-scan!</div>
      <div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; text-align: left;">
        <div style="font-weight: bold; margin-bottom: 8px;">${randomItem.name}</div>
        <div style="color: #666; margin-bottom: 5px;">${randomItem.type} • ${randomItem.size}</div>
        <div style="color: #666; font-size: 12px;">Kode: ${randomItem.code || 'No Code'}</div>
      </div>
      <div style="display: flex; gap: 10px;">
        <button class="btn" onclick="openDetailFromScan('${randomItem.id}')">Lihat Detail</button>
        <button class="btn ghost" onclick="openQRScanner()">Scan Lagi</button>
      </div>
    </div>
  `;
}

function testManualQRInput() {
  const itemCode = prompt("Masukkan kode item atau nama item:");
  if (itemCode === null || itemCode.trim() === '') return;
  
  // Cari item berdasarkan kode atau nama
  let item = store.items.find(x => 
    x.code === itemCode || 
    x.name.toLowerCase().includes(itemCode.toLowerCase()) ||
    x.id === itemCode
  );
  
  if (!item) {
    // Jika tidak ditemukan, coba item random
    const availableItems = store.items.filter(item => item.status === 'masuk' || item.status === 'dirakit');
    if (availableItems.length > 0) {
      item = availableItems[Math.floor(Math.random() * availableItems.length)];
      alert('Item tidak ditemukan. Menampilkan item random sebagai contoh.');
    } else {
      alert('Item tidak ditemukan dan tidak ada item tersedia');
      return;
    }
  }
  
  openDetailFromScan(item.id);
}

function openDetailFromScan(itemId) {
  closeModal('scanModal');
  const item = store.items.find(x => x.id === itemId);
  if (item) {
    // Cari item di current list atau buka detail langsung
    const index = currentList.findIndex(x => x.id === itemId);
    if (index !== -1) {
      openDetail(item, index);
    } else {
      openDetail(item, 0);
    }
  }
}

function stopQRScanner() {
  closeModal('scanModal');
  // Di implementasi nyata, hentikan scanner di sini
  if (cameraStream) {
    cameraStream.getTracks().forEach(track => {
      track.stop();
    });
    cameraStream = null;
  }
}

/* ========= Camera Functions ========= */
function takePhoto(itemId) {
  console.log('📷 takePhoto called with itemId:', itemId);
  console.log('🔧 Camera support check:', {
    hasMediaDevices: !!navigator.mediaDevices,
    hasGetUserMedia: !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia),
    isSecure: window.location.protocol === 'https:'
  });
  
  currentPhotoItemId = itemId;
  showModal('cameraModal');
  
  // Reset camera container dengan approach yang lebih sederhana
  $('#cameraContainer').innerHTML = `
    <div id="cameraPreview" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #000; border-radius: 12px;">
      <div id="cameraLoading" style="color: white; text-align: center;">
        <div style="font-size: 48px; margin-bottom: 20px;">📷</div>
        <div>Menginisialisasi kamera...</div>
      </div>
      <video id="cameraVideo" autoplay playsinline style="width: 100%; height: 100%; object-fit: cover; display: none;"></video>
      <canvas id="cameraCanvas" style="display: none;"></canvas>
    </div>
  `;
  
  startCamera();
}

function startCamera() {
  const video = $('#cameraVideo');
  const loading = $('#cameraLoading');
  
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    showCameraFallback();
    return;
  }

  // Coba akses kamera dengan approach yang lebih sederhana
  navigator.mediaDevices.getUserMedia({ 
    video: {
      facingMode: 'environment',
      width: { ideal: 640 },
      height: { ideal: 480 }
    },
    audio: false 
  }).then(function(stream) {
    cameraStream = stream;
    video.srcObject = stream;
    
    // Tampilkan video dan sembunyikan loading
    video.style.display = 'block';
    if (loading) loading.style.display = 'none';
    
    video.play().catch(function(err) {
      console.error('Error playing video:', err);
      showCameraFallback();
    });
    
  }).catch(function(err) {
    console.error('Error accessing camera:', err);
    showCameraFallback();
  });
}

function showCameraFallback() {
  $('#cameraContainer').innerHTML = `
    <div class="camera-fallback-container">
      <div style="font-size: 48px; margin-bottom: 20px;">❌</div>
      <div style="margin-bottom: 15px; font-size: 18px;">Kamera Tidak Dapat Diakses</div>
      <div style="font-size: 14px; margin-bottom: 20px; text-align: center;">
        Browser tidak dapat mengakses kamera.<br>
        Pastikan izin kamera sudah diaktifkan.
      </div>
      <button class="btn" onclick="uploadPhotoFallback('${currentPhotoItemId}')">Unggah Foto dari File</button>
      <button class="btn ghost" onclick="closeCamera()" style="margin-top: 10px;">Tutup</button>
    </div>
  `;
}

function uploadPhotoFallback(itemId) {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  
  input.onchange = function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(event) {
      const imageData = event.target.result;
      const item = store.items.find(x => x.id === itemId);
      
      if (item) {
        item.image = imageData;
        save();
        showSuccess("Foto berhasil diunggah");
        
        // Refresh detail view jika terbuka
        const currentItem = store.items.find(x => x.id === itemId);
        if (currentItem) {
          const currentIndex = currentList.findIndex(x => x.id === itemId);
          if (currentIndex !== -1) {
            openDetail(currentItem, currentIndex);
          }
        }
      }
    };
    
    reader.readAsDataURL(file);
  };
  
  input.click();
}

function capturePhoto() {
  const video = $('#cameraVideo');
  const canvas = $('#cameraCanvas');
  const context = canvas.getContext('2d');
  
  if (!video.srcObject) {
    alert('Kamera tidak aktif');
    return;
  }

  // Set canvas size
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  
  // Capture frame
  context.drawImage(video, 0, 0, canvas.width, canvas.height);
  
  // Tampilkan preview
  $('#cameraContainer').innerHTML = `
    <div style="text-align: center;">
      <img src="${canvas.toDataURL('image/jpeg')}" style="max-width: 100%; max-height: 350px; border-radius: 8px;">
      <div style="margin-top: 10px; color: white;">Preview Foto</div>
    </div>
  `;
  
  // Update tombol
  $('#btnCapture').style.display = 'none';
  $('#btnRetake').style.display = 'block';
  $('#btnSavePhoto').style.display = 'block';
  
  // Stop kamera
  stopCamera();
}

function retakePhoto() {
  // Kembali ke mode kamera
  $('#cameraContainer').innerHTML = `
    <div id="cameraPreview" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #000; border-radius: 12px;">
      <div id="cameraLoading" style="color: white; text-align: center;">
        <div style="font-size: 48px; margin-bottom: 20px;">📷</div>
        <div>Menginisialisasi kamera...</div>
      </div>
      <video id="cameraVideo" autoplay playsinline style="width: 100%; height: 100%; object-fit: cover; display: none;"></video>
      <canvas id="cameraCanvas" style="display: none;"></canvas>
    </div>
  `;
  startCamera();
}

function savePhoto() {
  if (!currentPhotoItemId) return;
  
  const canvas = $('#cameraCanvas');
  const imageData = canvas.toDataURL('image/jpeg');
  
  const item = store.items.find(x => x.id === currentPhotoItemId);
  if (item) {
    item.image = imageData;
    
    // Jika ada item dengan nama, tipe, dan ukuran yang sama, update juga gambarnya
    store.items.forEach(it => {
      if (it.name === item.name && it.type === item.type && it.size === item.size && !it.image) {
        it.image = imageData;
      }
    });
    
    save();
    showSuccess("Foto berhasil disimpan");
    
    // Refresh detail view
    const currentItem = store.items.find(x => x.id === currentPhotoItemId);
    if (currentItem) {
      const currentIndex = currentList.findIndex(x => x.id === currentPhotoItemId);
      if (currentIndex !== -1) {
        openDetail(currentItem, currentIndex);
      }
    }
  }
  
  closeCamera();
}

function closeCamera() {
  stopCamera();
  closeModal('cameraModal');
}

function stopCamera() {
  if (cameraStream) {
    cameraStream.getTracks().forEach(track => {
      track.stop();
    });
    cameraStream = null;
  }
}

// ========= FUNGSI UTAMA YANG SUDAH ADA =========

function save(){ 
  // Tambahkan timestamp
  store.lastSync = Date.now();
  
  // Enkripsi data sebelum menyimpan ke localStorage
  const encryptedData = encryptData(store);
  if (encryptedData) {
    localStorage.setItem("mujur-v80", encryptedData);
  } else {
    // Fallback ke penyimpanan tanpa enkripsi jika error
    localStorage.setItem("mujur-v80", JSON.stringify(store));
  }
  
  // Auto backup ketika ada perubahan data
  if (isAutoBackupEnabled) {
    setTimeout(autoBackup, 1000);
  }
  
  // Selalu render ulang setelah save untuk memastikan UI update
  if(route === "master") {
    renderMaster();
  } else if(route === "dashboard") {
    renderDashboard();
  } else if(route === "laporan") {
    renderHistory();
  } else {
    renderList();
  }
  
  // Check notifications after save
  if (currentUser) {
    setTimeout(checkStockNotifications, 500);
  }
}

function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
function ddmmyy(d){const [y,m,dd]=d.split("-");return dd+m+y.slice(-2);}
function isoFromDDMMYY(s){ if(!s) return ""; s=s.replace(/[^\d]/g,""); if(s.length!==6) return ""; const dd=s.slice(0,2),mm=s.slice(2,4),yy=s.slice(4); return `20${yy}-${mm}-${dd}`;}
function genCode(sup,arr){ if(!sup||!arr||arr==="N/A") return null; return sup+ddmmyy(arr); }
function min1(inp){ let v=parseInt(inp.value||0); if(isNaN(v)||v<1) v=1; inp.value=v; }
function stepNum(id,delta){ const el=$(id); let v=parseInt(el.value||0)||0; v+=delta; if(v<1) v=1; el.value=v; }
function setToday(id){ const t=new Date().toISOString().slice(0,10); const el=$(id); el.value=t; el.dataset.na=""; }
function toast(msg){ const t=$("toast"); t.textContent=msg; t.style.display="block"; clearTimeout(t._to); t._to=setTimeout(()=>t.style.display="none",2000); }
function chips(arr,key='color',val='qty'){ return (arr||[]).map(x=>`${x[key]}:${x[val]}`).join("; "); }
function esc(s){return (s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");}

// Fitur Baru: Validasi urutan tanggal
function validateDateSequence(arrivalDate, assemblyDate, saleDate) {
    const messages = [];
    
    if (assemblyDate && arrivalDate && assemblyDate < arrivalDate) {
        messages.push("Tanggal rakit tidak boleh lebih awal dari tanggal kedatangan");
    }
    
    if (saleDate && assemblyDate && saleDate < assemblyDate) {
        messages.push("Tanggal terjual tidak boleh lebih awal dari tanggal rakit");
    }
    
    if (saleDate && arrivalDate && saleDate < arrivalDate) {
        messages.push("Tanggal terjual tidak boleh lebih awal dari tanggal kedatangan");
    }
    
    return messages;
}

// Fitur Baru: Refresh data
function refreshData() {
  if(route === "master") {
    renderMaster();
  } else if(route === "dashboard") {
    renderDashboard();
  } else if(route === "laporan") {
    renderHistory();
  } else {
    renderList();
  }
  toast("Data diperbarui");
}

// Fitur Baru: Show success modal
function showSuccess(message) {
  $("successMessage").textContent = message;
  showModal("successModal");
}

/* ========= Password Visibility Toggle ========= */
function togglePasswordVisibility() {
  const input = $("passInput");
  const toggle = document.querySelector("#passModal .password-toggle");
  
  if (input.type === "password") {
    input.type = "text";
    toggle.textContent = "hide";
  } else {
    input.type = "password";
    toggle.textContent = "show";
  }
}

function toggleLoginPassword() {
  const input = $('loginPassword');
  const toggle = document.querySelector('#loginModal .password-toggle');
  
  if (input.type === 'password') {
    input.type = 'text';
    toggle.textContent = 'hide';
  } else {
    input.type = 'password';
    toggle.textContent = 'show';
  }
}

/* ========= User Management Functions ========= */
function initAuth() {
  const savedUser = localStorage.getItem('mujur-currentUser');
  if (savedUser) {
    currentUser = JSON.parse(savedUser);
    applyUserPermissions();
    showUserInfo();
  } else {
    showModal('loginModal');
  }
}

function doLogin() {
  const username = $('loginUsername').value;
  const password = $('loginPassword').value;
  
  // Cek password dari settings
  const storedPassword = store.settings.userPasswords[username];
  
  if (storedPassword && storedPassword === password) {
    currentUser = {
      username: username,
      role: username === 'admin' ? 'admin' : 'staff',
      name: username === 'admin' ? 'Administrator' : 'Staff',
      password: password
    };
    
    localStorage.setItem('mujur-currentUser', JSON.stringify(currentUser));
    
    closeModal('loginModal');
    applyUserPermissions();
    showUserInfo();
    toast(`Selamat datang, ${currentUser.name}!`);
    checkStockNotifications();
  } else {
    $('loginErr').classList.remove('hidden');
  }
}

function logout() {
  if (!confirm("Apakah Anda yakin ingin logout?")) {
    return;
  }
  
  currentUser = null;
  localStorage.removeItem('mujur-currentUser');
  isOnline = false;
  
  // Clear form login
  $('loginUsername').value = '';
  $('loginPassword').value = '';
  $('loginErr').classList.add('hidden');
  
  showModal('loginModal');
  toast('Anda telah logout');
}

function applyUserPermissions() {
  const permissions = ROLE_PERMISSIONS[currentUser.role] || [];
  
  // Sembunyikan tombol berdasarkan permission
  const elementsToHide = {
    'add': ['btnAdd', 'btnAddAsm', 'btnAddSell'],
    'edit': ['btnMassEdit'],
    'delete': ['btnMassDelete'],
    'import': ['btnImport'],
    'export': ['btnExport'],
    'master': ['tab[data-route="master"]'],
    'reports': ['tab[data-route="laporan"]'],
    'backup': ['backupBtn'],
    'restore': ['restoreBtn']
  };
  
  Object.keys(elementsToHide).forEach(permission => {
    if (!permissions.includes(permission)) {
      elementsToHide[permission].forEach(id => {
        const element = $(id);
        if (element) {
          element.style.display = 'none';
        }
      });
    }
  });
  
  // Jika tidak ada permission master, redirect dari halaman master
  if (route === 'master' && !permissions.includes('master')) {
    setRoute('dashboard');
  }
  
  // Jika tidak ada permission laporan, redirect dari halaman laporan
  if (route === 'laporan' && !permissions.includes('reports')) {
    setRoute('dashboard');
  }
}

function showUserInfo() {
  // Tambahkan info user di header
  let userInfo = document.getElementById('userInfo');
  if (!userInfo) {
    userInfo = document.createElement('div');
    userInfo.id = 'userInfo';
    userInfo.style.cssText = 'position: absolute; top: 10px; right: 10px; font-size: 12px; color: #64748b;';
    document.querySelector('.container').appendChild(userInfo);
  }
  
  userInfo.innerHTML = `
    <div class="menu" id="userMenu">
      <button class="btn ghost small" style="font-size: 12px; padding: 4px 8px;">
        ${currentUser.name} (${currentUser.role})
      </button>
      <div class="menu-panel">
        <button class="btn" onclick="logout()">Logout</button>
      </div>
    </div>
  `;
  
  // Event listener untuk user menu
  document.getElementById('userMenu').onclick = (e) => {
    e.stopPropagation();
    document.getElementById('userMenu').classList.toggle('open');
  };
}

function closeLogin() {
  if (!currentUser) {
    alert('Anda harus login untuk menggunakan sistem ini.');
    return;
  }
  closeModal('loginModal');
}

/* ========= Password Modal ========= */
function askPass(title="Masukkan Password"){
  // Skip password check for admin users
  if (currentUser && currentUser.role === 'admin') {
    return Promise.resolve(true);
  }
  
  _passTitle=title; 
  $("passTitle").textContent=title; 
  $("passInput").value=""; 
  $("passErr").classList.add("hidden");
  
  // Reset password visibility
  $("passInput").type = "password";
  document.querySelector("#passModal .password-toggle").textContent = "show";
  
  return new Promise(res=>{ 
    _passResolve=res; 
    showModal("passModal"); 
    $("passInput").focus(); 
  });
}

function submitPass(){
  const inputPassword = $("passInput").value;
  const masterPassword = store.settings.masterPassword;
  const ok = inputPassword === masterPassword;
  
  if(!ok){ 
    $("passErr").classList.remove("hidden"); 
    return; 
  }
  closePass(true);
}

function closePass(ok){
  $("passModal").classList.remove("show");
  if(_passResolve){ _passResolve(!!ok); _passResolve=null; }
}

/* ========= Backup & Restore System ========= */
function backupData() {
  if (!currentUser || !ROLE_PERMISSIONS[currentUser.role].includes('backup')) {
    alert('Anda tidak memiliki izin untuk backup data.');
    return;
  }
  
  const backupData = {
    version: 'mujur-bikes-v8.0',
    timestamp: new Date().toISOString(),
    data: store,
    user: currentUser.username
  };
  
  const dataStr = JSON.stringify(backupData, null, 2);
  const dataBlob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(dataBlob);
  
  const a = document.createElement('a');
  a.href = url;
  a.download = `mujur-bikes-backup-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  
  URL.revokeObjectURL(url);
  
  addHistory('backup', { 
    filename: a.download,
    undone: false 
  });
  
  toast('Backup data berhasil!');
}

function restoreData() {
  if (!currentUser || !ROLE_PERMISSIONS[currentUser.role].includes('restore')) {
    alert('Anda tidak memiliki izin untuk restore data.');
    return;
  }
  
  if (!confirm('PERINGATAN: Restore data akan mengganti semua data saat ini. Pastikan Anda sudah backup data terbaru. Lanjutkan?')) {
    return;
  }
  
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  
  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = event => {
      try {
        const backup = JSON.parse(event.target.result);
        
        // Validasi file backup
        if (!backup.data || !backup.data.items) {
          throw new Error('Format file backup tidak valid');
        }
        
        if (backup.version !== 'mujur-bikes-v8.0') {
          if (!confirm('File backup mungkin dari versi yang berbeda. Lanjutkan restore?')) {
            return;
          }
        }
        
        // Ganti data store
        store = backup.data;
        save();
        
        addHistory('restore', {
          filename: file.name,
          timestamp: backup.timestamp,
          undone: false
        });
        
        showSuccess('Data berhasil di-restore! Halaman akan direfresh.');
        setTimeout(() => {
          location.reload();
        }, 2000);
        
      } catch (error) {
        console.error('Restore error:', error);
        alert('Error: File backup tidak valid atau korup.');
      }
    };
    
    reader.readAsText(file);
  };
  
  input.click();
}

function resetData() {
  if (!confirm('Reset akan menghapus semua data dan mengembalikan data demo. Lanjutkan?')) {
    return;
  }
  
  // Hapus semua data
  store = getDefaultStore();
  
  // Tambah data demo
  if(!store.items.length){
    store.items.push({
      id: uid(),
      status: "masuk",
      name: "Centrum 3.0",
      type: "BMX",
      size: '12"',
      supplier: "N/A",
      arrivalDate: "2025-09-20",
      totalQty: 1,
      colors: [{color: "Merah", qty: 1}],
      locations: [{name: "Toko", qty: 1}],
      pack: "Dus",
      image: null,
      assembleLogs: [],
      sellLogs: []
    });
    
    store.items.push({
      id: uid(),
      status: "dirakit",
      name: "Velion 3.0",
      type: "BMX",
      size: '20"',
      supplier: "VL",
      arrivalDate: "2025-09-14",
      totalQty: 2,
      colors: [],
      locations: [{name: "Toko", qty: 2}],
      pack: "Dus",
      image: null,
      assembleLogs: [{date: "2025-09-22", qty: 1, employee: "VL"}],
      sellLogs: []
    });
  }
  
  save();
  showSuccess('Data berhasil direset ke data demo!');
  setTimeout(() => {
    location.reload();
  }, 2000);
}

/* ========= Stock Notification System ========= */
function checkStockNotifications() {
  const lowStockItems = store.items.filter(i => 
    i.status === "masuk" && Number(i.totalQty || 0) <= 2 && Number(i.totalQty || 0) > 0
  );
  
  const zeroStockItems = store.items.filter(i => 
    i.status === "masuk" && Number(i.totalQty || 0) === 0
  );
  
  const criticalItems = store.items.filter(i => 
    i.status === "masuk" && Number(i.totalQty || 0) <= 1
  );
  
  let notifications = [];
  
  if (criticalItems.length > 0) {
    notifications.push({
      type: 'critical',
      message: ` ${criticalItems.length} item stok kritis (≤ 1 unit)`,
      items: criticalItems
    });
  }
  
  if (lowStockItems.length > 0 && criticalItems.length === 0) {
    notifications.push({
      type: 'warning',
      message: ` ${lowStockItems.length} item stok menipis (≤ 2 unit)`,
      items: lowStockItems
    });
  }
  
  if (zeroStockItems.length > 0) {
    notifications.push({
      type: 'info',
      message: ` ${zeroStockItems.length} item stok habis`,
      items: zeroStockItems
    });
  }
  
  showNotifications(notifications);
}

function showNotifications(notifications) {
  const panel = $('#notificationPanel');
  const list = $('#notificationList');
  
  if (notifications.length === 0) {
    panel.classList.add('hidden');
    return;
  }
  
  panel.classList.remove('hidden');
  
  let html = '';
  notifications.forEach(notif => {
    html += `<div class="notification-item" data-type="${notif.type}">
      <strong>${notif.message}</strong>`;
    
    // Tampilkan 3 item pertama
    notif.items.slice(0, 3).forEach(item => {
      html += `<div class="small" style="margin-top: 4px;">• ${item.name} (${item.type} - ${item.size}): ${item.totalQty} unit</div>`;
    });
    
    if (notif.items.length > 3) {
      html += `<div class="small" style="margin-top: 4px;">... dan ${notif.items.length - 3} item lainnya</div>`;
    }
    
    html += `</div>`;
  });
  
  list.innerHTML = html;
}

function closeNotifications() {
  $('#notificationPanel').classList.add('hidden');
}

/* ========= Dashboard ========= */
function renderDashboard() {
  const masuk = store.items.filter(i => i.status === "masuk").length;
  const dirakit = store.items.filter(i => i.status === "dirakit").length;
  const terjual = store.items.filter(i => i.status === "terjual").length;
  const lowStock = store.items.filter(i => i.status === "masuk" && Number(i.totalQty||0) <= 2).length;
  
  // Hitung total tipe sepeda (unik berdasarkan nama+tipe+ukuran)
  const uniqueBikes = new Set();
  store.items.forEach(item => {
    const key = `${item.name}-${item.type}-${item.size}`;
    uniqueBikes.add(key);
  });
  const totalTipe = uniqueBikes.size;
  
  // Hitung total unit sepeda (sum dari semua quantity)
  const totalUnit = store.items.reduce((sum, item) => sum + Number(item.totalQty || 0), 0);
  
  // Hitung statistik tambahan untuk charts
  const totalMasukQty = store.items
    .filter(i => i.status === "masuk")
    .reduce((sum, item) => sum + Number(item.totalQty || 0), 0);
  
  const totalDirakitQty = store.items
    .filter(i => i.status === "dirakit")
    .reduce((sum, item) => sum + Number(item.totalQty || 0), 0);
  
  const totalTerjualQty = store.items
    .filter(i => i.status === "terjual")
    .reduce((sum, item) => sum + Number(item.totalQty || 0), 0);
  
  const maxQty = Math.max(totalMasukQty, totalDirakitQty, totalTerjualQty, 1);
  
  $("dashboardCards").innerHTML = `
    <div class="dashboard-card">
      <div class="dashboard-label">Total Tipe Sepeda</div>
      <div class="dashboard-value">${totalTipe}</div>
    </div>
    <div class="dashboard-card">
      <div class="dashboard-label">Total Unit Sepeda</div>
      <div class="dashboard-value">${totalUnit}</div>
    </div>
    <div class="dashboard-card">
      <div class="dashboard-label">Belum Rakit</div>
      <div class="dashboard-value">${masuk}</div>
    </div>
    <div class="dashboard-card">
      <div class="dashboard-label">Sudah Rakit</div>
      <div class="dashboard-value">${dirakit}</div>
    </div>
    <div class="dashboard-card">
      <div class="dashboard-label">Terjual</div>
      <div class="dashboard-value">${terjual}</div>
    </div>
    <div class="dashboard-card">
      <div class="dashboard-label">Stok Menipis</div>
      <div class="dashboard-value ${lowStock > 0 ? 'red' : ''}">${lowStock}</div>
    </div>
  `;
  
  // Render charts
  renderDashboardCharts(totalMasukQty, totalDirakitQty, totalTerjualQty, maxQty);
}

function renderDashboardCharts(totalMasukQty, totalDirakitQty, totalTerjualQty, maxQty) {
  const chartWidth = 300; // Max width for bars
  
  const masukWidth = (totalMasukQty / maxQty) * chartWidth;
  const dirakitWidth = (totalDirakitQty / maxQty) * chartWidth;
  const terjualWidth = (totalTerjualQty / maxQty) * chartWidth;
  
  $("dashboardCharts").innerHTML = `
    <div class="chart-container">
      <h3>Distribusi Stok</h3>
      <div class="chart-row">
        <div class="chart-label">Belum Rakit</div>
        <div class="chart-bar" style="width: ${masukWidth}px; background: var(--pri);">${totalMasukQty}</div>
        <div class="chart-value">${totalMasukQty} unit</div>
      </div>
      <div class="chart-row">
        <div class="chart-label">Sudah Rakit</div>
        <div class="chart-bar" style="width: ${dirakitWidth}px; background: var(--amber);">${totalDirakitQty}</div>
        <div class="chart-value">${totalDirakitQty} unit</div>
      </div>
      <div class="chart-row">
        <div class="chart-label">Terjual</div>
        <div class="chart-bar" style="width: ${terjualWidth}px; background: var(--green);">${totalTerjualQty}</div>
        <div class="chart-value">${totalTerjualQty} unit</div>
      </div>
    </div>
    
    <div class="chart-container">
      <h3>Trend Bulan Ini</h3>
      <div class="small" style="text-align: center; color: var(--muted); padding: 20px;">
        Data real-time akan ditampilkan di sini<br>
        <span class="real-time-indicator"></span> Terhubung ke sistem real-time
      </div>
    </div>
  `;
}

/* ========= Modal Tanggal N/A (custom, tanpa OK/Cancel) ========= */
function openNAModal(inputId, title="Informasi Tanggal"){
  _naTarget=$(inputId);
  $("naTitle").textContent = title;
  showModal("naModal");
}

// Event listeners untuk modal N/A
document.addEventListener('DOMContentLoaded', function() {
  $("naYes").onclick = function() { 
    // pilih tanggal
    closeModal("naModal");
    if(!_naTarget) return;
    _naTarget.dataset.na=""; // hapus N/A
    if(_naTarget.showPicker){ _naTarget.showPicker(); }
  };
  
  $("naNo").onclick = function() { 
    // set N/A
    closeModal("naModal");
    if(!_naTarget) return;
    _naTarget.value=""; _naTarget.dataset.na="1";
  };
});

/* ========= Router ========= */
document.querySelectorAll("#tabs .tab").forEach(b=>{
  b.onclick=async ()=>{
    const r=b.dataset.route;
    
    // Check if user is logged in
    if (!currentUser) {
      showModal('loginModal');
      return;
    }
    
    // Check permissions for specific routes
    if (r === 'master' && !ROLE_PERMISSIONS[currentUser.role].includes('master')) {
      toast('Anda tidak memiliki akses ke Data Master');
      return;
    }
    
    if (r === 'laporan' && !ROLE_PERMISSIONS[currentUser.role].includes('reports')) {
      toast('Anda tidak memiliki akses ke Laporan');
      return;
    }
    
    if(r==="master" || r==="laporan"){
      const ok=await askPass(`Masukkan password untuk ${r==="master"?"Data Master":"Laporan"}:`);
      if(!ok){ return; }
    }
    setRoute(r);
  };
});

function setRoute(r){
  // Check if user is logged in
  if (!currentUser) {
    showModal('loginModal');
    return;
  }
  
  // Check permissions for specific routes
  if (r === 'master' && !ROLE_PERMISSIONS[currentUser.role].includes('master')) {
    toast('Anda tidak memiliki akses ke Data Master');
    return;
  }
  
  if (r === 'laporan' && !ROLE_PERMISSIONS[currentUser.role].includes('reports')) {
    toast('Anda tidak memiliki akses ke Laporan');
    return;
  }
  
  route=r; multi=false; selectedIds.clear();
  currentPage = 1; // Reset to first page when changing route
  ["btnMulti","btnMassEdit","btnMassDelete","btnMassCancel"].forEach(id=>$(id).classList.add("hidden"));
  $("btnMulti").classList.toggle("hidden", r !== "masuk" && r !== "low");
  
  document.querySelectorAll("#tabs .tab").forEach(b=>b.classList.toggle("active",b.dataset.route===r));
  
  // Show/hide pages
  $("pageDashboard").classList.toggle("hidden", r !== "dashboard");
  $("pageList").classList.toggle("hidden", r === "master" || r === "dashboard" || r === "laporan");
  $("pageMaster").classList.toggle("hidden", r !== "master");
  $("pageLaporan").classList.toggle("hidden", r !== "laporan");
  
  if(r==="master"){ 
    renderMaster(); 
  } else if(r==="dashboard") {
    renderDashboard();
  } else if(r==="laporan") {
    renderLaporan();
  } else { 
    renderList(); 
  }
}

/* ========= Render Guard (jaga modal detail tidak hilang) ========= */
function guardedRender(){
  const detailOpen=$("detailModal").classList.contains("show");
  const ctx=_detailCtx ? {..._detailCtx} : null;
  
  // Render sesuai route aktif
  if(route === "master") {
    renderMaster();
  } else if(route === "dashboard") {
    renderDashboard();
  } else if(route === "laporan") {
    renderLaporan();
  } else {
    renderList();
  }
  
  // Jika detail modal terbuka, buka kembali dengan data terbaru
  if(detailOpen && ctx){
    let target=null, idx=-1;
    if(ctx.route==="dirakit"||ctx.route==="terjual"){
      for(let i=0;i<currentList.length;i++){
        const it=currentList[i];
        const key=`${it.name}|${it.type}|${it.size}`;
        if(key===ctx.key){
          target=it; idx=i; break;
        }
      }
    } else {
      target=store.items.find(x=>x.id===ctx.id);
      idx=currentList.findIndex(x=>x.id===ctx.id);
    }
    if(target){ openDetail(target, idx); }
  }
}

/* ========= List ========= */
function renderList(){
  const r=route;
  $("tabTitle").textContent = r==="masuk" ? "Belum Rakit" : r==="dirakit" ? "Sudah Rakit" : r==="terjual" ? "Terjual" : "Stok Kurang";
  const btnAddAsm=$("btnAddAsm"), btnAddSell=$("btnAddSell");
  btnAddAsm.classList.toggle("hidden",r!=="masuk");
  btnAddSell.classList.toggle("hidden",r!=="dirakit");
  
  // Filter items berdasarkan route
  let items = store.items;
  if(r==="masuk"){ items = items.filter(i=>i.status==="masuk"); }
  else if(r==="dirakit"){ items = items.filter(i=>i.status==="dirakit"); }
  else if(r==="terjual"){ items = items.filter(i=>i.status==="terjual"); }
  else if(r==="low"){ items = items.filter(i=>i.status==="masuk" && Number(i.totalQty||0) <= 2); }
  
  // Sort berdasarkan pilihan user
  const sortKey = $("sortKey").value;
  const sortDir = $("sortDir").textContent === "↑" ? 1 : -1;
  
  items.sort((a, b) => {
    let valA = a[sortKey] || '';
    let valB = b[sortKey] || '';
    
    // Handle numeric sorting
    if (sortKey === 'totalQty') {
      valA = Number(valA) || 0;
      valB = Number(valB) || 0;
    }
    
    if (valA < valB) return -1 * sortDir;
    if (valA > valB) return 1 * sortDir;
    return 0;
  });
  
  // Filter berdasarkan pencarian
  const searchTerm = $("searchBox").value.toLowerCase();
  if (searchTerm) {
    items = items.filter(i => 
      i.name.toLowerCase().includes(searchTerm) ||
      (i.type || '').toLowerCase().includes(searchTerm) ||
      (i.size || '').toLowerCase().includes(searchTerm) ||
      (i.supplier || '').toLowerCase().includes(searchTerm) ||
      (i.code || '').toLowerCase().includes(searchTerm)
    );
  }
  
  currentList = items;
  
  // Apply pagination
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const paginatedItems = items.slice(startIndex, endIndex);
  
  let html = '';
  paginatedItems.forEach(item => {
    const imgSrc = item.image || "";
    const qty = Number(item.totalQty || 0);
    const isSelected = selectedIds.has(item.id);
    
    html += `
      <div class="item ${qty === 0 ? "zero" : qty <= 2 ? "low" : ""} ${isSelected ? "selected" : ""}" 
           onclick="openDetail(${JSON.stringify(item).replace(/"/g, '&quot;')}, ${currentList.indexOf(item)})">
        <div class="thumb">
          ${imgSrc ? `<img src="${imgSrc}" alt="${esc(item.name)}" onclick="event.stopPropagation(); addImageInline('${item.id}')">` : "📷"}
        </div>
        <div>
          <div class="name">${esc(item.name)}</div>
          <div class="sub">${esc(item.type||"")} • ${esc(item.size||"")}</div>
          <div class="meta">${esc(item.supplier||"")} • ${item.arrivalDate||"N/A"} • ${item.code||"No Code"}</div>
        </div>
        <div class="checkwrap">
          ${multi ? `<input type="checkbox" ${isSelected ? "checked" : ""} onclick="event.stopPropagation(); toggleSelect('${item.id}')">` : ""}
          <div class="badge">${qty}</div>
        </div>
      </div>
    `;
  });
  
  if (!html) {
    html = `<div class="item" style="text-align:center;padding:40px 20px;grid-template-columns:1fr">Tidak ada data.</div>`;
  }
  
  $("list").innerHTML = html;
  addPaginationControls(items.length);
  
  // Update low stock reminder
  const lowReminder = $("lowReminder");
  if (r === "masuk") {
    const lowCount = store.items.filter(i => i.status === "masuk" && Number(i.totalQty||0) <= 2).length;
    if (lowCount > 0) {
      lowReminder.textContent = `⚠️ ${lowCount} item dengan stok menipis (≤ 2 unit).`;
      lowReminder.classList.remove("hidden");
    } else {
      lowReminder.classList.add("hidden");
    }
  } else {
    lowReminder.classList.add("hidden");
  }
}

function addPaginationControls(totalItems) {
  const totalPages = Math.ceil(totalItems / itemsPerPage);
  
  let html = '';
  
  // Info pagination
  const startItem = (currentPage - 1) * itemsPerPage + 1;
  const endItem = Math.min(currentPage * itemsPerPage, totalItems);
  
  html += `<div class="pagination-info">Menampilkan ${startItem}-${endItem} dari ${totalItems} item</div>`;
  
  // Page size selector
  html += `
    <div class="page-size">
      <label>Per halaman:</label>
      <select onchange="changeItemsPerPage(this.value)">
        <option value="10" ${itemsPerPage === 10 ? 'selected' : ''}>10</option>
        <option value="25" ${itemsPerPage === 25 ? 'selected' : ''}>25</option>
        <option value="50" ${itemsPerPage === 50 ? 'selected' : ''}>50</option>
        <option value="100" ${itemsPerPage === 100 ? 'selected' : ''}>100</option>
      </select>
    </div>
  `;
  
  // Page navigation
  html += `
    <button onclick="goToPage(1)" ${currentPage === 1 ? 'disabled' : ''}>⏮️</button>
    <button onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>⬅️</button>
  `;
  
  // Page numbers (show max 5 pages)
  const startPage = Math.max(1, currentPage - 2);
  const endPage = Math.min(totalPages, startPage + 4);
  
  for (let i = startPage; i <= endPage; i++) {
    html += `<button onclick="goToPage(${i})" ${i === currentPage ? 'class="active"' : ''}>${i}</button>`;
  }
  
  html += `
    <button onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>➡️</button>
    <button onclick="goToPage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>⏭️</button>
  `;
  
  $("listPagination").innerHTML = html;
}

function changeItemsPerPage(newSize) {
  itemsPerPage = parseInt(newSize);
  currentPage = 1; // Reset to first page
  renderList();
}

function goToPage(page) {
  const totalPages = Math.ceil(currentList.length / itemsPerPage);
  if (page >= 1 && page <= totalPages) {
    currentPage = page;
    renderList();
  }
}

/* ========= Multi Select ========= */
function toggleMulti(){
  multi=!multi; selectedIds.clear();
  $("btnMulti").textContent = multi ? "Batal Pilih" : "Pilih Multiple";
  $("btnMulti").classList.toggle("ghost", !multi);
  $("btnMassEdit").classList.toggle("hidden", !multi || selectedIds.size === 0);
  $("btnMassDelete").classList.toggle("hidden", !multi || selectedIds.size === 0);
  $("btnMassCancel").classList.toggle("hidden", !multi);
  renderList();
}

function toggleSelect(id){
  if(selectedIds.has(id)){ selectedIds.delete(id); }
  else{ selectedIds.add(id); }
  
  $("btnMassEdit").classList.toggle("hidden", selectedIds.size === 0);
  $("btnMassDelete").classList.toggle("hidden", selectedIds.size === 0);
  renderList();
}

function massEdit(){
  const ids = Array.from(selectedIds);
  if(ids.length === 0){ return; }
  
  buildMasterOptions("meSup","meType","meSize","mePack");
  showModal("massEditModal");
  
  $("meApply").onclick = function(){
    const sup = $("meSup").value;
    const type = $("meType").value;
    const size = $("meSize").value;
    const pack = $("mePack").value;
    
    let changed = 0;
    store.items.forEach(item => {
      if(selectedIds.has(item.id)){
        let modified = false;
        if(sup && item.supplier !== sup){ item.supplier = sup; modified = true; }
        if(type && item.type !== type){ item.type = type; modified = true; }
        if(size && item.size !== size){ item.size = size; modified = true; }
        if(pack && item.pack !== pack){ item.pack = pack; modified = true; }
        if(modified){ changed++; }
      }
    });
    
    if(changed > 0){
      save();
      addHistory('mass-edit', { count: changed, fields: {sup,type,size,pack} });
      showSuccess(`${changed} item berhasil diedit massal`);
    }
    
    toggleMulti(); // keluar dari mode multi
    closeModal("massEditModal");
  };
}

function massDelete(){
  const ids = Array.from(selectedIds);
  if(ids.length === 0){ return; }
  
  if(!confirm(`Hapus ${ids.length} item terpilih?`)){ return; }
  
  store.items = store.items.filter(x => !selectedIds.has(x.id));
  
  save();
  addHistory('mass-delete', { count: ids.length });
  showSuccess(`${ids.length} item berhasil dihapus`);
  
  toggleMulti(); // keluar dari mode multi
}

/* ========= Detail View ========= */
function openDetail(item, index){
  currentIndex = index;
  
  // Simpan context untuk guarded render
  _detailCtx = { 
    id: item.id, 
    key: `${item.name}|${item.type}|${item.size}`,
    route: route
  };
  
  // Build detail content
  const imgSrc = item.image || "";
  const qty = Number(item.totalQty || 0);
  const statusText = item.status === "masuk" ? "Belum Rakit" : item.status === "dirakit" ? "Sudah Rakit" : "Terjual";
  
  let html = `
    <div class="detail-img" onclick="addImageInline('${item.id}')">
      ${imgSrc ? `<img src="${imgSrc}" alt="${esc(item.name)}">` : `<button class="btn" onclick="takePhoto('${item.id}')">Ambil Foto</button>`}
    </div>
    
    <div class="detail-title">${esc(item.name)}</div>
    <div class="detail-sub">${esc(item.type||"")} • ${esc(item.size||"")}</div>
    <div class="detail-stock">Status: ${statusText} • Stok: <span class="badge">${qty}</span></div>
    
    <div class="readLine"><strong>Supplier:</strong> ${esc(item.supplier||"N/A")}</div>
    <div class="readLine"><strong>Tanggal Kedatangan:</strong> ${item.arrivalDate||"N/A"}</div>
    <div class="readLine"><strong>Kemasan:</strong> ${esc(item.pack||"N/A")}</div>
    <div class="readLine"><strong>Kode/ID:</strong> ${item.code||"No Code"}</div>
    
    ${item.colors && item.colors.length > 0 ? `<div class="readLine"><strong>Warna:</strong> ${chips(item.colors)}</div>` : ""}
    
    <div class="readLine"><strong>Lokasi:</strong> ${chips(item.locations, "name", "qty")}</div>
  `;
  
  // Log perakitan
  if(item.assembleLogs && item.assembleLogs.length > 0){
    html += `<div class="section mt8"><h4>Riwayat Perakitan</h4>`;
    item.assembleLogs.forEach(log => {
      html += `<div class="readLine">${log.date||"N/A"} - ${log.qty||0} unit - ${esc(log.employee||"N/A")}</div>`;
    });
    html += `</div>`;
  }
  
  // Log penjualan
  if(item.sellLogs && item.sellLogs.length > 0){
    html += `<div class="section mt8"><h4>Riwayat Penjualan</h4>`;
    item.sellLogs.forEach(log => {
      html += `<div class="readLine">${log.date||"N/A"} - ${log.qty||0} unit</div>`;
    });
    html += `</div>`;
  }
  
  // Action buttons
  html += `<div class="row mt16">`;
  
  // Edit button - hanya untuk admin dan staff
  if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'staff')) {
    html += `<button class="btn" onclick="secureEdit('${item.id}')">Edit</button>`;
  }
  
  // QR Code button
  html += `<button class="btn ghost" onclick="generateQRCode('${item.id}')">QR Code</button>`;
  
  // Navigation buttons
  html += `<button class="btn ghost" onclick="navDetail(-1)" ${index <= 0 ? "disabled" : ""}>← Sebelumnya</button>`;
  html += `<button class="btn ghost" onclick="navDetail(1)" ${index >= currentList.length - 1 ? "disabled" : ""}>Selanjutnya →</button>`;
  
  // Delete button - hanya untuk admin dan staff
  if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'staff')) {
    html += `<button class="btn red" onclick="secureDelete('${item.id}')">Hapus</button>`;
  }
  
  html += `</div>`;
  
  $("detailBody").innerHTML = html;
  showModal("detailModal");
}

function navDetail(delta){
  const newIndex = currentIndex + delta;
  if(newIndex < 0 || newIndex >= currentList.length){ return; }
  
  const item = currentList[newIndex];
  if(item){
    openDetail(item, newIndex);
  }
}

function secureEdit(itemId){
  // Check edit permission
  if (!currentUser || !ROLE_PERMISSIONS[currentUser.role].includes('edit')) {
    alert('Anda tidak memiliki izin untuk mengedit item.');
    return;
  }
  
  closeModal("detailModal");
  setTimeout(() => openEdit(itemId), 300);
}

function secureDelete(itemId){
  // Check delete permission
  if (!currentUser || !ROLE_PERMISSIONS[currentUser.role].includes('delete')) {
    alert('Anda tidak memiliki izin untuk menghapus item.');
    return;
  }
  
  if(!confirm("Hapus item ini?")){ return; }
  
  const item = store.items.find(x => x.id === itemId);
  if(item){
    store.items = store.items.filter(x => x.id !== itemId);
    save();
    addHistory('delete', { name: item.name, type: item.type, size: item.size });
    showSuccess("Item berhasil dihapus");
    closeModal("detailModal");
  }
}

function addImageInline(itemId){
  const item = store.items.find(x => x.id === itemId);
  if(!item){ return; }
  
  takePhoto(itemId);
}

/* ========= Add/Edit Item ========= */
function openAdd(){
  // Check add permission
  if (!currentUser || !ROLE_PERMISSIONS[currentUser.role].includes('add')) {
    alert('Anda tidak memiliki izin untuk menambah item.');
    return;
  }
  
  editingId = null;
  $("addTitle").textContent = "Tambah Item";
  buildMasterOptions("fSup","fType","fSize","fPack","fAsmEmp");
  
  // Reset form
  ["fName","fQty","fArrive","fAsmDate","fImg"].forEach(id => $(id).value = "");
  $("fStatus").value = "masuk";
  $("colorWrap").innerHTML = "";
  $("locWrap").innerHTML = "";
  
  // Add default location row
  addLocRow();
  
  showModal("addModal");
  bindBtnSaveOnce();
}

function openEdit(itemId){
  // Check edit permission
  if (!currentUser || !ROLE_PERMISSIONS[currentUser.role].includes('edit')) {
    alert('Anda tidak memiliki izin untuk mengedit item.');
    return;
  }
  
  const item = store.items.find(x => x.id === itemId);
  if(!item){ return; }
  
  editingId = itemId;
  $("addTitle").textContent = "Edit Item";
  buildMasterOptions("fSup","fType","fSize","fPack","fAsmEmp");
  
  // Fill form
  $("fName").value = item.name || "";
  $("fSup").value = item.supplier || "";
  $("fType").value = item.type || "";
  $("fSize").value = item.size || "";
  $("fPack").value = item.pack || "";
  $("fStatus").value = item.status || "masuk";
  $("fQty").value = item.totalQty || 1;
  $("fArrive").value = item.arrivalDate || "";
  if(item.arrivalDate === "N/A"){ $("fArrive").dataset.na = "1"; $("fArrive").value = ""; }
  
  // Colors
  $("colorWrap").innerHTML = "";
  if(item.colors && item.colors.length > 0){
    item.colors.forEach(c => addColorRow(c.color, c.qty));
  }
  
  // Locations
  $("locWrap").innerHTML = "";
  if(item.locations && item.locations.length > 0){
    item.locations.forEach(l => addLocRow(l.name, l.qty));
  } else {
    addLocRow();
  }
  
  showModal("addModal");
  bindBtnSaveOnce();
}

function buildMasterOptions(supId, typeId, sizeId, packId, empId){
  // Suppliers
  if(supId){
    const supSel = $(supId);
    supSel.innerHTML = '<option value="">-- pilih --</option>';
    store.suppliers.forEach(s => {
      supSel.innerHTML += `<option value="${s}">${s}</option>`;
    });
  }
  
  // Types
  if(typeId){
    const typeSel = $(typeId);
    typeSel.innerHTML = '<option value="">-- pilih --</option>';
    store.types.forEach(t => {
      typeSel.innerHTML += `<option value="${t}">${t}</option>`;
    });
  }
  
  // Sizes
  if(sizeId){
    const sizeSel = $(sizeId);
    sizeSel.innerHTML = '<option value="">-- pilih --</option>';
    store.sizes.forEach(s => {
      sizeSel.innerHTML += `<option value="${s}">${s}</option>`;
    });
  }
  
  // Packs
  if(packId){
    const packSel = $(packId);
    packSel.innerHTML = '<option value="">-- pilih --</option>';
    store.packs.forEach(p => {
      packSel.innerHTML += `<option value="${p}">${p}</option>`;
    });
  }
  
  // Employees
  if(empId){
    const empSel = $(empId);
    empSel.innerHTML = '<option value="">-- pilih / N/A --</option>';
    store.employees.forEach(e => {
      empSel.innerHTML += `<option value="${e}">${e}</option>`;
    });
  }
}

function fillNameSuggest(partial){
  const list = $("acList");
  if(!partial.trim()){
    list.innerHTML = ""; list.style.display = "none"; return;
  }
  
  const matches = store.items
    .map(x => x.name)
    .filter((n, i, a) => a.indexOf(n) === i) // unique
    .filter(n => n.toLowerCase().includes(partial.toLowerCase()))
    .slice(0, 8);
  
  if(matches.length === 0){
    list.innerHTML = ""; list.style.display = "none"; return;
  }
  
  list.innerHTML = matches.map(n => `<div class="ac-item">${esc(n)}</div>`).join("");
  list.style.display = "block";
  
  list.querySelectorAll(".ac-item").forEach(el => {
    el.onclick = () => {
      $("fName").value = el.textContent;
      list.style.display = "none";
    };
  });
}

function addColorRow(color="", qty=1){
  const wrap = $("colorWrap");
  const id = "color_" + Date.now();
  wrap.innerHTML += `
    <div class="row mt8">
      <input class="input" placeholder="Warna" value="${color}" style="flex:1">
      <input type="number" class="input" placeholder="Qty" value="${qty}" min="1" style="width:80px" oninput="min1(this)">
      <button class="btn ghost small" onclick="this.parentElement.remove()">Hapus</button>
    </div>
  `;
}

function addLocRow(loc="", qty=1){
  const wrap = $("locWrap");
  const id = "loc_" + Date.now();
  
  // Default to first location if empty
  if(!loc && store.locations.length > 0){
    loc = store.locations[0];
  }
  
  let locOpts = store.locations.map(l => `<option value="${l}" ${l===loc?"selected":""}>${l}</option>`).join("");
  
  wrap.innerHTML += `
    <div class="row mt8">
      <select class="input" style="flex:1">
        <option value="">-- pilih lokasi --</option>
        ${locOpts}
      </select>
      <input type="number" class="input" placeholder="Qty" value="${qty}" min="0" style="width:80px" oninput="guardLocRow(this)">
      <button class="btn ghost small" onclick="this.parentElement.remove(); guardAllLocToQty()">Hapus</button>
    </div>
  `;
}

function guardAllLocToQty(){
  const totalQty = parseInt($("fQty").value || "0");
  if(isNaN(totalQty) || totalQty < 1){ return; }
  
  const rows = $("locWrap").children;
  let currentTotal = 0;
  
  // Hitung total current
  for(let row of rows){
    const qtyInput = row.querySelector('input[type="number"]');
    currentTotal += parseInt(qtyInput.value || "0");
  }
  
  // Jika current total melebihi totalQty, kurangi row terakhir
  if(currentTotal > totalQty && rows.length > 0){
    const lastRow = rows[rows.length-1];
    const qtyInput = lastRow.querySelector('input[type="number"]');
    const maxAllowed = totalQty - (currentTotal - parseInt(qtyInput.value || "0"));
    qtyInput.value = Math.max(0, maxAllowed);
  }
}

function guardLocRow(inputEl){
  min1(inputEl); // pastikan minimal 1
  guardAllLocToQty();
}

function totalQtyInput(){
  const rows = $("locWrap").children;
  let total = 0;
  for(let row of rows){
    const qtyInput = row.querySelector('input[type="number"]');
    total += parseInt(qtyInput.value || "0");
  }
  return total;
}

function collectColors(){
  const rows = $("colorWrap").children;
  const colors = [];
  for(let row of rows){
    const colorInput = row.querySelector('input[type="text"]');
    const qtyInput = row.querySelector('input[type="number"]');
    const color = colorInput.value.trim();
    const qty = parseInt(qtyInput.value || "0");
    if(color && qty > 0){
      colors.push({color, qty});
    }
  }
  return colors;
}

function collectLocs(){
  const rows = $("locWrap").children;
  const locs = [];
  for(let row of rows){
    const locSelect = row.querySelector('select');
    const qtyInput = row.querySelector('input[type="number"]');
    const loc = locSelect.value;
    const qty = parseInt(qtyInput.value || "0");
    if(loc && qty > 0){
      locs.push({name: loc, qty});
    }
  }
  return locs;
}

function listMissingAddItem(){
  const req = ["fName","fSup","fType","fSize","fPack","fStatus","fQty"];
  const missing = [];
  for(let id of req){
    const el = $(id);
    if(!el.value.trim()){ 
      missing.push(el.previousElementSibling.textContent.replace(" *","").trim()); 
    }
  }
  
  // Cek lokasi
  const locs = collectLocs();
  if(locs.length === 0){
    missing.push("minimal 1 lokasi");
  }
  
  // Cek total quantity lokasi = totalQty
  const totalLocQty = locs.reduce((sum, l) => sum + l.qty, 0);
  const totalQty = parseInt($("fQty").value || "0");
  if(totalLocQty !== totalQty){
    missing.push(`total quantity lokasi (${totalLocQty}) harus sama dengan jumlah unit (${totalQty})`);
  }
  
  return missing;
}

function bindBtnSaveOnce(){
  $("btnSave").onclick = function(){
    if(editingId === null){
      saveNewItem();
    } else {
      saveEditItem();
    }
  };
}

function saveNewItem(){
  const missing = listMissingAddItem();
  if(missing.length > 0){
    alert("Lengkapi data:\n" + missing.join("\n"));
    return;
  }
  
  const item = {
    id: uid(),
    status: $("fStatus").value,
    name: $("fName").value.trim(),
    supplier: $("fSup").value,
    type: $("fType").value,
    size: $("fSize").value,
    pack: $("fPack").value,
    arrivalDate: $("fArrive").dataset.na ? "N/A" : ($("fArrive").value || "N/A"),
    totalQty: parseInt($("fQty").value),
    colors: collectColors(),
    locations: collectLocs(),
    image: null,
    assembleLogs: [],
    sellLogs: []
  };
  
  // Generate code
  item.code = genCode(item.supplier, item.arrivalDate);
  
  // Handle image upload
  const imgFile = $("fImg").files[0];
  if(imgFile){
    const reader = new FileReader();
    reader.onload = function(e){
      item.image = e.target.result;
      finalizeAdd(item);
    };
    reader.readAsDataURL(imgFile);
  } else {
    finalizeAdd(item);
  }
}

function finalizeAdd(item){
  store.items.push(item);
  save();
  addHistory('add', { name: item.name, type: item.type, size: item.size, qty: item.totalQty });
  showSuccess("Item berhasil ditambahkan");
  closeModal("addModal");
}

function saveEditItem(){
  const missing = listMissingAddItem();
  if(missing.length > 0){
    alert("Lengkapi data:\n" + missing.join("\n"));
    return;
  }
  
  const item = store.items.find(x => x.id === editingId);
  if(!item){ return; }
  
  const oldData = {...item};
  
  item.status = $("fStatus").value;
  item.name = $("fName").value.trim();
  item.supplier = $("fSup").value;
  item.type = $("fType").value;
  item.size = $("fSize").value;
  item.pack = $("fPack").value;
  item.arrivalDate = $("fArrive").dataset.na ? "N/A" : ($("fArrive").value || "N/A");
  item.totalQty = parseInt($("fQty").value);
  item.colors = collectColors();
  item.locations = collectLocs();
  
  // Update code jika supplier atau tanggal berubah
  item.code = genCode(item.supplier, item.arrivalDate);
  
  // Handle image upload
  const imgFile = $("fImg").files[0];
  if(imgFile){
    const reader = new FileReader();
    reader.onload = function(e){
      item.image = e.target.result;
      afterEdit(item, oldData);
    };
    reader.readAsDataURL(imgFile);
  } else {
    afterEdit(item, oldData);
  }
}

function afterEdit(item, oldData){
  save();
  
  // Log perubahan
  const changes = [];
  if(oldData.name !== item.name) changes.push(`nama: "${oldData.name}" → "${item.name}"`);
  if(oldData.supplier !== item.supplier) changes.push(`supplier: "${oldData.supplier}" → "${item.supplier}"`);
  if(oldData.type !== item.type) changes.push(`tipe: "${oldData.type}" → "${item.type}"`);
  if(oldData.size !== item.size) changes.push(`ukuran: "${oldData.size}" → "${item.size}"`);
  if(oldData.totalQty !== item.totalQty) changes.push(`qty: ${oldData.totalQty} → ${item.totalQty}`);
  
  addHistory('edit', { 
    name: item.name, 
    type: item.type, 
    size: item.size,
    changes: changes.length > 0 ? changes : ['data diperbarui']
  });
  
  showSuccess("Item berhasil diupdate");
  closeModal("addModal");
}

/* ========= Assembly ========= */
function openAsmPicker(){
  const items = store.items.filter(i => i.status === "masuk" && Number(i.totalQty||0) > 0);
  $("asmList").innerHTML = items.map(i => `
    <div class="item" onclick="openAsmDetail('${i.id}')">
      <div class="thumb">${i.image ? `<img src="${i.image}" alt="${esc(i.name)}">` : "📷"}</div>
      <div>
        <div class="name">${esc(i.name)}</div>
        <div class="sub">${esc(i.type||"")} • ${esc(i.size||"")}</div>
        <div class="meta">Stok: ${i.totalQty}</div>
      </div>
      <div class="badge">${i.totalQty}</div>
    </div>
  `).join("");
  
  $("asmSearch").oninput = function(){
    const term = this.value.toLowerCase();
    const filtered = items.filter(i => i.name.toLowerCase().includes(term));
    $("asmList").innerHTML = filtered.map(i => `
      <div class="item" onclick="openAsmDetail('${i.id}')">
        <div class="thumb">${i.image ? `<img src="${i.image}" alt="${esc(i.name)}">` : "📷"}</div>
        <div>
          <div class="name">${esc(i.name)}</div>
          <div class="sub">${esc(i.type||"")} • ${esc(i.size||"")}</div>
          <div class="meta">Stok: ${i.totalQty}</div>
        </div>
        <div class="badge">${i.totalQty}</div>
      </div>
    `).join("");
  };
  
  showModal("asmModal");
}

function openAsmDetail(itemId){
  asmPick = store.items.find(x => x.id === itemId);
  if(!asmPick){ return; }
  
  $("asmHeader").innerHTML = `
    <div class="detail-title">${esc(asmPick.name)}</div>
    <div class="detail-sub">${esc(asmPick.type||"")} • ${esc(asmPick.size||"")}</div>
    <div class="detail-stock">Stok tersedia: <span class="badge">${asmPick.totalQty}</span></div>
  `;
  
  $("adQty").value = 1;
  $("adQty").max = asmPick.totalQty;
  $("adColor").value = "";
  $("adDate").value = new Date().toISOString().slice(0,10);
  $("adEmp").value = "";
  
  buildMasterOptions(null, null, null, null, "adEmp");
  
  $("adSave").onclick = function(){
    const qty = parseInt($("adQty").value || "0");
    if(qty < 1 || qty > asmPick.totalQty){
      alert(`Jumlah harus antara 1 dan ${asmPick.totalQty}`);
      return;
    }
    
    if(!$("adEmp").value){
      alert("Pilih pegawai perakit");
      return;
    }
    
    // Kurangi stok item asal
    asmPick.totalQty -= qty;
    
    // Cari atau buat item Sudah Rakit
    let target = store.items.find(x => 
      x.status === "dirakit" && 
      x.name === asmPick.name && 
      x.type === asmPick.type && 
      x.size === asmPick.size
    );
    
    if(!target){
      target = {
        id: uid(),
        status: "dirakit",
        name: asmPick.name,
        supplier: asmPick.supplier,
        type: asmPick.type,
        size: asmPick.size,
        pack: asmPick.pack,
        arrivalDate: asmPick.arrivalDate,
        totalQty: 0,
        colors: [],
        locations: [...asmPick.locations],
        image: asmPick.image,
        assembleLogs: [],
        sellLogs: []
      };
      store.items.push(target);
    }
    
    // Tambah stok
    target.totalQty += qty;
    
    // Add assembly log
    target.assembleLogs.push({
      date: $("adDate").dataset.na ? "N/A" : ($("adDate").value || new Date().toISOString().slice(0,10)),
      qty: qty,
      employee: $("adEmp").value,
      colors: $("adColor").value
    });
    
    save();
    addHistory('assemble', { 
      name: asmPick.name, 
      type: asmPick.type, 
      size: asmPick.size,
      qty: qty,
      employee: $("adEmp").value
    });
    
    showSuccess(`${qty} unit berhasil dirakit`);
    closeModal("asmDetailModal");
    closeModal("asmModal");
  };
  
  showModal("asmDetailModal");
}

/* ========= Sales ========= */
function openSellPicker(){
  const items = store.items.filter(i => i.status === "dirakit" && Number(i.totalQty||0) > 0);
  $("sellList").innerHTML = items.map(i => `
    <div class="item" onclick="openSellDetail('${i.id}')">
      <div class="thumb">${i.image ? `<img src="${i.image}" alt="${esc(i.name)}">` : "📷"}</div>
      <div>
        <div class="name">${esc(i.name)}</div>
        <div class="sub">${esc(i.type||"")} • ${esc(i.size||"")}</div>
        <div class="meta">Stok: ${i.totalQty}</div>
      </div>
      <div class="badge">${i.totalQty}</div>
    </div>
  `).join("");
  
  $("sellSearch").oninput = function(){
    const term = this.value.toLowerCase();
    const filtered = items.filter(i => i.name.toLowerCase().includes(term));
    $("sellList").innerHTML = filtered.map(i => `
      <div class="item" onclick="openSellDetail('${i.id}')">
        <div class="thumb">${i.image ? `<img src="${i.image}" alt="${esc(i.name)}">` : "📷"}</div>
        <div>
          <div class="name">${esc(i.name)}</div>
          <div class="sub">${esc(i.type||"")} • ${esc(i.size||"")}</div>
          <div class="meta">Stok: ${i.totalQty}</div>
        </div>
        <div class="badge">${i.totalQty}</div>
      </div>
    `).join("");
  };
  
  showModal("sellModal");
}

function openSellDetail(itemId){
  sellPick = store.items.find(x => x.id === itemId);
  if(!sellPick){ return; }
  
  $("sellHeader").innerHTML = `
    <div class="detail-title">${esc(sellPick.name)}</div>
    <div class="detail-sub">${esc(sellPick.type||"")} • ${esc(sellPick.size||"")}</div>
    <div class="detail-stock">Stok tersedia: <span class="badge">${sellPick.totalQty}</span></div>
  `;
  
  $("sdQty").value = 1;
  $("sdQty").max = sellPick.totalQty;
  $("sdColor").value = "";
  $("sdDate").value = new Date().toISOString().slice(0,10);
  
  $("sdSave").onclick = function(){
    const qty = parseInt($("sdQty").value || "0");
    if(qty < 1 || qty > sellPick.totalQty){
      alert(`Jumlah harus antara 1 dan ${sellPick.totalQty}`);
      return;
    }
    
    // Kurangi stok item asal
    sellPick.totalQty -= qty;
    
    // Cari atau buat item Terjual
    let target = store.items.find(x => 
      x.status === "terjual" && 
      x.name === sellPick.name && 
      x.type === sellPick.type && 
      x.size === sellPick.size
    );
    
    if(!target){
      target = {
        id: uid(),
        status: "terjual",
        name: sellPick.name,
        supplier: sellPick.supplier,
        type: sellPick.type,
        size: sellPick.size,
        pack: sellPick.pack,
        arrivalDate: sellPick.arrivalDate,
        totalQty: 0,
        colors: [],
        locations: [],
        image: sellPick.image,
        assembleLogs: [...sellPick.assembleLogs],
        sellLogs: []
      };
      store.items.push(target);
    }
    
    // Tambah stok terjual
    target.totalQty += qty;
    
    // Add sales log
    target.sellLogs.push({
      date: $("sdDate").value || new Date().toISOString().slice(0,10),
      qty: qty,
      colors: $("sdColor").value
    });
    
    save();
    addHistory('sell', { 
      name: sellPick.name, 
      type: sellPick.type, 
      size: sellPick.size,
      qty: qty
    });
    
    showSuccess(`${qty} unit berhasil dijual`);
    closeModal("sellDetailModal");
    closeModal("sellModal");
  };
  
  showModal("sellDetailModal");
}

/* ========= Master Data ========= */
function renderMaster(){
  const read = $("masterRead");
  read.innerHTML = `
    <div class="section">
      <h3>Supplier</h3>
      <div id="supList"></div>
    </div>
    <div class="section mt8">
      <h3>Tipe Sepeda</h3>
      <div id="typeList"></div>
    </div>
    <div class="section mt8">
      <h3>Ukuran</h3>
      <div id="sizeList"></div>
    </div>
    <div class="section mt8">
      <h3>Kemasan</h3>
      <div id="packList"></div>
    </div>
    <div class="section mt8">
      <h3>Lokasi Penyimpanan</h3>
      <div id="locList"></div>
    </div>
    <div class="section mt8">
      <h3>Pegawai</h3>
      <div id="empList"></div>
    </div>
  `;
  
  // Render lists
  renderMasterList("supList", store.suppliers, "Supplier");
  renderMasterList("typeList", store.types, "Tipe");
  renderMasterList("sizeList", store.sizes, "Ukuran");
  renderMasterList("packList", store.packs, "Kemasan");
  renderMasterList("locList", store.locations, "Lokasi");
  renderMasterList("empList", store.employees, "Pegawai");
  
  // Show edit button only for admin
  const canEdit = currentUser && currentUser.role === 'admin';
  $("btnMasterEdit").classList.toggle("hidden", !canEdit);
}

function renderMasterList(containerId, items, label){
  const container = $(containerId);
  container.innerHTML = items.map(item => `
    <div class="chip">
      ${esc(item)}
      <span class="x" onclick="if(currentUser&&currentUser.role==='admin')mDel('${containerId}', '${item}')">×</span>
    </div>
  `).join("");
}

function drawMasterEdit(){
  $("masterRead").classList.add("hidden");
  $("masterEdit").classList.remove("hidden");
  
  $("masterEdit").innerHTML = `
    <div class="grid2">
      <div class="section">
        <h3>Supplier</h3>
        <div id="editSupList"></div>
        <div class="row mt8">
          <input id="newSup" class="input" placeholder="Supplier baru">
          <button class="btn small" onclick="mAdd('supList', 'newSup')">+</button>
        </div>
      </div>
      <div class="section">
        <h3>Tipe Sepeda</h3>
        <div id="editTypeList"></div>
        <div class="row mt8">
          <input id="newType" class="input" placeholder="Tipe baru">
          <button class="btn small" onclick="mAdd('typeList', 'newType')">+</button>
        </div>
      </div>
    </div>
    
    <div class="grid2 mt8">
      <div class="section">
        <h3>Ukuran</h3>
        <div id="editSizeList"></div>
        <div class="row mt8">
          <input id="newSize" class="input" placeholder="Ukuran baru">
          <button class="btn small" onclick="mAdd('sizeList', 'newSize')">+</button>
        </div>
      </div>
      <div class="section">
        <h3>Kemasan</h3>
        <div id="editPackList"></div>
        <div class="row mt8">
          <input id="newPack" class="input" placeholder="Kemasan baru">
          <button class="btn small" onclick="mAdd('packList', 'newPack')">+</button>
        </div>
      </div>
    </div>
    
    <div class="grid2 mt8">
      <div class="section">
        <h3>Lokasi Penyimpanan</h3>
        <div id="editLocList"></div>
        <div class="row mt8">
          <input id="newLoc" class="input" placeholder="Lokasi baru">
          <button class="btn small" onclick="mAdd('locList', 'newLoc')">+</button>
        </div>
      </div>
      <div class="section">
        <h3>Pegawai</h3>
        <div id="editEmpList"></div>
        <div class="row mt8">
          <input id="newEmp" class="input" placeholder="Pegawai baru">
          <button class="btn small" onclick="mAdd('empList', 'newEmp')">+</button>
        </div>
      </div>
    </div>
  `;
  
  // Render editable lists
  renderEditableMasterList("editSupList", store.suppliers, "suppliers");
  renderEditableMasterList("editTypeList", store.types, "types");
  renderEditableMasterList("editSizeList", store.sizes, "sizes");
  renderEditableMasterList("editPackList", store.packs, "packs");
  renderEditableMasterList("editLocList", store.locations, "locations");
  renderEditableMasterList("editEmpList", store.employees, "employees");
  
  // Update button states
  $("btnMasterEdit").classList.add("hidden");
  $("btnMasterSave").classList.remove("hidden");
  $("btnMasterCancel").classList.remove("hidden");
}

function renderEditableMasterList(containerId, items, storeKey){
  const container = $(containerId);
  container.innerHTML = items.map((item, index) => `
    <div class="row mt4">
      <input class="input" value="${esc(item)}" onchange="mUpdate('${storeKey}', ${index}, this.value)" style="flex:1">
      <button class="btn ghost small red" onclick="mRemove('${storeKey}', ${index})">Hapus</button>
    </div>
  `).join("");
}

function mAdd(listId, inputId){
  const input = $(inputId);
  const value = input.value.trim();
  if(!value){ return; }
  
  let storeKey = "";
  switch(listId){
    case "supList": storeKey = "suppliers"; break;
    case "typeList": storeKey = "types"; break;
    case "sizeList": storeKey = "sizes"; break;
    case "packList": storeKey = "packs"; break;
    case "locList": storeKey = "locations"; break;
    case "empList": storeKey = "employees"; break;
  }
  
  if(storeKey && !store[storeKey].includes(value)){
    store[storeKey].push(value);
    renderEditableMasterList("edit" + listId.charAt(0).toUpperCase() + listId.slice(1), store[storeKey], storeKey);
    input.value = "";
  }
}

function mUpdate(storeKey, index, newValue){
  newValue = newValue.trim();
  if(newValue && !store[storeKey].includes(newValue)){
    store[storeKey][index] = newValue;
  }
}

function mRemove(storeKey, index){
  store[storeKey].splice(index, 1);
  const containerId = "edit" + storeKey.charAt(0).toUpperCase() + storeKey.slice(1);
  renderEditableMasterList(containerId, store[storeKey], storeKey);
}

function mDel(listId, value){
  let storeKey = "";
  switch(listId){
    case "supList": storeKey = "suppliers"; break;
    case "typeList": storeKey = "types"; break;
    case "sizeList": storeKey = "sizes"; break;
    case "packList": storeKey = "packs"; break;
    case "locList": storeKey = "locations"; break;
    case "empList": storeKey = "employees"; break;
  }
  
  if(storeKey){
    store[storeKey] = store[storeKey].filter(x => x !== value);
    renderMasterList(listId, store[storeKey], "");
  }
}

function saveMasterEdit(){
  save();
  $("masterEdit").classList.add("hidden");
  $("masterRead").classList.remove("hidden");
  $("btnMasterEdit").classList.remove("hidden");
  $("btnMasterSave").classList.add("hidden");
  $("btnMasterCancel").classList.add("hidden");
  
  addHistory('master-edit', { 
    suppliers: store.suppliers.length,
    types: store.types.length,
    sizes: store.sizes.length,
    packs: store.packs.length,
    locations: store.locations.length,
    employees: store.employees.length
  });
  
  showSuccess("Data master berhasil disimpan");
}

function cancelMasterEdit(){
  $("masterEdit").classList.add("hidden");
  $("masterRead").classList.remove("hidden");
  $("btnMasterEdit").classList.remove("hidden");
  $("btnMasterSave").classList.add("hidden");
  $("btnMasterCancel").classList.add("hidden");
}

/* ========= Reports ========= */
function renderLaporan(){
  $("laporanOptions").classList.remove("show");
  $("laporanResult").innerHTML = `
    <div style="text-align:center;padding:40px 20px;color:var(--muted)">
      Pilih jenis laporan untuk menampilkan data.
    </div>
  `;
}

function generateReport(type){
  const startDate = $("reportStartDate").value;
  const endDate = $("reportEndDate").value;
  
  let html = "";
  let data = [];
  
  switch(type){
    case "stok":
      html = `<h3>Laporan Stok</h3>`;
      data = store.items.filter(i => i.status === "masuk");
      break;
      
    case "pergerakan":
      html = `<h3>Laporan Pergerakan Stok</h3>`;
      // Combine assembly and sales logs from all items
      let movements = [];
      store.items.forEach(item => {
        if(item.assembleLogs){
          item.assembleLogs.forEach(log => {
            movements.push({
              type: "Perakitan",
              item: item.name,
              date: log.date,
              qty: log.qty,
              detail: `Pegawai: ${log.employee}`
            });
          });
        }
        if(item.sellLogs){
          item.sellLogs.forEach(log => {
            movements.push({
              type: "Penjualan",
              item: item.name,
              date: log.date,
              qty: log.qty,
              detail: ``
            });
          });
        }
      });
      
      // Sort by date
      movements.sort((a, b) => new Date(b.date) - new Date(a.date));
      data = movements;
      break;
      
    case "penjualan":
      html = `<h3>Laporan Penjualan</h3>`;
      data = store.items.filter(i => i.status === "terjual");
      break;
      
    case "perakitan":
      html = `<h3>Laporan Perakitan</h3>`;
      data = store.items.filter(i => i.status === "dirakit");
      break;
      
    case "prediksi":
      html = `<h3>Prediksi Stok</h3>`;
      // Simple prediction based on recent sales
      const recentSales = store.items
        .filter(i => i.status === "terjual")
        .slice(0, 10)
        .reduce((sum, item) => sum + item.totalQty, 0);
      
      const currentStock = store.items
        .filter(i => i.status === "masuk")
        .reduce((sum, item) => sum + item.totalQty, 0);
      
      const predictionDays = currentStock / (recentSales / 30); // rough estimate
      
      html += `
        <div class="dashboard-card">
          <div class="dashboard-label">Stok Saat Ini</div>
          <div class="dashboard-value">${currentStock} unit</div>
        </div>
        <div class="dashboard-card">
          <div class="dashboard-label">Penjualan 30 Hari</div>
          <div class="dashboard-value">${recentSales} unit</div>
        </div>
        <div class="dashboard-card">
          <div class="dashboard-label">Prediksi Stok Habis</div>
          <div class="dashboard-value">${Math.round(predictionDays)} hari</div>
        </div>
      `;
      break;
  }
  
  if(data.length > 0 && type !== "prediksi"){
    html += `<div class="report-table-container">`;
    html += `<table class="table"><thead><tr>`;
    
    // Table headers based on report type
    if(type === "stok" || type === "penjualan" || type === "perakitan"){
      html += `
        <th>Nama</th>
        <th>Tipe</th>
        <th>Ukuran</th>
        <th>Supplier</th>
        <th>Stok</th>
        <th>Tanggal</th>
      `;
    } else if(type === "pergerakan"){
      html += `
        <th>Tanggal</th>
        <th>Jenis</th>
        <th>Item</th>
        <th>Qty</th>
        <th>Detail</th>
      `;
    }
    
    html += `</tr></thead><tbody>`;
    
    data.forEach(item => {
      html += `<tr>`;
      
      if(type === "stok" || type === "penjualan" || type === "perakitan"){
        html += `
          <td>${esc(item.name)}</td>
          <td>${esc(item.type||"")}</td>
          <td>${esc(item.size||"")}</td>
          <td>${esc(item.supplier||"")}</td>
          <td>${item.totalQty}</td>
          <td>${item.arrivalDate||"N/A"}</td>
        `;
      } else if(type === "pergerakan"){
        html += `
          <td>${item.date||"N/A"}</td>
          <td>${item.type}</td>
          <td>${esc(item.item)}</td>
          <td>${item.qty}</td>
          <td>${esc(item.detail)}</td>
        `;
      }
      
      html += `</tr>`;
    });
    
    html += `</tbody></table>`;
    html += `</div>`;
    html += `<div class="mt12"><strong>Total Data: ${data.length}</strong></div>`;
  }
  
  $("laporanResult").innerHTML = html;
}

function setReportDateRange(range){
  const today = new Date();
  let startDate, endDate;
  
  switch(range){
    case "today":
      startDate = today.toISOString().slice(0,10);
      endDate = startDate;
      break;
    case "week":
      const startOfWeek = new Date(today);
      startOfWeek.setDate(today.getDate() - today.getDay());
      startDate = startOfWeek.toISOString().slice(0,10);
      endDate = today.toISOString().slice(0,10);
      break;
    case "month":
      startDate = today.toISOString().slice(0,7) + "-01";
      endDate = today.toISOString().slice(0,10);
      break;
  }
  
  $("reportStartDate").value = startDate;
  $("reportEndDate").value = endDate;
}

// Toggle laporan options
$("btnPilihLaporan").onclick = function(){
  $("laporanOptions").classList.toggle("show");
};

/* ========= History System ========= */
function addHistory(type, data){
  const entry = {
    id: uid(),
    timestamp: new Date().toISOString(),
    type: type,
    data: data,
    user: currentUser ? currentUser.username : 'system'
  };
  
  store.history.unshift(entry);
  
  // Keep only last 1000 entries
  if(store.history.length > 1000){
    store.history = store.history.slice(0, 1000);
  }
}

function renderHistory(){
  const typeFilter = $("hisType").value;
  let filtered = store.history;
  
  if(typeFilter !== "all"){
    filtered = store.history.filter(h => h.type === typeFilter);
  }
  
  const tbody = $("#hisTable tbody");
  tbody.innerHTML = filtered.map(entry => {
    const time = new Date(entry.timestamp).toLocaleString("id-ID");
    let activity = "", detail = "";
    
    switch(entry.type){
      case "add":
        activity = "Tambah Item";
        detail = `${entry.data.name} (${entry.data.type} - ${entry.data.size}) - ${entry.data.qty} unit`;
        break;
      case "edit":
        activity = "Edit Item";
        detail = `${entry.data.name} (${entry.data.type} - ${entry.data.size}) - ${entry.data.changes.join(", ")}`;
        break;
      case "delete":
        activity = "Hapus Item";
        detail = `${entry.data.name} (${entry.data.type} - ${entry.data.size})`;
        break;
      case "assemble":
        activity = "Perakitan";
        detail = `${entry.data.qty} unit ${entry.data.name} (${entry.data.type} - ${entry.data.size}) - ${entry.data.employee}`;
        break;
      case "sell":
        activity = "Penjualan";
        detail = `${entry.data.qty} unit ${entry.data.name} (${entry.data.type} - ${entry.data.size})`;
        break;
      case "mass-edit":
        activity = "Edit Massal";
        detail = `${entry.data.count} item diubah`;
        break;
      case "mass-delete":
        activity = "Hapus Massal";
        detail = `${entry.data.count} item dihapus`;
        break;
      case "master-edit":
        activity = "Edit Master Data";
        detail = `Supplier:${entry.data.suppliers} Tipe:${entry.data.types} Ukuran:${entry.data.sizes} Kemasan:${entry.data.packs} Lokasi:${entry.data.locations} Pegawai:${entry.data.employees}`;
        break;
      case "backup":
        activity = "Backup Data";
        detail = `File: ${entry.data.filename}`;
        break;
      case "restore":
        activity = "Restore Data";
        detail = `File: ${entry.data.filename}`;
        break;
      case "import":
        activity = "Impor Data";
        detail = `${entry.data.count} item diimpor`;
        break;
      default:
        activity = entry.type;
        detail = JSON.stringify(entry.data);
    }
    
    return `
      <tr>
        <td style="text-align:right;font-size:12px">${time}</td>
        <td>${activity}</td>
        <td>${detail}</td>
        <td style="text-align:center">
          ${entry.type === "delete" ? `<button class="btn ghost small" onclick="undoHistory('${entry.id}')">Undo</button>` : "-"}
        </td>
      </tr>
    `;
  }).join("");
}

function undoHistory(historyId){
  const entry = store.history.find(h => h.id === historyId);
  if(!entry || entry.type !== "delete"){ return; }
  
  // Find the deleted item in backup (simplified - in real app you'd want to store the actual deleted item)
  const deletedItem = store.items.find(i => 
    i.name === entry.data.name && 
    i.type === entry.data.type && 
    i.size === entry.data.size
  );
  
  if(!deletedItem){
    alert("Item tidak dapat di-restore (data tidak ditemukan)");
    return;
  }
  
  // Restore the item
  store.items.push({
    ...deletedItem,
    id: uid() // new ID since the old one might be in use
  });
  
  save();
  showSuccess("Item berhasil di-restore");
}

/* ========= Import/Export ========= */
function downloadCSV(){
  // Check export permission
  if (!currentUser || !ROLE_PERMISSIONS[currentUser.role].includes('export')) {
    alert('Anda tidak memiliki izin untuk mengekspor data.');
    return;
  }
  
  const headers = ["ID","Status","Nama","Tipe","Ukuran","Supplier","TanggalKedatangan","Jumlah","Warna","Lokasi","Kemasan","Kode"];
  let csv = headers.join(",") + "\n";
  
  store.items.forEach(item => {
    const row = [
      item.id,
      item.status,
      escCSV(item.name),
      escCSV(item.type),
      escCSV(item.size),
      escCSV(item.supplier),
      item.arrivalDate,
      item.totalQty,
      escCSV(chips(item.colors)),
      escCSV(chips(item.locations, "name", "qty")),
      escCSV(item.pack),
      escCSV(item.code)
    ];
    csv += row.join(",") + "\n";
  });
  
  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `mujur-bikes-${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  
  addHistory('export', { count: store.items.length });
  toast("CSV berhasil diunduh");
}

function escCSV(str){
  if(!str) return "";
  str = String(str);
  if(str.includes(",") || str.includes('"') || str.includes("\n")){
    return '"' + str.replace(/"/g, '""') + '"';
  }
  return str;
}

// Import CSV
function importCSV(){
  // Check import permission
  if (!currentUser || !ROLE_PERMISSIONS[currentUser.role].includes('import')) {
    alert('Anda tidak memiliki izin untuk mengimpor data.');
    return;
  }
  
  const input = document.createElement("input");
  input.type = "file";
  input.accept = ".csv";
  
  input.onchange = e => {
    const file = e.target.files[0];
    if(!file) return;
    
    const reader = new FileReader();
    reader.onload = event => {
      const csv = event.target.result;
      const lines = splitCSV(csv);
      
      if(lines.length < 2){
        alert("File CSV kosong atau tidak valid");
        return;
      }
      
      const headers = lines[0];
      const data = lines.slice(1);
      let imported = 0, errors = [];
      
      data.forEach((row, idx) => {
        if(row.length !== headers.length){
          errors.push(`Baris ${idx+2}: Jumlah kolom tidak sesuai`);
          return;
        }
        
        const obj = {};
        headers.forEach((h, i) => {
          obj[h] = row[i] || "";
        });
        
        try {
          // Parse data
          const item = {
            id: obj.ID || uid(),
            status: obj.Status || "masuk",
            name: obj.Nama || "",
            type: obj.Tipe || "",
            size: obj.Ukuran || "",
            supplier: obj.Supplier || "",
            arrivalDate: obj.TanggalKedatangan || "N/A",
            totalQty: parseInt(obj.Jumlah) || 0,
            colors: parsePairs(obj.Warna, "color", "qty"),
            locations: parsePairs(obj.Lokasi, "name", "qty"),
            pack: obj.Kemasan || "",
            code: obj.Kode || genCode(obj.Supplier, obj.TanggalKedatangan),
            image: null,
            assembleLogs: [],
            sellLogs: []
          };
          
          // Validasi
          if(!item.name || !item.type || !item.size){
            errors.push(`Baris ${idx+2}: Data tidak lengkap`);
            return;
          }
          
          // Cek duplikat
          const exists = store.items.find(i => 
            i.name === item.name && 
            i.type === item.type && 
            i.size === item.size
          );
          
          if(!exists){
            store.items.push(item);
            imported++;
          }
          
        } catch(err){
          errors.push(`Baris ${idx+2}: ${err.message}`);
        }
      });
      
      if(imported > 0){
        save();
        addHistory('import', { count: imported, errors: errors.length });
        showSuccess(`${imported} item berhasil diimpor${errors.length > 0 ? `, ${errors.length} error` : ''}`);
      } else if(errors.length > 0){
        alert("Import gagal:\n" + errors.slice(0,10).join("\n"));
      }
    };
    
    reader.readAsText(file);
  };
  
  input.click();
}

function splitCSV(csv){
  const lines = [];
  let current = "";
  let inQuotes = false;
  
  for(let i = 0; i < csv.length; i++){
    const char = csv[i];
    
    if(char === '"'){
      inQuotes = !inQuotes;
    } else if(char === '\n' && !inQuotes){
      lines.push(parseCSVLine(current));
      current = "";
      continue;
    }
    
    current += char;
  }
  
  if(current) lines.push(parseCSVLine(current));
  return lines;
}

function parseCSVLine(line){
  const fields = [];
  let current = "";
  let inQuotes = false;
  
  for(let i = 0; i < line.length; i++){
    const char = line[i];
    
    if(char === '"'){
      inQuotes = !inQuotes;
    } else if(char === ',' && !inQuotes){
      fields.push(current);
      current = "";
      continue;
    } else {
      current += char;
    }
  }
  
  fields.push(current);
  return fields.map(f => f.trim().replace(/^"|"$/g, ''));
}

function parsePairs(str, keyName, valName){
  if(!str) return [];
  const pairs = str.split(";").map(p => p.trim()).filter(p => p);
  const result = [];
  
  pairs.forEach(p => {
    const [key, val] = p.split(":").map(x => x.trim());
    if(key && val){
      result.push({
        [keyName]: key,
        [valName]: parseInt(val) || 0
      });
    }
  });
  
  return result;
}

function downloadTemplate(){
  const headers = ["ID","Status","Nama","Tipe","Ukuran","Supplier","TanggalKedatangan","Jumlah","Warna","Lokasi","Kemasan","Kode"];
  const example = [
    "","masuk","Polygon Strada","MTB",'29"',"VL","2025-09-20","5","Merah:2; Hitam:3","Toko:5","Dus","VL200925"
  ];
  
  let csv = headers.join(",") + "\n";
  csv += example.join(",") + "\n";
  
  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "template-import-mujur-bikes.csv";
  a.click();
  URL.revokeObjectURL(url);
}

/* ========= Event Listeners ========= */
document.addEventListener("DOMContentLoaded", function(){
  // Auto-complete untuk nama
  $("fName").oninput = function(){ fillNameSuggest(this.value); };
  document.addEventListener("click", function(){ $("acList").style.display="none"; });
  
  // Toggle status assembly fields
  $("fStatus").onchange = function(){
    $("asmRow").classList.toggle("hidden", this.value !== "dirakit");
  };
  
  // Sort direction toggle
  $("sortDir").onclick = function(){
    this.textContent = this.textContent === "↑" ? "↓" : "↑";
    renderList();
  };
  
  // Search and sort triggers
  $("searchBox").oninput = renderList;
  $("sortKey").onchange = renderList;
  
  // Multi-select buttons
  $("btnMulti").onclick = toggleMulti;
  $("btnMassEdit").onclick = massEdit;
  $("btnMassDelete").onclick = massDelete;
  $("btnMassCancel").onclick = toggleMulti;
  
  // Add buttons
  $("btnAdd").onclick = openAdd;
  $("btnAddAsm").onclick = openAsmPicker;
  $("btnAddSell").onclick = openSellPicker;
  
  // Master edit buttons
  $("btnMasterEdit").onclick = drawMasterEdit;
  $("btnMasterSave").onclick = saveMasterEdit;
  $("btnMasterCancel").onclick = cancelMasterEdit;
  
  // Import/Export
  $("btnImportData").onclick = importCSV;
  $("btnTpl").onclick = downloadTemplate;
  
  // Close modals when clicking outside
  document.querySelectorAll(".modal").forEach(m => {
    m.onclick = function(e){
      if(e.target === this){
        this.classList.remove("show");
      }
    };
  });
  
  // Close menus when clicking outside
  document.addEventListener("click", function(){
    document.querySelectorAll(".menu.open").forEach(m => m.classList.remove("open"));
  });
  
  // Initialize
  initAuth();
  setRoute("dashboard");
  initRealTimeFeatures();
  
  // Check notifications on startup
  setTimeout(checkStockNotifications, 1000);
  
  // Close detail modal with Escape key
  document.addEventListener("keydown", function(e){
    if(e.key === "Escape"){
      closeModal("detailModal");
    }
  });
});

/* ========= Modal Utilities ========= */
function showModal(id){ $(id).classList.add("show"); }
function closeModal(id){ $(id).classList.remove("show"); }

/* ========= Local Step Functions ========= */
function stepLocal(inputId, type, delta){
  const el = $(inputId);
  let current = parseInt(el.value || "0");
  let max = parseInt(el.max || "999");
  
  current += delta;
  if(current < 1) current = 1;
  if(current > max) current = max;
  
  el.value = current;
  
  // Trigger input event untuk update real-time
  if(type === 'asm') {
    clampToStock(el, 'asm');
  } else if(type === 'sell') {
    clampToStock(el, 'sell');
  }
}

function clampToStock(inputEl, type){
  let max = 0;
  
  if(type === 'asm' && asmPick){
    max = asmPick.totalQty;
  } else if(type === 'sell' && sellPick){
    max = sellPick.totalQty;
  }
  
  inputEl.max = max;
  
  let current = parseInt(inputEl.value || "0");
  if(current > max) {
    inputEl.value = max;
  }
  if(current < 1 && max > 0) {
    inputEl.value = 1;
  }
}

// ========= EXPORT FUNCTIONS FOR HTML ONCLICK =========
window.takePhoto = takePhoto;
window.startCamera = startCamera;
window.capturePhoto = capturePhoto;
window.retakePhoto = retakePhoto;
window.savePhoto = savePhoto;
window.closeCamera = closeCamera;
window.stopCamera = stopCamera;
window.uploadPhotoFallback = uploadPhotoFallback;
window.generateQRCode = generateQRCode;
window.openQRScanner = openQRScanner;
window.stopQRScanner = stopQRScanner;
window.simulateQRScan = simulateQRScan;
window.openDetailFromScan = openDetailFromScan;
window.printQRCode = printQRCode;
window.addImageInline = addImageInline;
window.navDetail = navDetail;
window.secureEdit = secureEdit;
window.secureDelete = secureDelete;
window.openAsmPicker = openAsmPicker;
window.openAsmDetail = openAsmDetail;
window.openSellPicker = openSellPicker;
window.openSellDetail = openSellDetail;
window.stepLocal = stepLocal;
window.clampToStock = clampToStock;
window.setRoute = setRoute;
window.showModal = showModal;
window.closeModal = closeModal;
window.askPass = askPass;
window.submitPass = submitPass;
window.closePass = closePass;
window.togglePasswordVisibility = togglePasswordVisibility;
window.toggleLoginPassword = toggleLoginPassword;
window.closeLogin = closeLogin;
window.doLogin = doLogin;
window.logout = logout;
window.showSuccess = showSuccess;
window.toast = toast;
window.uid = uid;
window.ddmmyy = ddmmyy;
window.isoFromDDMMYY = isoFromDDMMYY;
window.genCode = genCode;
window.min1 = min1;
window.stepNum = stepNum;
window.setToday = setToday;
window.chips = chips;
window.esc = esc;
window.openNAModal = openNAModal;
window.guardAllLocToQty = guardAllLocToQty;
window.guardLocRow = guardLocRow;
window.totalQtyInput = totalQtyInput;
window.collectColors = collectColors;
window.collectLocs = collectLocs;
window.listMissingAddItem = listMissingAddItem;
window.bindBtnSaveOnce = bindBtnSaveOnce;
window.finalizeAdd = finalizeAdd;
window.afterEdit = afterEdit;
window.drawMasterEdit = drawMasterEdit;
window.mAdd = mAdd;
window.mDel = mDel;
window.generateReport = generateReport;
window.renderHistory = renderHistory;
window.undoHistory = undoHistory;
window.downloadCSV = downloadCSV;
window.escCSV = escCSV;
window.splitCSV = splitCSV;
window.parsePairs = parsePairs;
window.init = initAuth;
window.initAuth = initAuth;
window.applyUserPermissions = applyUserPermissions;
window.showUserInfo = showUserInfo;
window.checkStockNotifications = checkStockNotifications;
window.showNotifications = showNotifications;
window.closeNotifications = closeNotifications;
window.initRealTimeFeatures = initRealTimeFeatures;
window.toggleAutoRefresh = toggleAutoRefresh;
window.autoBackup = autoBackup;
window.cleanupOldBackups = cleanupOldBackups;
window.restoreFromAutoBackup = restoreFromAutoBackup;
window.showCustomReportBuilder = showCustomReportBuilder;
window.updateSelectedColumns = updateSelectedColumns;
window.addFilter = addFilter;
window.renderActiveFilters = renderActiveFilters;
window.removeFilter = removeFilter;
window.generateCustomReport = generateCustomReport;
window.backupData = backupData;
window.restoreData = restoreData;
window.resetData = resetData;
window.validateDateSequence = validateDateSequence;
window.refreshData = refreshData;
window.changeItemsPerPage = changeItemsPerPage;
window.goToPage = goToPage;
</script>
</body>
</html>
